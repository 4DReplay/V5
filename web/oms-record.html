<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />  
  <meta http-equiv="Cache-Control" content="no-store" />
  <!-- common title/style -->
  <script src="/web/oms-common.js"></script>
  <script>
    OMS.initAssets();             // common CSS/JS auto loading
    OMS.applyPageConfig("Record");
    OMS.initActions();            // oms-actions.js auto loading
  </script>
</head>

<body>
  <!-- Title -->
  <h2 class="page-title">
    <span id="pageTitle"></span>
    <small id="recordInfo" class="muted" style="font-size:13px;"></small>
  </h2>

  <!-- Common Title -->
  <script>
    (function () {
      function applyCommonConfig(cfg) {
        if (!cfg || typeof cfg !== "object") return;

        // common title
        var appName = cfg.appName || "4DReplay";
        var version = cfg.version || "V5";
        var pageCfg = (cfg.pages && cfg.pages.omsDashboard) || {};

        // 1) HTML <title>
        if (pageCfg.htmlTitle) {
          document.title = pageCfg.htmlTitle;
        } else {
          document.title = appName + " " + version + " - Dashboard";
        }

        // 2) 화면 내 H1 타이틀 + favicon 이미지 prepend
        var h1 = document.getElementById("pageTitle");
        if (h1 && pageCfg.pageTitle) {

          // 기존 텍스트 유지
          h1.textContent = pageCfg.pageTitle;

          // 아이콘이 이미 붙어 있으면 중복 삽입 금지
          if (!h1.querySelector(".title-icon") && cfg.faviconHref) {
            var img = document.createElement("img");
            img.src = cfg.faviconHref;
            img.className = "title-icon";

            // 텍스트 크기에 자동 맞춤
            img.style.height = "1em";       // 텍스트 높이와 동일
            img.style.width = "auto";       // 비율 유지
            img.style.verticalAlign = "-0.15em"; // 텍스트 baseline에 맞추기
            img.style.marginRight = "8px";

            h1.prepend(img);
          }
        }

        // 3) favicon link 교체 (브라우저 탭 아이콘)
        if (cfg.faviconHref) {
          var existing = document.querySelector('link[rel="icon"]');
          if (!existing) {
            existing = document.createElement("link");
            existing.rel = "icon";
            existing.type = "image/x-icon";
            document.head.appendChild(existing);
          }
          existing.href = cfg.faviconHref;

          // 만약 Title에 이미 아이콘이 있었으면 src도 업데이트
          var titleIcon = document.querySelector("#pageTitle .title-icon");
          if (titleIcon) {
            titleIcon.src = cfg.faviconHref;
          }
        }
      }
      function init() {
        // 이미 로딩돼 있으면 즉시 한 번 적용
        if (window.OmsCommonConfig) {
          applyCommonConfig(window.OmsCommonConfig);
        }
        // 4d-common-style.js에서 oms:config-ready 이벤트 쏘니까 그것도 구독
        try {
          window.addEventListener("oms:config-ready", function (e) {
            applyCommonConfig(e.detail || window.OmsCommonConfig || {});
          });
        } catch (e) { /* 이벤트 미지원 브라우저면 무시 */ }
      }
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    })();
  </script>

  <!-- Toolbar -->
  <div class="toolbar" style="justify-content:flex-start">
    <button id="btnDashboard">📊 Dashboard</button>
    <button id="btnCamera">📸 Camera</button>
    <span class="divider"></span>
    <!-- Record Toggle button -->
    <button id="btnRecordToggle" class="btn-secondary">🟢 Record Start</button>
    <span class="divider"></span>
    <button id="btnConfig" class="btn-secondary">⚙ User Config</button>
    <span class="spacer"></span>
  </div>

  <!-- Record Chip Row (same as Camera UI) -->
  <div id="camChipRow" style="
       margin-top:8px;
       display:flex;
       gap:10px;
       align-items:center;
       ">  
      <span id="recStateChip" class="chip"></span>
      <span id="recMessageChip" class="chip"></span>
  </div>
  
  <!-- Target Selector -->
  <div class="panel" style="margin-top:16px;">
    <h3 style="margin:0 0 10px;">Production Target</h3>
    <!-- Group Selector -->
    <select id="prodGroupSelect" style="margin-bottom:6px;"></select>
    <!-- Item Selector -->
    <select id="prodItemSelect"></select>
  </div>

  <!-- Making Toggle button -->
  <div class="toolbar" style="justify-content:flex-start">
    <button id="btnMakingToggle" class="btn-secondary" style="display:none;">⏺ Making Start</button>
  </div>


  <!-- Produced Videos Sources -->
  <!--
  <div class="panel" style="margin-top:16px; position:relative;">
    <h3 style="margin:0 0 10px;">
      Produced Video
      <span style="float:right; display:flex; gap:10px; align-items:center;">
        <select id="historyPrefixFilter"></select>
        <input type="date" id="historyDatePicker">
      </span>
    </h3>

    <table id="recordTable">
      <thead>
        <tr>
          <th data-sort="idx">Index</th>
          <th data-sort="date">Date</th>
          <th data-sort="target">Target</th>
          <th data-sort="start">Start</th>
          <th data-sort="during">During</th>
          <th data-sort="file">File</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  -->

  <!-- Original Video Sources -->
  <div class="panel" style="margin-top:16px; position:relative;">
    <h3 style="margin:0 0 10px;">
      Original Footage
      <span style="float:right; display:flex; gap:10px; align-items:center;">
        <select id="historyTargetFilter"></select>
        <input type="date" id="historyDatePicker">
      </span>
    </h3>

    <!--
    <table id="recordTable">
      <thead>
        <tr>
          <th data-sort="idx">Index</th>
          <th data-sort="date">Date</th>
          <th data-sort="target">Target</th>
          <th data-sort="start">Start</th>
          <th data-sort="end">End</th>
          <th data-sort="during">During</th>
          <th data-sort="file">File</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    -->
    <table id="recordTable">
      <thead>
        <tr>
          <th data-sort="idx">Index</th>
          <th data-sort="target">Target</th>
          <th data-sort="start">Start</th>
          <th data-sort="during">During</th>
          <th data-sort="file">File</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>    
  </div>

  <!-- Page Logic -->
  <script>
    // button bindings
    document.addEventListener("DOMContentLoaded", () => {
    // -------------------------------------------------------
    // 🔥 prevState MUST be here (global inside DOMContentLoaded)
    // -------------------------------------------------------
    let prevState = null;
    let sortColumn = "date";
    let sortDir = "desc";

    const m = location.pathname.match(/^\/proxy\/([^/]+)\//);
    const PROXY_PREFIX = m ? "/proxy/" + encodeURIComponent(m[1]) : "";

    // -------------------------------
    // 2) Record 상태 UI (Camera state)
    // -------------------------------

    const recStateChip = document.getElementById("recStateChip");
    const recMsgChip   = document.getElementById("recMessageChip");

    async function refreshRecordState() {
      try {
        const r = await fetch("/oms/camera/state", { cache: "no-store" });
        const cam = await r.json();

        applyStateAndMessage({
          state: cam.state,
          message: cam.message,
          stateEl: recStateChip,
          messageEl: recMsgChip
        });

        updateRecordButtons(cam.state);

        // -----------------------------------------------------------
        // 🔥 STATE CHANGE DETECTION — works because prevState exists
        // -----------------------------------------------------------
        if (prevState !== null) {
          // 녹화 시작: Ready(6) → Recording(7/8)
          if (prevState === 6 && (cam.state === 7 || cam.state === 8)) {
              console.log("Recording started → Reload table");
              load_record_table();
          }
          // 녹화 종료: Recording(7/8) → Ready(6)
          if ((prevState === 7 || prevState === 8) && cam.state === 6) {
              console.log("Recording finished → Reload table");
              load_record_table();
          }
        }

        // update prevState at end
        prevState = cam.state;

      } catch (err) {
        console.warn("record state load error", err);
      }
    }

    // refresh loop
    refreshRecordState();
    setInterval(refreshRecordState, 1500);

    // -----------------------------------------
    // Record / Making 버튼 표시 규칙
    // -----------------------------------------
    function updateRecordButtons(state) {
      const btnRecord = document.getElementById("btnRecordToggle");
      const btnMaking = document.getElementById("btnMakingToggle");

      if (!btnRecord || !btnMaking) return;

      // 기본적으로 숨김
      btnRecord.style.display = "none";
      btnMaking.style.display = "none";

      // Ready → Record Start
      if (state === 6) {
        btnRecord.style.display = "inline-block";
        btnRecord.textContent = "🟢 Record Start";
        return;
      }

      // Full Recording → Record Stop + Making Start
      if (state === 7) {
        btnRecord.style.display = "inline-block";
        btnRecord.textContent = "🟥 Record Stop";

        btnMaking.style.display = "inline-block";
        btnMaking.textContent = "▶️ Making Start";
        return;
      }

      // Partial Recording → Record Stop
      if (state === 8) {
        btnRecord.style.display = "inline-block";
        btnRecord.textContent = "🟥 Record Stop";
        return;
      }

      // 나머지는 버튼 없음
    }
    function parseRecordName(name) {
        const p = name.split("_");
        return new Date(`${p[0]}-${p[1]}-${p[2]} ${p[3]}:${p[4]}:${p[5]}`);
    }

    // -------------------------------
    // 3) Dashboard / Config 버튼
    // -------------------------------
    const btnDashboard = document.getElementById("btnDashboard");
    if (btnDashboard) {
      btnDashboard.onclick = () =>
        (window.location.href = PROXY_PREFIX + "/dashboard");
    }
    const btnCamera = document.getElementById("btnCamera");
    if (btnCamera) {
      btnCamera.onclick = () =>
        (window.location.href = PROXY_PREFIX + "/camera");
    }

    const btnConfig = document.getElementById("btnConfig");
    if (btnConfig) {
      btnConfig.onclick = () =>
        (window.location.href = PROXY_PREFIX + "/user");
    }

    // -------------------------------
    // 4) Procution Target Loader
    // -------------------------------
    function load_production_target() {
      fetch("/web/config/user-config.json?ts=" + Date.now(), { cache: "no-store" })
        .then(r => r.json())
        .then(cfg => {

          const pt = cfg["production-target"];
          const groups = pt.groups || [];
          const selGroup = pt["select-group"] ?? 0;
          const selItem = pt["select-item"] ?? 0;

          const groupSel = document.getElementById("prodGroupSelect");
          const itemSel  = document.getElementById("prodItemSelect");
          // 전역 저장
          window.loadedProductionTarget = pt;

          // GROUP SELECT
          groupSel.innerHTML = "";
          groups.forEach((g, idx) => {
            const opt = document.createElement("option");
            opt.value = idx;
            opt.textContent = g["group-name"];
            if (idx === selGroup) opt.selected = true;
            groupSel.appendChild(opt);
          });

          // ITEM SELECT
          function rebuildItemSelect() {
            const groupIdx = groupSel.selectedIndex;
            const list = groups[groupIdx].list;

            itemSel.innerHTML = "";
            list.forEach((it, idx) => {
              const opt = document.createElement("option");
              opt.value = idx;
              opt.textContent = `${it.name} (${it.comment})`;
              if (idx === selItem) opt.selected = true;
              itemSel.appendChild(opt);
            });
          }

          rebuildItemSelect();

          // 이벤트 바인딩
          groupSel.onchange = () => {
            save_production_target(groupSel.selectedIndex, 0);
            rebuildItemSelect();
          };

          itemSel.onchange = () => {
            save_production_target(groupSel.selectedIndex, itemSel.selectedIndex);
          };
        });
    }
    window.addEventListener("oms:config-ready", load_production_target);

    function save_production_target(groupIdx, itemIdx) {
      const payload = {
        "production-target": {
          "select-group": Number(groupIdx),
          "select-item": Number(itemIdx)
        }
      };

      fetch("/oms/config/update", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
        .then(r => r.json())
        .then(res => console.log("production-target updated:", payload, res))
        .catch(err => console.error("production-target update error:", err));
    }

    function build_target_filter(items) {
      const sel = document.getElementById("historyTargetFilter");
      const prevValue = sel.value;   // ← 현재 선택 상태 저장
      sel.innerHTML = "";

      const prefixes = [...new Set(items.map(x => x.production).filter(x => x))];

      const optAll = document.createElement("option");
      optAll.value = "";
      optAll.textContent = "ALL";
      sel.appendChild(optAll);

      prefixes.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        sel.appendChild(opt);
      });

      // 이전 선택 복원
      if (prefixes.includes(prevValue) || prevValue === "") {
        sel.value = prevValue;
      }

      sel.onchange = () => load_record_table();
    }

    // -------------------------------
    // 5) Record History (샘플)
    // -------------------------------
    function load_record_table() {
      fetch("/web/record/record_history.json?ts=" + Date.now())
        .then(r => r.json())
        .then(json => {
          const tbody = document.querySelector("#recordTable tbody");
          tbody.innerHTML = "";

          if (!json || !json.history) return;

          // -----------------------------------------
          // 1) Build array
          // -----------------------------------------
          let items = json.history.map(h => {
            const key = Object.keys(h)[0];
            const data = h[key];

            return {
              key,
              // production-target 파싱
              production: (() => {
                const pt = data["production-target"];
                if (!pt) return "";
                if (typeof pt === "string") return pt;          // "23XI Racing - Team_35"
                if (typeof pt === "object") return pt.name || ""; // {name:"23XI Racing - Team_35"}
                return "";
              })(),
              start: data["record-start-time"] || "",
              end: data["record-end-time"] || "",
              during: data["recording-time"] || "",
              duringMs: data["recording-time-ms"] || 0,
              file: data["file-location"] || ""
            };
          });

          // -----------------------------------------
          // 2-A) Build target filter selectbox
          // -----------------------------------------
          build_target_filter(items);
    
          // -----------------------------------------
          // 2-C) Target filter
          // -----------------------------------------
          const pfilter = document.getElementById("historyTargetFilter").value;
          if (pfilter) {
            items = items.filter(it => it.production  === pfilter);
          }

          // -----------------------------------------
          // 2-B) Date filter
          // -----------------------------------------
          const datePick = document.getElementById("historyDatePicker").value;
          if (datePick) {
            items = items.filter(it => it.start.startsWith(datePick));
          }

          // -----------------------------------------
          // 3) Sorting
          // -----------------------------------------
          items.sort((a, b) => {
            const mul = sortDir === "asc" ? 1 : -1;

            if (sortColumn === "date") {
              return mul * (parseRecordName(a.key) - parseRecordName(b.key));
            }
            if (sortColumn === "start") {
              return mul * (new Date(a.start) - new Date(b.start));
            }
            if (sortColumn === "end") {
              return mul * (new Date(a.end) - new Date(b.end));
            }
            if (sortColumn === "during") {
              return mul * (a.duringMs - b.duringMs);
            }
            return 0;
          });

          // -----------------------------------------
          // 4) Render
          // -----------------------------------------
          /*
          items.forEach((r, idx) => {
            const tr = document.createElement("tr");            
            tr.innerHTML = `
              <td>${idx + 1}</td>
              <td>${r.key}</td>
              <td>${r.production}</td>
              <td>${r.start}</td>
              <td>${r.end}</td>
              <td>${r.during}</td>
              <td><a class="file-link" href="${r.file}">${r.file}</a></td>
            `;
            tbody.appendChild(tr);
          */
          items.forEach((r, idx) => {
            const tr = document.createElement("tr");            
            tr.innerHTML = `
              <td>${idx + 1}</td>
              <td>${r.production}</td>
              <td>${r.start}</td>
              <td>${r.during}</td>
              <td><a class="file-link" href="${r.file}">${r.file}</a></td>
            `;
            tbody.appendChild(tr);            
          });
        })
        .catch(err => console.error("record table load error:", err));
    }
   
    // -------------------------------
    // 6) Record/Making 버튼
    // -------------------------------
    const makingBtn = document.getElementById("btnMakingToggle");

    document.getElementById("historyDatePicker").addEventListener("change", () => {
      load_record_table();
    });
    const ps = document.getElementById("targetSelect");
    if (ps) {
      ps.addEventListener("change", (e) => {
        save_selected_target(e.target.selectedIndex);
      });
    }
    document.getElementById("historyTargetFilter").onchange = () => {
      load_record_table();
    };
    // 🔥 버튼 클릭 동작만 유지하고 상태값은 서버 state 기반으로만 제어
    document.getElementById("btnRecordToggle").onclick = () => {
      const text = document.getElementById("btnRecordToggle").textContent.trim();

      // Record Stop
      if (text.includes("Record Stop")) {
        fetch("/oms/camera/action/record/stop", {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });
        return;
      }

      if (text.includes("Record Start")) {
        const gSel = document.getElementById("prodGroupSelect").selectedIndex;
        const iSel = document.getElementById("prodItemSelect").selectedIndex;

        const pt = window.loadedProductionTarget;
        const prodName = getSelectedTarget(pt.groups, gSel, iSel);

        fetch("/oms/camera/action/record/start", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            "production-target": {
              "name": prodName
            }
          })
        });
        return;
      }
    };

    function getSelectedTarget(groups, gIdx, iIdx) {
      const group = groups[gIdx];
      const item = group.list[iIdx];
      return `${group["group-name"]} - ${item.name}`;
    }

    document.getElementById("btnMakingToggle").onclick = () => {
      console.log("Making toggle clicked");
    };

    // 7) Initial load
    load_production_target();
    load_record_table();
  });
  </script>

</body>
</html>
