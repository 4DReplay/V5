<!--
  record state
  window.UI_STATE_TITLE = {
    0 : "Unknown",          # unknown                       | 🟠"chip-orange",
    // SYSTEM
    10: "Check System",     # system/check                  | 🟠"chip-orange",
    11: "Need Restart",     # not on everything             | 🔵"chip-blue",
    12: "Restarting",       # on restarting system          | 🔵"chip-blue",
    13: "Need Connect",     # on everything + not connect   | 🟡"chip-yellow",
    14: "Connecting...",    # on connecting system          | 🟡"chip-yellow",
    15: "Ready",            # ready (on+connected)          | 🟢"chip-green",
    // CAMERA
    20: "Check Camera",     # camera/check                  | 🟠"chip-orange",
    21: "Need Restart",     # not on everything             | 🔵"chip-blue",
    22: "Restarting",       # on restarting camera          | 🔵"chip-blue",
    23: "Need Connect",     # on everything + not connect   | 🟡"chip-yellow",   
    24: "Connecting...",    # on connecting camera          | 🟡"chip-yellow",   
    25: "Ready",            # ready (on+connected)          | 🟢"chip-green",  = 31
    26: "Recording",        # on recording                  | 🟢"chip-green",  = 33
    27: "Recording Error",  # on recording                  | 🟠"chip-orange",  
    // PRODUCTION
    30: "Check Camera",     # recording/check               | 🟠"chip-orange",
    31: "Need Recording",   # not on everything             | 🟡"chip-yellow",   = 25
    32: "Preparing...",     # on recording camera           | 🟡"chip-yellow",    
    33: "Product Ready",    # on everything + not connect   | 🟢"chip-green",  = 26
    34: "Producing...",     # on connecting camera          | 🔴"chip-red",
    35: "Creating...",      # waiting until finish jon      | 🔴"chip-red",
  };
-->


<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />  
  <meta http-equiv="Cache-Control" content="no-store" />
  <!-- common title/style -->
  <script src="/web/oms-common.js"></script>
  <script>
    OMS.initAssets();             // common CSS/JS auto loading
    OMS.applyPageConfig("Record");
    OMS.initActions();            // oms-actions.js auto loading
  </script>
</head>

<body>
  <!-- Title -->
  <h2 class="page-title">
    <span id="pageTitle"></span>
    <small id="recordInfo" class="muted" style="font-size:13px;"></small>
  </h2>

  <!-- Common Title -->
  <script>
    (function () {
      function applyCommonConfig(cfg) {
        if (!cfg || typeof cfg !== "object") return;

        // common title
        var appName = cfg.appName || "4DReplay";
        var version = cfg.version || "V5";
        var pageCfg = (cfg.pages && cfg.pages.omsDashboard) || {};

        // 1) HTML <title>
        if (pageCfg.htmlTitle) {
          document.title = pageCfg.htmlTitle;
        } else {
          document.title = appName + " " + version + " - Dashboard";
        }

        // 2) 화면 내 H1 타이틀 + favicon 이미지 prepend
        var h1 = document.getElementById("pageTitle");
        if (h1 && pageCfg.pageTitle) {

          // 기존 텍스트 유지
          h1.textContent = pageCfg.pageTitle;

          // 아이콘이 이미 붙어 있으면 중복 삽입 금지
          if (!h1.querySelector(".title-icon") && cfg.faviconHref) {
            var img = document.createElement("img");
            img.src = cfg.faviconHref;
            img.className = "title-icon";

            // 텍스트 크기에 자동 맞춤
            img.style.height = "1em";       // 텍스트 높이와 동일
            img.style.width = "auto";       // 비율 유지
            img.style.verticalAlign = "-0.15em"; // 텍스트 baseline에 맞추기
            img.style.marginRight = "8px";

            h1.prepend(img);
          }
        }

        // 3) favicon link 교체 (브라우저 탭 아이콘)
        if (cfg.faviconHref) {
          var existing = document.querySelector('link[rel="icon"]');
          if (!existing) {
            existing = document.createElement("link");
            existing.rel = "icon";
            existing.type = "image/x-icon";
            document.head.appendChild(existing);
          }
          existing.href = cfg.faviconHref;

          // 만약 Title에 이미 아이콘이 있었으면 src도 업데이트
          var titleIcon = document.querySelector("#pageTitle .title-icon");
          if (titleIcon) {
            titleIcon.src = cfg.faviconHref;
          }
        }
      }
      function init() {
        // 이미 로딩돼 있으면 즉시 한 번 적용
        if (window.OmsCommonConfig) {
          applyCommonConfig(window.OmsCommonConfig);
        }
        // 4d-common-style.js에서 oms:config-ready 이벤트 쏘니까 그것도 구독
        try {
          window.addEventListener("oms:config-ready", function (e) {
            applyCommonConfig(e.detail || window.OmsCommonConfig || {});
          });
        } catch (e) { /* 이벤트 미지원 브라우저면 무시 */ }
      }
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    })();
  </script>

  <!-- Toolbar -->
  <div class="toolbar" style="justify-content:flex-start">
    <button id="btnDashboard">📊 Dashboard</button>
    <button id="btnCamera">📸 Camera</button>
    <span class="divider"></span>
    <!-- Record Toggle button -->
    <button id="btnRecordToggle" class="btn-secondary">🟢 Record Start</button>
    <span class="divider"></span>
    <button id="btnConfig" class="btn-secondary">⚙ User Config</button>
    <span class="spacer"></span>
  </div>

  <!-- Record Chip Row (same as Camera UI) -->
  <div id="camChipRow" style="
       margin-top:8px;
       display:flex;
       gap:10px;
       align-items:center;
       ">  
      <span id="recStateChip" class="chip"></span>
      <span id="recMessageChip" class="chip"></span>
  </div>
  
  <!-- Target Selector -->
  <div class="panel" style="margin-top:16px;">
    <h3 style="margin:0 0 10px;">🎯 Production Target</h3>
    <!-- Group Selector -->
    <select id="prodGroupSelect" style="margin-bottom:6px;"></select>
    <!-- Item Selector -->
    <select id="prodItemSelect"></select>
  </div>

  <!-- Production Toggle button -->
  <div class="toolbar" style="justify-content:flex-start">
    <button id="btnProductionToggle" class="btn-secondary" style="display:none;">⏺ Production Start</button>
  </div>


  <!-- Produced Videos Sources -->
  <div class="panel" style="margin-top:16px; position:relative;">
    <h3 style="margin:0 0 10px;">
      🎬 Produced List
      <span style="float:right; display:flex; gap:10px; align-items:center;">
        <select id="prodTargetFilter"></select>
        <input type="date" id="prodDatePicker">
      </span>
    </h3>
    <table id="TableProduced">
      <thead>
        <tr>
          <th data-sort="idx">Index</th>
          <th data-sort="target">Target</th>
          <th data-sort="start">Start</th>
          <th data-sort="during">During</th>
          <th data-sort="folder">Folder</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>    
  </div>

  <!-- Original Video Sources -->
  <div class="panel" style="margin-top:16px; position:relative;">
    <h3 style="margin:0 0 10px;">
      🗂️ Original Footage
      <span style="float:right; display:flex; gap:10px; align-items:center;">
        <select id="recordTargetFilter"></select>
        <input type="date" id="recordDatePicker">
      </span>
    </h3>

    <table id="TableRecord">
      <thead>
        <tr>
          <th data-sort="idx">Index</th>
          <th data-sort="start">Start</th>
          <th data-sort="during">During</th>
          <th data-sort="file">File</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>    
  </div>

  <!-- Page Logic -->
  <script>
    // button bindings
    document.addEventListener("DOMContentLoaded", () => {
    // ────────────────────────────────────────────
    // 🔥 prevState MUST be here (global inside DOMContentLoaded)
    // ────────────────────────────────────────────
    let prevState = null;
    let sortColumn = "date";
    let sortDir = "desc";

    const m = location.pathname.match(/^\/proxy\/([^/]+)\//);
    const PROXY_PREFIX = m ? "/proxy/" + encodeURIComponent(m[1]) : "";

    // ────────────────────────────────────────────
    // Record 상태 UI (Camera state)
    // ────────────────────────────────────────────

    const recStateChip = document.getElementById("recStateChip");
    const recMsgChip   = document.getElementById("recMessageChip");
    async function refreshRecordState() {
      try {
        const cam_record_state = await fetch("oms/record/state", { cache: "no-store" });
        const cam_record = await cam_record_state.json();        
        console.log(cam_record.message)
        
        applyStateAndMessage({
          state: cam_record.state,
          message: cam_record.message,
          stateEl: recStateChip,
          messageEl: recMsgChip
        });

        // Record / Prudution 버튼 표시
        updateRecordButtons(cam_record.state);

        // -----------------------------------------------------------
        // 🔥 STATE CHANGE DETECTION — works because prevState exists
        /*
        30: "Check Camera",     // recording/check               | 🟠"chip-orange",
        31: "Need Recording",   // not on everything             | 🟡"chip-yellow",   = 25
        32: "Preparing...",     // on recording camera           | 🟡"chip-yellow",     
        33: "Product Ready",    // on everything + not connect   | 🟢"chip-green",  = 26
        34: "Producing...",     // on connecting camera          | 🔴"chip-red", Text Aninmation
        35: "Creating...",      // waiting until finish jon      | 🔴"chip-red",
        */
        // -----------------------------------------------------------
        if (prevState === null) {
            prevState = cam_record.state;   // 초기화
            return;                         // 첫 루프는 비교 패스
        }

        // RECORDING STARTED (from Ready/Record Need)
        if (
          (prevState === 31 || prevState === 32) &&   // from Ready/Record Need
          cam_record.state === 33                     // to Recording...
        )     
        {
          console.log("Recording started → Reload table");          
          load_record_table();
          // refresh delay retries
          setTimeout(load_record_table, 500);
          setTimeout(load_record_table, 1500);
          setTimeout(load_record_table, 3000);
        }

        // RECORDING STOPPED (from Recording/Error)
        if (
          prevState === 33 &&     // from Recording/Error
          cam_record.state === 31 // to Ready/Record Need
        )                
        {
          console.log("Recording started → Reload table");
          load_record_table();
          // refresh delay retries
          setTimeout(load_record_table, 500);
          setTimeout(load_record_table, 1500);
        }

        // MAKING STARTED (from Ready/Record Need)
        if (
          (prevState === 33) &&   // from Ready/Record Need
          cam_record.state === 34                     // to Recording...
        )     
        {
          console.log("Recording started → Reload table");
          load_produced_table();
          // refresh delay retries
          setTimeout(load_produced_table, 500);
          setTimeout(load_produced_table, 1500);
          setTimeout(load_produced_table, 3000);
        }

        // MAKING STOP (from Ready/Record Need)
        if (
          (prevState === 34 || prevState === 35) &&   // from Ready/Record Need
          cam_record.state === 33                     // to Recording...
        )     
        {
          console.log("Recording started → Reload table");
          load_produced_table();
          // refresh delay retries
          setTimeout(load_produced_table, 500);
          setTimeout(load_produced_table, 1500);
          setTimeout(load_produced_table, 3000);
        }
 
        prevState = cam_record.state;
      } catch (err) {
        console.warn("record state load error", err);
      }
    }

    // refresh loop
    refreshRecordState();
    setInterval(refreshRecordState, 1500);

    // ────────────────────────────────────────────
    // Record / Production Toggle Button Update
    // ────────────────────────────────────────────
    function updateRecordButtons(state) {
      const btnRecord = document.getElementById("btnRecordToggle");
      const btnProduction = document.getElementById("btnProductionToggle");
      if (!btnRecord || !btnProduction) return;
      // basically hide both
      btnRecord.style.display = "none";
      btnProduction.style.display = "none";

      // -----------------------------------------------------------
      // 🔥 STATE CHANGE DETECTION — works because prevState exists
      /*
      30: "Check Camera",     // recording/check               | 🟠"chip-orange",
      31: "Need Recording",   // not on everything             | 🟡"chip-yellow",   = 25
      32: "Preparing...",     // on recording camera           | 🟡"chip-yellow",     
      33: "Product Ready",    // on everything + not connect   | 🟢"chip-green",  = 26
      34: "Producing...",     // on connecting camera          | 🔴"chip-red", Text Aninmation
      35: "Creating...",      // waiting until finish jon      | 🔴"chip-red",
      */
      // -----------------------------------------------------------

      // Ready → Record Start ()
      // 7 : "Ready",            // ready to go                  | "chip-green",
      if (state === 31 || state === 32 ) {
        btnRecord.style.display = "inline-block";
        btnRecord.textContent = "🟢 Record Start";
        return;
      }

      // Full Recording → Record Stop + Production Ready
      // 8 : "Recording...",     // on recording                 | "chip-green",   
      // 9 : "Recording Error",  // something wrong on recording | "chip-orange",
      if (state === 33 ) {
        btnRecord.style.display = "inline-block";
        btnRecord.textContent = "🟥 Record Stop";
        // display Production button
        btnProduction.style.display = "inline-block";
        btnProduction.textContent = "▶️ Production Ready";
        return;
      }

      // Partial Recording → Record Stop
      if (state === 34) {
        btnRecord.style.display = "inline-block";
        btnRecord.textContent = "🟥 Record Stop";
        // display Production button
        btnProduction.style.display = "inline-block";
        btnProduction.textContent = "🟥 Producing Stop";
        return;
      }

      // on producing → Record Stop + Producing Stop
      if (state === 35) {
        btnRecord.style.display = "inline-block";
        btnRecord.textContent = "🟥 Record Stop";
        // display Production button
        btnProduction.style.display = "inline-block";
        btnProduction.textContent = "🟥 Producing Stop";
        return;
      }
    }

    function parseRecordName(name) {
        const p = name.split("_");
        return new Date(`${p[0]}-${p[1]}-${p[2]} ${p[3]}:${p[4]}:${p[5]}`);
    }

    // ────────────────────────────────────────────
    // Dashboard / Config 버튼
    // ────────────────────────────────────────────
    const btnDashboard = document.getElementById("btnDashboard");
    if (btnDashboard) {
      btnDashboard.onclick = () =>
        (window.location.href = PROXY_PREFIX + "/dashboard");
    }
    const btnCamera = document.getElementById("btnCamera");
    if (btnCamera) {
      btnCamera.onclick = () =>
        (window.location.href = PROXY_PREFIX + "/camera");
    }
    const btnConfig = document.getElementById("btnConfig");
    if (btnConfig) {
      btnConfig.onclick = () =>
        (window.location.href = PROXY_PREFIX + "/user");
    }

    // ────────────────────────────────────────────
    // Procution Target Loader (ComboBox)
    // ────────────────────────────────────────────
    function load_production_target() {
      fetch("/web/config/user-config.json?ts=" + Date.now(), { cache: "no-store" })
        .then(r => r.json())
        .then(cfg => {

          const pt = cfg["production-target"];
          const groups = pt.groups || [];
          const selGroup = pt["select-group"] ?? 0;
          const selItem = pt["select-item"] ?? 0;

          const groupSel = document.getElementById("prodGroupSelect");
          const itemSel  = document.getElementById("prodItemSelect");
          // 전역 저장
          window.loadedProductionTarget = pt;

          // GROUP SELECT
          groupSel.innerHTML = "";
          groups.forEach((g, idx) => {
            const opt = document.createElement("option");
            opt.value = idx;
            opt.textContent = g["group-name"];
            if (idx === selGroup) opt.selected = true;
            groupSel.appendChild(opt);
          });

          // ITEM SELECT
          function rebuildItemSelect() {
            const groupIdx = groupSel.selectedIndex;
            const list = groups[groupIdx].list;

            itemSel.innerHTML = "";
            list.forEach((it, idx) => {
              const opt = document.createElement("option");
              opt.value = idx;
              opt.textContent = `${it.name} (${it.comment})`;
              if (idx === selItem) opt.selected = true;
              itemSel.appendChild(opt);
            });
          }

          rebuildItemSelect();

          // 이벤트 바인딩
          groupSel.onchange = () => {
            save_production_target(groupSel.selectedIndex, 0);
            rebuildItemSelect();
          };

          itemSel.onchange = () => {
            save_production_target(groupSel.selectedIndex, itemSel.selectedIndex);
          };
        });
    }
    window.addEventListener("oms:config-ready", load_production_target);
    function save_production_target(groupIdx, itemIdx) {
      const payload = {
        "production-target": {
          "select-group": Number(groupIdx),
          "select-item": Number(itemIdx)
        }
      };

      fetch("/oms/config/update", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
        .then(r => r.json())
        .then(res => console.log("production-target updated:", payload, res))
        .catch(err => console.error("production-target update error:", err));
    }
    function build_record_target_filter(items) {
      const sel = document.getElementById("recordTargetFilter");
      const prevValue = sel.value;
      sel.innerHTML = "";

      const prefixes = [...new Set(items.map(x => x.production).filter(x => x))];

      const optAll = document.createElement("option");
      optAll.value = "";
      optAll.textContent = "ALL";
      sel.appendChild(optAll);

      prefixes.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        sel.appendChild(opt);
      });

      // restore previous selection
      if (prefixes.includes(prevValue) || prevValue === "") {
        sel.value = prevValue;
      }

      sel.onchange = () => load_record_table();
    }
    function build_produced_target_filter(items) {
      const sel = document.getElementById("prodTargetFilter");
      const prevValue = sel.value;
      sel.innerHTML = "";

      const prefixes = [...new Set(items.map(x => x.production).filter(x => x))];

      const optAll = document.createElement("option");
      optAll.value = "";
      optAll.textContent = "ALL";
      sel.appendChild(optAll);

      prefixes.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        sel.appendChild(opt);
      });

      if (prefixes.includes(prevValue) || prevValue === "") {
        sel.value = prevValue;
      }

      sel.onchange = () => load_produced_table();
    }

    // ────────────────────────────────────────────
    // Product List
    /*
    "2025_11_27_15_38_42": 
    {
      "file-location": "/web/record/history/recorded/2025_11_28_09_45_31.json",
      "production-target": "23XI Racing - Team_23",
      "record-start-time": "2025-11-28 09:45:33",
      "record-end-time": "2025-11-28 09:45:56",
      "recording-time": "00:00:22.825"      
    }
    */
    // ────────────────────────────────────────────
    function load_produced_table() {
      fetch("/web/record/product_history.json?ts=" + Date.now())
        .then(r => r.json())
        .then(json => {
          const tbody = document.querySelector("#TableProduced tbody");
          tbody.innerHTML = "";
          if (!json.history) return;

          let items = json.history.map(h => {
            const key = Object.keys(h)[0];
            const data = h[key];
            const isRecording = !data["product-end-time"];

            return {
              key,
              isRecording,
              production: data["product-target"] || "",
              start: data["product-start-time"] || "",
              end: data["product-end-time"] || "",
              during: data["producing-time"] || (isRecording ? "Producing..." : ""),
              file: data["product-save-path"] || ""
            };
          });

          // ① target filter
          const pfilter = document.getElementById("prodTargetFilter").value;
          if (pfilter) {
            items = items.filter(it => it.production === pfilter);
          }

          // ② date filter
          const datePick = document.getElementById("prodDatePicker").value;
          if (datePick) {
            items = items.filter(it => it.start.startsWith(datePick));
          }

          // ③ sort: producing first, then by date DESC
          items.sort((a, b) => {
            if (a.isRecording && !b.isRecording) return -1;
            if (!a.isRecording && b.isRecording) return 1;
            return new Date(b.start) - new Date(a.start);
          });

          // ④ render
          items.forEach((r, idx) => {
            const tr = document.createElement("tr");
            const duringHtml = r.isRecording
                ? `<span class="recording-highlight">Producing...</span>`
                : r.during;

            if (r.isRecording) tr.classList.add("recording-row");

            tr.innerHTML = `
              <td>${idx + 1}</td>
              <td>${r.production}</td>
              <td>${r.start}</td>
              <td>${duringHtml}</td>
              <td>${r.file}</td>
            `;
            tbody.appendChild(tr);
          });

          // Build Filter Box
          build_produced_target_filter(items);
        });
    }


    // ────────────────────────────────────────────
    // Record History
    /*
    "2025_11_27_15_38_42": 
    {
      "file-location": "/web/record/history/recorded/2025_11_28_09_45_31.json",
      "production-target": "23XI Racing - Team_23",
      "record-start-time": "2025-11-28 09:45:33",
      "record-end-time": "2025-11-28 09:45:56",
      "recording-time": "00:00:22.825"    
    }
    */
    // ────────────────────────────────────────────
    function load_record_table() {
      fetch("/web/record/record_history.json?ts=" + Date.now())
        .then(r => r.json())
        .then(json => {
          const tbody = document.querySelector("#TableRecord tbody");
          tbody.innerHTML = "";
          if (!json.history) return;

          let items = json.history.map(h => {
            const key = Object.keys(h)[0];
            const data = h[key];
            const isRecording = !data["record-end-time"];

            return {
              key,
              isRecording,
              production: data["production-target"] || "",
              start: data["record-start-time"] || "",
              end: data["record-end-time"] || "",
              during: data["recording-time"] || (isRecording ? "Recording..." : ""),
              file: data["file-location"] || ""
            };
          });

          // ① target filter
          const pfilter = document.getElementById("recordTargetFilter").value;
          if (pfilter) {
            items = items.filter(it => it.production === pfilter);
          }

          // ② date filter
          const datePick = document.getElementById("recordDatePicker").value;
          if (datePick) {
            items = items.filter(it => it.start.startsWith(datePick));
          }

          // ③ sort
          items.sort((a, b) => {
            if (a.isRecording && !b.isRecording) return -1;
            if (!a.isRecording && b.isRecording) return 1;
            return new Date(b.start) - new Date(a.start);
          });

          // ④ render
          items.forEach((r, idx) => {
            const tr = document.createElement("tr");
            const duringHtml = r.isRecording
                ? `<span class="recording-highlight">Recording...</span>`
                : r.during;

            if (r.isRecording) tr.classList.add("recording-row");

            tr.innerHTML = `
              <td>${idx + 1}</td>
              <td>${r.start}</td>
              <td>${duringHtml}</td>
              <td>${r.file}</td>
            `;
            tbody.appendChild(tr);
          });

          // build filter
          build_record_target_filter(items);
        });
    }

    // ────────────────────────────────────────────
    // Record Button
    // ────────────────────────────────────────────
    document.getElementById("prodTargetFilter").onchange = load_produced_table;
    document.getElementById("prodDatePicker").onchange = load_produced_table;
    document.getElementById("recordTargetFilter").onchange = load_record_table;
    document.getElementById("recordDatePicker").onchange = load_record_table;

    // ────────────────────────────────────────────
    // 🔥btnRecordToggle (RECORD) click handler
    // ────────────────────────────────────────────
    document.getElementById("btnRecordToggle").onclick = () => {
      const text = document.getElementById("btnRecordToggle").textContent.trim();
      // ────────────────────────────────────────────
      // 🚀 Action Record Start
      // ────────────────────────────────────────────
      if (text.includes("Record Start")) {
        const gSel = document.getElementById("prodGroupSelect").selectedIndex;
        const iSel = document.getElementById("prodItemSelect").selectedIndex;
        const pt = window.loadedProductionTarget;
        const prodName = getSelectedTarget(pt.groups, gSel, iSel);
        fetch("/oms/camera/action/record/start", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            "production-target": {
              "name": prodName
            }
          })
        });
        // 서버가 record_history.json 업데이트하는데 필요한 시간 확보
        setTimeout(load_record_table, 2000);
        return;
      }
      // ────────────────────────────────────────────
      // 🚀 Action Record Stop
      // ────────────────────────────────────────────
      if (text.includes("Record Stop")) {
        fetch("/oms/camera/action/record/stop", {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });
        // 서버가 record_history.json 업데이트하는데 필요한 시간 확보
        setTimeout(load_record_table, 500);
        return;
      }
    };

    function getSelectedTarget(groups, gIdx, iIdx) {
      const group = groups[gIdx];
      const item = group.list[iIdx];
      return `${group["group-name"]} - ${item.name}`;
    }

    // ────────────────────────────────────────────
    // btnProductionToggle (MAKE) click handler
    // ────────────────────────────────────────────    
    document.getElementById("btnProductionToggle").onclick = () => {
      const text = document.getElementById("btnProductionToggle").textContent.trim();

      // ────────────────────────────────────────────
      // 🚀 Action Production Start
      // ────────────────────────────────────────────
      if (text.includes("Production Ready")) {
        fetch("/oms/camera/action/production/start", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({})
        });
        // 서버가 record_history.json 업데이트하는데 필요한 시간 확보
        setTimeout(load_produced_table, 2000);
        return;
      }
      // ────────────────────────────────────────────
      // 🚀 Action Production Stop
      // ────────────────────────────────────────────
      if (text.includes("Producing Stop")) {
        fetch("/oms/camera/action/production/stop", {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });
        // 서버가 record_history.json 업데이트하는데 필요한 시간 확보
        setTimeout(load_produced_table, 2000);
        return;
      }
    };

    // 7) Initial load
    load_production_target();
    load_record_table();
    load_produced_table ();
  });
  </script>

</body>
</html>
