<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />  
  <meta http-equiv="Cache-Control" content="no-store" />
  <!-- common title/style -->
  <script src="/web/oms-common.js"></script>
  <script>
    OMS.initAssets();             // common CSS/JS auto loading
    OMS.applyPageConfig("Record");
    OMS.initActions();            // oms-actions.js auto loading
  </script>
</head>

<body>
  <!-- Title -->
  <h2 class="page-title">
    <span id="pageTitle"></span>
    <small id="recordInfo" class="muted" style="font-size:13px;"></small>
  </h2>

  <!-- Common Title -->
  <script>
    (function () {
      function applyCommonConfig(cfg) {
        if (!cfg || typeof cfg !== "object") return;

        // 공통 prefix (원하면 사용)
        var appName = cfg.appName || "4DReplay";
        var version = cfg.version || "V5";
        var pageCfg = (cfg.pages && cfg.pages.omsDashboard) || {};

        // 1) HTML <title>
        if (pageCfg.htmlTitle) {
          document.title = pageCfg.htmlTitle;
        } else {
          document.title = appName + " " + version + " - Dashboard";
        }

        // 2) 화면 내 H1 타이틀 + favicon 이미지 prepend
        var h1 = document.getElementById("pageTitle");
        if (h1 && pageCfg.pageTitle) {

          // 기존 텍스트 유지
          h1.textContent = pageCfg.pageTitle;

          // 아이콘이 이미 붙어 있으면 중복 삽입 금지
          if (!h1.querySelector(".title-icon") && cfg.faviconHref) {
            var img = document.createElement("img");
            img.src = cfg.faviconHref;
            img.className = "title-icon";

            // 텍스트 크기에 자동 맞춤
            img.style.height = "1em";       // 텍스트 높이와 동일
            img.style.width = "auto";       // 비율 유지
            img.style.verticalAlign = "-0.15em"; // 텍스트 baseline에 맞추기
            img.style.marginRight = "8px";

            h1.prepend(img);
          }
        }

        // 3) favicon link 교체 (브라우저 탭 아이콘)
        if (cfg.faviconHref) {
          var existing = document.querySelector('link[rel="icon"]');
          if (!existing) {
            existing = document.createElement("link");
            existing.rel = "icon";
            existing.type = "image/x-icon";
            document.head.appendChild(existing);
          }
          existing.href = cfg.faviconHref;

          // 만약 Title에 이미 아이콘이 있었으면 src도 업데이트
          var titleIcon = document.querySelector("#pageTitle .title-icon");
          if (titleIcon) {
            titleIcon.src = cfg.faviconHref;
          }
        }
      }
      function init() {
        // 이미 로딩돼 있으면 즉시 한 번 적용
        if (window.OmsCommonConfig) {
          applyCommonConfig(window.OmsCommonConfig);
        }
        // 4d-common-style.js에서 oms:config-ready 이벤트 쏘니까 그것도 구독
        try {
          window.addEventListener("oms:config-ready", function (e) {
            applyCommonConfig(e.detail || window.OmsCommonConfig || {});
          });
        } catch (e) { /* 이벤트 미지원 브라우저면 무시 */ }
      }
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    })();
  </script>

  <!-- Toolbar -->
  <div class="toolbar" style="justify-content:flex-start">
    <button id="btnDashboard">📊 Dashboard</button>
    <span class="divider"></span>
    <!-- Record Toggle button -->
    <button id="btnRecordToggle" class="btn-secondary">⏺ Record Start</button>
    <span class="divider"></span>
    <button id="btnConfig" class="btn-secondary">⚙ Config Editor</button>
    <span class="spacer"></span>
  </div>

  <!-- Status Indicator -->
  <div id="statusIndicator" class="indicator ind-ready">Idle</div>

  <!-- Prefix Selector -->
  <div class="panel" style="margin-top:16px;">
    <h3 style="margin:0 0 10px;">Prefix Selection</h3>
    <select id="prefixSelect"></select>
  </div>

  <!-- Making Toggle button -->
  <div class="toolbar" style="justify-content:flex-start"></div>
    <button id="btnMakingToggle" class="btn-secondary" style="display:none;">⏺ Making Start</button>   
  </div>

  <!-- Recording Table -->
  <div class="panel" style="margin-top:16px;">
    <h3 style="margin:0 0 10px;">Recording History</h3>
    <table id="recordTable">
      <thead>
        <tr>
          <th style="width:60px;">Index</th>
          <th style="width:200px;">Date</th>
          <th style="width:140px;">Start</th>
          <th style="width:140px;">End</th>
          <th style="width:100px;">During</th>
          <th>File</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Common Title System -->
  <script>
    (function () {
      function apply(cfg) {
        if (!cfg) return;
        const app = cfg.appName || "4DReplay";
        const ver = cfg.version || "V5";
        const pageCfg = (cfg.pages && cfg.pages.omsRecord) || {};

        // Title
        document.title = pageCfg.htmlTitle || (app + " " + ver + " - Record");

        // H1 Title
        const h1 = document.getElementById("pageTitle");
        if (h1 && pageCfg.pageTitle) {
          h1.textContent = pageCfg.pageTitle;

          if (cfg.faviconHref && !h1.querySelector(".title-icon")) {
            const img = document.createElement("img");
            img.src = cfg.faviconHref;
            img.className = "title-icon";
            img.style.height = "1em";
            img.style.marginRight = "8px";
            h1.prepend(img);
          }
        }

        // favicon
        if (cfg.faviconHref) {
          let link = document.querySelector('link[rel="icon"]');
          if (!link) {
            link = document.createElement("link");
            link.rel = "icon";
            link.type = "image/x-icon";
            document.head.appendChild(link);
          }
          link.href = cfg.faviconHref;
        }
      }

      function init() {
        if (window.OmsCommonConfig) apply(window.OmsCommonConfig);
        window.addEventListener("oms:config-ready", e =>
          apply(e.detail || window.OmsCommonConfig)
        );
      }

      document.readyState === "loading"
        ? document.addEventListener("DOMContentLoaded", init)
        : init();
    })();
  </script>

  <!-- Page Logic -->
  <script>
    function setIndicator(mode) {
      const el = document.getElementById("statusIndicator");
      el.classList.remove("ind-ready","ind-record","ind-making");

      if (mode === "record") {
        el.classList.add("ind-record");
        el.textContent = "Recording...";
      } else if (mode === "making") {
        el.classList.add("ind-making");
        el.textContent = "Making...";
      } else {
        el.classList.add("ind-ready");
        el.textContent = "Idle";
      }
    }

    function load_prefix() {
      fetch("/web/config/user-config.json?ts=" + Date.now())
        .then(r => r.json())
        .then(cfg => {
          if (!cfg || !cfg.prefix) return;
          
          const sel = document.getElementById("prefixSelect");
          sel.innerHTML = "";

          // prefix 배열 읽어와서 select에 추가
          cfg.prefix.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.name;
            opt.innerText = `${p.name} (${p.comment})`;
            sel.appendChild(opt);
          });
        })
        .catch(err => console.error("prefix load error:", err));
    }

    function load_record_table() {
      const tbody = document.querySelector("#recordTable tbody");
      tbody.innerHTML = "";

      const sample = [
        { idx:1, date:"Sep 1st 2025", start:"21:55:32", end:"21:58:32", during:"03:00",
          file:"/video/Team_A/250901_215532" }
      ];

      sample.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.idx}</td>
          <td>${r.date}</td>
          <td>${r.start}</td>
          <td>${r.end}</td>
          <td>${r.during}</td>
          <td><a class="file-link" href="${r.file}">${r.file}</a></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // button bindings
    document.addEventListener("DOMContentLoaded", () => {
      const m = location.pathname.match(/^\/proxy\/([^/]+)\//);
      const PROXY_PREFIX = m ? "/proxy/" + encodeURIComponent(m[1]) : "";

    document.getElementById("btnDashboard").onclick = () =>
      window.location.href = PROXY_PREFIX + "/dashboard";

    document.getElementById("btnConfig").onclick = () =>
      window.location.href = PROXY_PREFIX + "/user";

    const makingBtn = document.getElementById("btnMakingToggle");
    // Recording Toggle
    let isRecording = false;
    document.getElementById("btnRecordToggle").onclick = () => {
      isRecording = !isRecording;

      const btn = document.getElementById("btnRecordToggle");
      const makingBtn = document.getElementById("btnMakingToggle");

      if (isRecording) {
        btn.textContent = "⏺ Recording...";
        setIndicator("record");
        makingBtn.style.display = "inline-block";   // ON → show
      } else {
        btn.textContent = "▶ Record Start";
        setIndicator("ready");
        makingBtn.style.display = "none";           // OFF → hide
      }
    };
    let isMaking = false;
    // Making Toggle
    document.getElementById("btnMakingToggle").onclick = () => {
      isMaking = !isMaking;
      const btn = document.getElementById("btnMakingToggle");

      if (isMaking) {
        btn.textContent = "⏺ Making...";
        setIndicator("making");
      } else {
        btn.textContent = "▶ Making Start";
        setIndicator("record");
      }
    };

    load_prefix();
    load_record_table();
    });
  </script>

</body>
</html>
