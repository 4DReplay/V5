<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>4DReplay V5 - DMs Config Editor</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root{
      --bg:#0b0f14; --fg:#eef2f7; --muted:#94a3b8;
      --card:#0b1220; --line:#243045; --line2:#1f2937;
      --btn:#1e40af; --btn2:#334155; --ok:#16a34a; --bad:#ef4444;
    }
    html,body{height:100%}
    body{background:var(--bg);color:var(--fg);font:14px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px}
    h2{font-size:28px;margin:0 0 12px;display:flex;align-items:center;gap:10px}
    h2 small{font-size:14px;opacity:.8}
    .toolbar{display:flex;gap:10px;align-items:center;margin:10px 0 14px}
    .toolbar .note{color:var(--muted);font-size:13px}
    button{background:var(--btn);color:#fff;border:0;border-radius:10px;padding:8px 12px;cursor:pointer}
    button:hover{opacity:.93}
    button[disabled]{opacity:.55;cursor:not-allowed}
    .btn-ghost{background:transparent;border:1px solid var(--line);color:#e5e7eb}
    .btn-secondary{background:var(--btn2)}
    .pill{display:inline-block;border:1px solid var(--line);background:#0f172a;border-radius:999px;font-size:12px;padding:2px 10px}
    .pill-ok{border-color:var(--ok);color:#a7f3d0;background:#0d3b1a}
    .pill-bad{border-color:var(--bad);color:#fecaca;background:#3b0d0d}

    table{border-collapse:collapse;width:100%;max-width:1300px}
    th, td {
  border: 1px solid var(--line2);
  padding: 4px 6px;             /* ê¸°ì¡´ 8px â†’ ì¤„ì„ */
  vertical-align: middle;       /* ê°€ìš´ë° ì •ë ¬ */
}
    th{background:#0f172a;text-align:left;position:sticky;top:0}
    tbody tr:nth-child(odd){background:#0c121b}
    input[type="text"], textarea, select {
  width: 100%;
  box-sizing: border-box;
  background: #0b1220;
  color: #e5e7eb;
  border: 1px solid var(--line);
  border-radius: 6px;           /* ì•½ê°„ ì¤„ì„ */
  padding: 4px 6px;             /* ë‚´ë¶€ ì—¬ë°± ì¤„ì„ */
  font: 13px ui-monospace, monospace;
}
    textarea {
  height: 36px;                 /* ê¸°ì¡´ 70px â†’ 36pxìœ¼ë¡œ ì¶•ì†Œ */
  resize: none;                 /* ìœ ë™ í¬ê¸° ì¡°ì ˆ ì œê±° */
}
    .col-narrow{width:90px}
    .col-btns{white-space:nowrap}
    .muted{color:var(--muted)}
    .help{margin-top:10px;color:var(--muted);font-size:13px}
    .sep{height:1px;background:var(--line2);margin:12px 0}
    .right{margin-left:auto}

    /* âœ… ì•„ë˜ ë¶€ë¶„ ìƒˆë¡œ ì¶”ê°€ */
    button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: filter 0.2s ease;
    }
    button:hover {
      filter: brightness(1.15);
    }
  </style>
</head>
<body>
  <h2>
    <span>4DReplay V5 - DMs Config Editor</span>
    <small id="titleHost"></small>
  </h2>

  <div class="toolbar">
    <button id="btnGoDashboard" class="btn-secondary" title="Back to Control">ğŸ§­ Control</button>
    <button id="btnReload" class="btn-secondary">ğŸ”„ Reload</button>
    <button id="btnFormat" class="btn-ghost">ğŸ§¹Format</button>
    <button id="btnAdd" class="btn-ghost">â• Add</button>
    <button id="btnSave">ğŸ’¾ Save</button>
    <span id="saveState" class="pill">Idle</span>
    <span class="right note">File: <span id="metaPath">-</span> (<span id="metaSize">-</span> bytes, mtime <span id="metaMtime">-</span>) â€¢ Agent heartbeat: <span id="hb">-</span>s</span>
  </div>

  <table id="grid">
    <thead>
      <tr>
        <th class="col-narrow">select</th>
        <th>Name</th>
        <th>Alias</th>
        <th>Path</th>
        <th>Args (JSON array / space)</th>
        <th class="col-narrow">auto_restart</th>
        <th class="col-narrow">start_on_boot</th>
        <th class="col-btns">Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="help">
    â€¢ Saving with <code>select:false</code> will make the Agent terminate that process on the next tick.<br/>
    â€¢ <code>heartbeat_interval_sec</code> is the Agentâ€™s internal cycle, and this page automatically reflects meta/heartbeat polling intervals.
  </div>

  <div class="sep"></div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ proxy  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// â‘  /proxy/<node>/ ì ‘ë‘ì‚¬ ê°ì§€
const __PROXY_PREFIX__ = (() => {
  const m = location.pathname.match(/^\/proxy\/([^/]+)\//);
  return m ? `/proxy/${encodeURIComponent(decodeURIComponent(m[1]))}` : "";
})();

// â‘¡ <base> ì£¼ì…: ìƒëŒ€ê²½ë¡œë¥¼ /proxy/<node>/ ê¸°ì¤€ìœ¼ë¡œ í•´ì„
(function ensureBase(){
  if (!__PROXY_PREFIX__) return;
  const base = document.createElement("base");
  base.href = __PROXY_PREFIX__ + "/";
  document.head.prepend(base);
})();

// â‘¢ fetch íŒ¨ì¹˜: "/config" ê°™ì€ ì ˆëŒ€ê²½ë¡œ ì•ì— /proxy/<node> ìë™ ë¶€ì°©
(function patchFetch(){
  if (!__PROXY_PREFIX__) return;
  const orig = window.fetch;
  window.fetch = function(input, init){
    let url = input;
    if (typeof input !== "string" && input && input.url) url = input.url;

    if (typeof url === "string") {
      if (url.startsWith("/") && !url.startsWith("/proxy/")) {
        url = __PROXY_PREFIX__ + url; // í•µì‹¬
      }
    }
    if (typeof input !== "string" && input && input.url) {
      return orig(new Request(url, input), init);
    }
    return orig(url, init);
  };
})();

// (ì˜µì…˜) XHRë¥¼ ì“°ëŠ” ì½”ë“œê°€ ìˆë‹¤ë©´ ê°™ì´ íŒ¨ì¹˜
(function patchXHR(){
  if (!__PROXY_PREFIX__) return;
  const origOpen = XMLHttpRequest.prototype.open;
  XMLHttpRequest.prototype.open = function(method, url, async, user, pass){
    let u = url;
    if (typeof u === "string" && u.startsWith("/") && !u.startsWith("/proxy/")) {
      u = __PROXY_PREFIX__ + u;
    }
    return origOpen.call(this, method, u, async !== false, user, pass);
  };
})();

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ê³µí†µ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(function setTitleHost(){
  try{
    const host=(window.DASHBOARD_HOST&&String(window.DASHBOARD_HOST).trim())||(location&&location.hostname)||"";
    const el=document.getElementById("titleHost"); if(el&&host) el.textContent=`(${host})`;
  }catch(_){}
})();

// ===== ê³µí†µ fetch ë˜í¼ =====
async function api(path, method="GET", body=null){
  const opt = { method, cache:"no-store", headers:{} };
  if (body !== null){
    if (typeof body === "string"){ opt.headers["Content-Type"]="text/plain; charset=utf-8"; opt.body=body; }
    else { opt.headers["Content-Type"]="application/json"; opt.body=JSON.stringify(body); }
  }
  const r = await fetch(path, opt);
  const ct = r.headers.get("content-type") || "";
  const isJson = ct.includes("application/json");
  if (!r.ok){
    let msg = r.statusText;
    try{ msg = isJson ? (await r.json()).error || r.statusText : await r.text(); }catch{}
    throw new Error(msg || `HTTP ${r.status}`);
  }
  return isJson ? await r.json() : await r.text();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ /config ë¡œë“œ/ì €ì¥ (+json5 í—ˆìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadConfigText(){ return api("/config","GET"); }
// ===== /config ìš°ì„ , ì‹¤íŒ¨ ì‹œ /oms/config í´ë°± =====
async function saveConfigText(text){
  try {
    return await api("/config", "POST", text);     // ë£¨íŠ¸ ìš°ì„ 
  } catch (e){
    const m = String(e.message||"").toLowerCase();
    if (m.includes("not found") || m.includes("404")){
      return await api("/oms/config", "POST", text); // í´ë°±
    }
    throw e;
  }
}

// ì„œë²„ê°€ /config-format ë˜ëŠ” /config/format ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ìˆì„ ìˆ˜ ìˆì–´ ë‘˜ ë‹¤ ì‹œë„
async function formatOnServer(text){
  try{ return await api("/config-format","POST",text); }
  catch(_){ return await api("/config/format","POST",text); }
}
async function loadConfigObj(){
  const raw=await loadConfigText();
  // ë¨¼ì € JSONìœ¼ë¡œ ì‹œë„
  try{
    return JSON.parse(raw);
  }catch(_){
    // ì„œë²„ í¬ë§·í„°ë¡œ êµì • í›„ íŒŒì‹±
    const fr=await formatOnServer(raw);
    return JSON.parse(fr.text);
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ í™”ë©´ ìš”ì†Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const TBody   = document.querySelector("#grid tbody");
const SaveTag = document.getElementById("saveState");
const HB_EL   = document.getElementById("hb");
const M_PATH  = document.getElementById("metaPath");
const M_SIZE  = document.getElementById("metaSize");
const M_TIME  = document.getElementById("metaMtime");

let CONFIG=null;
let POLL=null, POLL_MS=1500;
let IS_SAVING=false;

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ í–‰/í•„ë“œ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function parseArgs(val){
  if(!val) return [];
  const s=String(val).trim();
  if(!s) return [];
  try{
    const j=JSON.parse(s);
    return Array.isArray(j)?j:(j?String(j).split(/\s+/):[]);
  }catch(_){
    return s.split(/\s+/);
  }
}
function argsToText(arr){
  if(!arr) return "";
  try{ return JSON.stringify(arr); }catch{ return String(arr); }
}
function ensureConfigShape(cfg){
  cfg = cfg||{};
  if(!Array.isArray(cfg.executables)) cfg.executables=[];
  return cfg;
}
function uniqueName(base){
  const used=new Set((CONFIG.executables||[]).map(e=>e.name));
  if(!used.has(base)) return base;
  let i=2; while(used.has(`${base}_${i}`)) i++;
  return `${base}_${i}`;
}

function row(exe, idx){
  const tr=document.createElement("tr");
  tr.innerHTML = `
    <td><input type="checkbox" data-k="select" ${exe.select===true?"checked":""}></td>
    <td><input type="text" data-k="name" value="${exe.name||""}" placeholder="e.g. MTd"></td>
    <td><input type="text" data-k="alias" value="${exe.alias||""}" placeholder="Message Transport - main"></td>
    <td><input type="text" data-k="path" value="${exe.path||""}" placeholder="daemon/MTd/MTd.exe"></td>
    <td><textarea data-k="args" placeholder='["--foo","bar"] or "--foo bar"'>${argsToText(exe.args||[])}</textarea></td>
    <td style="text-align:center"><input type="checkbox" data-k="auto_restart" ${exe.auto_restart!==false?"checked":""}></td>
    <td style="text-align:center"><input type="checkbox" data-k="start_on_boot" ${exe.start_on_boot? "checked":""}></td>
    <td class="col-btns">
      <button data-a="up"   class="btn-ghost">â–²</button>
      <button data-a="down" class="btn-ghost">â–¼</button>
      <button data-a="dup"  class="btn-ghost">Duplicate</button>
      <button data-a="del"  class="btn-secondary">Delete</button>
    </td>
  `;

  tr.addEventListener("change",(ev)=>{
    const t=ev.target; const k=t.getAttribute("data-k"); if(!k) return;
    const v=(t.type==="checkbox")?t.checked:(k==="args"?parseArgs(t.value):t.value);
    CONFIG.executables[idx][k]=v;
    touchDirty("Edited");
  });

  tr.addEventListener("click",(ev)=>{
    const b=ev.target.closest("button"); if(!b) return;
    const a=b.getAttribute("data-a"); const arr=CONFIG.executables;
    if(a==="up" && idx>0){ [arr[idx-1],arr[idx]]=[arr[idx],arr[idx-1]]; render(); }
    else if(a==="down" && idx<arr.length-1){ [arr[idx+1],arr[idx]]=[arr[idx],arr[idx+1]]; render(); }
    else if(a==="dup"){ const copy=JSON.parse(JSON.stringify(arr[idx])); copy.name=uniqueName(copy.name||"New"); arr.splice(idx+1,0,copy); render(); }
    else if(a==="del"){ if(confirm("Delete this row?")){ arr.splice(idx,1); render(); } }
  });

  return tr;
}

function render(){
  CONFIG = ensureConfigShape(CONFIG);
  TBody.innerHTML="";
  CONFIG.executables.forEach((e,i)=>TBody.appendChild(row(e,i)));
}
function touchDirty(text="Edited"){
  SaveTag.textContent=text; SaveTag.className="pill";
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë©”íƒ€/í•˜íŠ¸ë¹„íŠ¸ í´ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadMeta(){
  try{
    const m=await api("/config/meta","GET");
    M_PATH.textContent=m.path||"-";
    M_SIZE.textContent=String(m.size??"-");
    M_TIME.textContent=m.mtime||"-";
  }catch(_){ M_PATH.textContent="(meta error)"; }
}
async function loadHeartbeat(){
  try{
    const s=await api("/status","GET");
    // /status í˜•ì‹ì´ mapì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ hbëŠ” configì—ì„œ ë³´ì™„
    if(typeof s.heartbeat_interval_sec==="number"){
      const hb=s.heartbeat_interval_sec;
      HB_EL.textContent=hb;
      POLL_MS=Math.max(1000, Math.min(3000, Math.floor(hb*1000)));
    }
  }catch(_){ HB_EL.textContent="-"; }
  if(POLL){clearInterval(POLL); POLL=null;}
  POLL=setInterval(()=>Promise.allSettled([loadMeta(),loadHeartbeat()]), POLL_MS);
}
async function loadHeartbeatLite(){
  try{
    const s = await api("/status-lite", "GET");
    if (s && typeof s.heartbeat_interval_sec !== "undefined"){
      const hb = Number(s.heartbeat_interval_sec);
      if (!isNaN(hb) && hb > 0){
        HB_EL.textContent = hb;
        const next = Math.max(1000, Math.floor(hb*1000));
        if (next !== POLL_MS){ POLL_MS = next; restartPolling(); }
      }
    }
  }catch{ HB_EL.textContent="-"; }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë²„íŠ¼ ì•¡ì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function reloadConfig(){
  const obj=await loadConfigObj();
  CONFIG=ensureConfigShape(obj);
  render();
  SaveTag.textContent="Loaded"; SaveTag.className="pill";
  await Promise.allSettled([loadMeta(), loadHeartbeat()]);
}
async function formatConfig(){
  const txt=JSON.stringify(CONFIG);
  const r=await formatOnServer(txt);
  try{ CONFIG=JSON.parse(r.text); }catch{}
  render();
  SaveTag.textContent="Formatted"; SaveTag.className="pill";
}
async function saveConfig(){
  if (IS_SAVING) return;
  IS_SAVING = true;
  try{
    console.log("[OMS] Save clicked");
    SaveTag.textContent="Saving..."; SaveTag.className="pill";
    const txt = JSON.stringify(CONFIG, null, 2);

    // ì‹¤ì œ ì €ì¥
    const res = await saveConfigText(txt);
    console.log("[OMS] Save response:", res);

    // ì‚¬ìš©ì í”¼ë“œë°±
    SaveTag.textContent = `Saved (${(res && res.bytes) ? res.bytes : txt.length}B)`;
    SaveTag.className="pill pill-ok";

    // ì €ì¥ ë°˜ì˜ ì¬ë¡œë”©
    await reloadConfig();
    await loadMeta();
  }catch(e){
    console.error("[OMS] Save failed:", e);
    alert("Save failed: " + (e.message||e));
    SaveTag.textContent="Save failed"; SaveTag.className="pill pill-bad";
  }finally{
    IS_SAVING = false;
  }
}


// ===== ë²„íŠ¼ ì´ë²¤íŠ¸ê°€ ë°˜ë“œì‹œ í•œ ë²ˆë§Œ ê±¸ë¦¬ë„ë¡ ì •ë¦¬ =====
document.getElementById("btnSave").onclick = null;
document.getElementById("btnSave").addEventListener("click", (ev)=>{
  ev.preventDefault();
  saveConfig();
});

document.getElementById("btnGoDashboard").addEventListener("click", ()=>{
  location.href = "dms-control.html";
});
document.getElementById("btnReload").addEventListener("click", reloadConfig);
document.getElementById("btnFormat").addEventListener("click", formatConfig);
document.getElementById("btnSave").addEventListener("click", saveConfig);
document.getElementById("btnAdd").addEventListener("click", ()=>{
  CONFIG=ensureConfigShape(CONFIG);
  CONFIG.executables.push({
    name: uniqueName("New"),
    alias:"",
    path:"",
    args:[],
    select:false,
    auto_restart:true,
    start_on_boot:false
  });
  render(); touchDirty("Edited");
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(async function init(){
  await reloadConfig();
})();
</script>
</body>
</html>
