<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<title>AId Agent Control</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root { --bg:#0f0f10; --fg:#e8e8ea; --muted:#9aa0a6; --ok:#30c75d; --warn:#ffb020; --err:#ff5e57; --card:#141517; --line:#2a2b2f; }
  * { box-sizing:border-box; }
  body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--fg); background:var(--bg); }
  header { display:flex; gap:8px; align-items:center; padding:10px 14px; background:#111; position:sticky; top:0; z-index:20; border-bottom:1px solid #1b1c1f; }
  .btn { padding:8px 12px; border:1px solid #333; border-radius:10px; background:#1f2227; color:var(--fg); cursor:pointer; }
  .btn:hover { border-color:#444; }
  .btn.ok   { border-color:#1e5; }
  .btn.warn { border-color:#995; }
  .btn.err  { border-color:#833; color:#fbb; }
  .btn:disabled { opacity:.55; cursor:not-allowed; }
  .spacer { flex:1 1 auto; }
  .ok { color:var(--ok); } .warn{ color:var(--warn); } .err{ color:var(--err); } .muted{ color:var(--muted); }
  main { padding:16px; max-width:1100px; margin:0 auto; }
  .card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; margin:12px 0; }
  .grid { display:grid; grid-template-columns: 200px 1fr; gap:10px; }
  .k { color:var(--muted); }
  #statusMsg { font-size:12px; }
  #statusDot { font-weight:600; }
  code, pre { background:#0b0c0f; border:1px solid #23242a; border-radius:10px; }
  pre { padding:10px; white-space:pre-wrap; max-height:260px; overflow:auto; }
  #settings { position: fixed; top: 56px; right: 12px; width: 360px; background:#111; border:1px solid var(--line); border-radius:12px; padding:10px; display:none; z-index:30; }
  #settings .row { display:grid; grid-template-columns: 80px 1fr; gap:8px; margin:6px 0; }
  #settings input { padding:8px 10px; background:#1a1b1e; border:1px solid #333; border-radius:8px; color:var(--fg); }
  .row-actions { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .pill { padding:4px 8px; border:1px solid #333; border-radius:999px; font-size:12px; color:var(--muted); }
  .hr { height:1px; background:#1f2024; margin:10px -14px; }
  #fixedLog {
    max-height: 420px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  }
</style>
</head>
<body>
<header>
  <button id="btnStart" class="btn ok">Start</button>
  <button id="btnStop" class="btn err">Stop</button>
  <button id="btnRestart" class="btn warn">Restart</button>
  <div class="spacer"></div>
  <button id="btnSettings" class="btn">Settings</button>  
</header>

<!-- Settings Panel -->
<div id="settings">
  <div class="row">
    <label>Server</label><input id="server" type="text" placeholder="http://host:5086"/>
  </div>
  <div class="row">
    <label>Token</label><input id="token" type="text" placeholder="AID_TOKEN"/>
  </div>
  <div class="row row-actions">
    <button id="btnApply" class="btn">Apply & Close</button>
    <button id="btnReset" class="btn err">Reset</button>
  </div>
  <div class="muted" style="font-size:12px">URL에 <code>?token=...</code> 를 붙여 토큰 주입도 가능합니다.</div>
</div>

<main>
  <!-- Status -->
  <div class="card">
    <h3 style="margin:0 0 8px 0;">AId Main Process Status</h3>
    <div id="statusDot" class="muted" style="margin:6px 0 12px 0;">● UNKNOWN</div>
    <div class="grid">
      <div class="k">Running</div><div id="f_running">-</div>
      <div class="k">PID</div><div id="f_pid">-</div>
      <div class="k">Uptime</div><div id="f_uptime">-</div>
      <div class="k">Started At (UTC)</div><div id="f_started">-</div>
      <div class="k">Config Ready</div><div id="f_cfg">-</div>
      <div class="k">Last Error</div><div id="f_err">-</div>
      <div class="k">Cmdline</div><div id="f_cmd">-</div>
      <div class="k">CWD</div><div id="f_cwd">-</div>
    </div>
    <div class="row-actions" style="margin-top:12px;">
      <span class="k">Auto refresh</span>
      <select id="autoSel">
        <option value="0">Off</option>
        <option value="1000" selected>1s</option>
        <option value="2000">2s</option>
        <option value="5000">5s</option>
        <option value="10000">10s</option>
        <option value="30000">30s</option>
      </select>
      <button id="btnRefresh" class="btn">Refresh</button>
      <span id="lastUpdated" class="pill">-</span>
    </div>
    <div id="errorBox" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- Quick API -->
  <div class="card">
    <h3 style="margin:0 0 8px 0;">Quick API Test</h3>
    <div class="row-actions">
      <button class="btn" id="qaStatus">GET /status</button>
      <button class="btn" id="qaStart">POST /control {start}</button>
      <button class="btn" id="qaStop">POST /control {stop}</button>
      <button class="btn" id="qaRestart">POST /control {restart}</button>
    </div>
    <pre id="quickOut" style="margin-top:10px;"></pre>
  </div>

  <!-- Fixed Log Viewer (Polling) -->
  <div class="card">
    <h3 style="margin:0 0 8px 0;">aid_main.out.log (Fixed)</h3>
    <div class="row-actions">
      <label class="pill"><input id="chkFollow" type="checkbox" checked style="vertical-align:-2px;margin-right:6px;"/>Follow end</label>
      <label class="pill"><input id="chkWrap" type="checkbox" checked style="vertical-align:-2px;margin-right:6px;"/>Wrap</label>
      <button id="btnLogRefresh" class="btn">Refresh now</button>
      <button id="btnLogClear" class="btn warn">Clear view</button>
      <a id="btnLogDownload" class="btn" href="#" download="aid_main.out.log">Download</a>
      <span id="logStamp" class="pill">-</span>
    </div>
    <pre id="fixedLog"></pre>
  </div>
</main>

<script>
/* ===== Constants ===== */
const LOG_FIXED_PATH  = "/logs/fixed";   // 다운로드 및 폴링 대상

/* ===== Utilities ===== */
const $ = (id)=>document.getElementById(id);
// const st = (msg, kind='muted')=>{ const el=$("statusMsg"); if(el){ el.textContent=msg; el.className=kind; } console.log("[AId-Control]", msg); };
const st = ()=>{}; // 상태 텍스트 갱신 비활성화 (깜빡임 제거)
const nowIso = ()=> new Date().toISOString().replace('T',' ').replace('Z',' UTC');

function normalizeBase(v){ try{ const u = new URL(v || window.location.origin, window.location.origin); return u.origin; }catch(e){ return window.location.origin; } }
function joinUrl(base, path){ const b=(base||'').replace(/\/+$/,''); const p=(path||'').replace(/^\/+/, ''); return b + '/' + p; }

function getSettings(){
  const url   = new URL(window.location.href);
  const urlTk = url.searchParams.get("token");
  const lsTk  = localStorage.getItem("aid_token");
  const lsSv  = localStorage.getItem("aid_server");
  const token = urlTk || lsTk || "AID_TOKEN";
  const server= normalizeBase(lsSv || window.location.origin);
  return { token, server };
}
function setSettings({token, server}){
  if (token)  localStorage.setItem("aid_token", token);
  if (server) localStorage.setItem("aid_server", normalizeBase(server));
}
function clearSettings(){
  localStorage.removeItem("aid_token");
  localStorage.removeItem("aid_server");
}

async function api(path, opts={}){
  const {token, server} = getSettings();
  const headers = Object.assign({"X-Auth-Token": token}, opts.headers||{});
  const res = await fetch(joinUrl(server, path), Object.assign({}, opts, {headers}));
  return res;
}

/* ===== Status rendering ===== */
function formatUptime(sec){
  if(!sec && sec!==0) return "-";
  const s=Number(sec)|0; const d=Math.floor(s/86400), h=Math.floor((s%86400)/3600), m=Math.floor((s%3600)/60), r=s%60;
  const parts=[]; if(d) parts.push(d+"d"); if(h) parts.push(h+"h"); if(m) parts.push(m+"m"); parts.push(r+"s");
  return parts.join(" ");
}
function S(id, v){ const el=$(id); if(el) el.textContent = (v??"-"); }
function applyStatus(s){
  const running=!!s.running;
  S("f_running", running ? "Yes" : "No");
  S("f_pid"    , s.pid);
  S("f_uptime" , formatUptime(s.uptime_sec));
  S("f_started", s.started_at);
  S("f_cfg"    , (s.config_ready===undefined? "-" : (s.config_ready? "Ready":"Not Ready")));
  S("f_err"    , s.last_error);
  S("f_cmd"    , s.cmdline);
  S("f_cwd"    , s.cwd);
  const dot=$("statusDot"); if(dot){ dot.textContent = running ? "● RUNNING" : "● STOPPED"; dot.className = running ? "ok" : "err"; }
  const bStart=$("btnStart"), bStop=$("btnStop"); if(bStart) bStart.disabled=running; if(bStop) bStop.disabled=!running;
  S("lastUpdated","Updated: "+nowIso());
}

/* ===== Status actions ===== */
async function fetchStatus(){
  try{
    st("Loading status...", "muted");
    $("errorBox").textContent = "";
    const res  = await api("/status");
    const text = await res.text();
    if(!res.ok){ $("errorBox").textContent = `GET /status → ${res.status}\n${text}`; st(`Status ${res.status}`, "err"); return; }
    applyStatus(JSON.parse(text));
    st("Status OK", "ok");
  }catch(e){
    console.error(e);
    $("errorBox").textContent = "GET /status error: "+(e?.message||e);
    st("Fetch error", "err");
  }
}
async function control(action){
  try{
    st(`Sending ${action}...`,"muted"); $("errorBox").textContent="";
    const res = await api("/control",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action})});
    const t = await res.text();
    if(!res.ok){ $("errorBox").textContent = `POST /control {${action}} → ${res.status}\n${t}`; st(`${action} failed`,"err"); return; }
    st(`${action} OK`,"ok"); setTimeout(fetchStatus,600);
  }catch(e){
    console.error(e);
    $("errorBox").textContent=`POST /control {${action}} error: `+(e?.message||e);
    st(`${action} error`,"err");
  }
}

/* ===== Fixed log viewer (Polling) ===== */
let logTimer = null;
let statusTimer = null;
const MAX_CHARS = 200_000;

async function fetchFixedLog() {
  try{
    const { server, token } = getSettings();
    const url = new URL(joinUrl(server, LOG_FIXED_PATH));
    const res = await fetch(url, { headers: { "X-Auth-Token": token } });
    const el = $("fixedLog");
    if (!res.ok) {
      const err = await res.text();
      el.textContent = `[Error ${res.status}] ${err}`;
      $("logStamp").textContent = "Fetch error: " + nowIso();
      return;
    }
    const text = await res.text();
    el.textContent = (text.length > MAX_CHARS) ? text.slice(-MAX_CHARS) : text;
    const wrap = $("chkWrap")?.checked; el.style.whiteSpace = wrap ? "pre-wrap" : "pre";
    $("logStamp").textContent = "Updated: " + nowIso();
    if ($("chkFollow")?.checked) el.scrollTop = el.scrollHeight;

    // 다운로드 링크 보장
    const a=$("btnLogDownload"); if (a) a.href = joinUrl(server, LOG_FIXED_PATH);
  }catch(e){
    $("fixedLog").textContent = "Fetch error: " + (e?.message||e);
    $("logStamp").textContent = "Fetch error: " + nowIso();
  }
}

function startLogPolling(intervalMs = 2000) {
  stopLogPolling();
  fetchFixedLog();
  logTimer = setInterval(fetchFixedLog, intervalMs);
}
function stopLogPolling() {
  if (logTimer) clearInterval(logTimer);
  logTimer = null;
}

/* ===== Auto refresh binding (status + logs) ===== */
function applyAutoRefresh() {
  const sel = $("autoSel");
  const v = parseInt(sel?.value || "0", 10);
  // Status
  if (statusTimer) clearInterval(statusTimer);
  if (v > 0) {
    fetchStatus();
    statusTimer = setInterval(fetchStatus, v);
  }
  // Logs
  if (v > 0) startLogPolling(v); else stopLogPolling();
}

/* ===== Bindings ===== */
function bindClicks(){
  const B=(id,fn)=>{ const el=$(id); if(el) el.onclick = fn; };

  // Header
  B("btnStart"   , ()=> control("start"));
  B("btnStop"    , ()=> control("stop"));
  B("btnRestart" , ()=> control("restart"));
  B("btnRefresh" , fetchStatus);

  // Settings
  B("btnSettings", ()=>{
    const s=$("settings");
    s.style.display = s.style.display==="block" ? "none" : "block";
    const cur=getSettings(); const sv=$("server"), tk=$("token");
    if(sv) sv.value=cur.server; if(tk) tk.value=cur.token;
  });
  B("btnApply", ()=>{
    const sv=$("server"), tk=$("token");
    setSettings({server: sv?sv.value:undefined, token: tk?tk.value:undefined});
    $("settings").style.display="none";
    applyAutoRefresh();   // 서버/토큰 변경 즉시 반영
  });
  B("btnReset", ()=>{
    clearSettings(); const sv=$("server"), tk=$("token");
    if(sv) sv.value=window.location.origin; if(tk) tk.value="AID_TOKEN";
  });

  // Quick API
  B("qaStatus" , async ()=>{ const r=await api("/status"); const t=await r.text(); $("quickOut").textContent=`GET /status → ${r.status}\n`+t; });
  B("qaStart"  , ()=> control("start"));
  B("qaStop"   , ()=> control("stop"));
  B("qaRestart", ()=> control("restart"));

  // Logs
  const el = $("fixedLog");
  const chkWrap = $("chkWrap");
  if (chkWrap){ chkWrap.addEventListener("change", ()=>{ el.style.whiteSpace = chkWrap.checked ? "pre-wrap" : "pre"; }); }
  B("btnLogRefresh", ()=>{ fetchFixedLog(); });
  B("btnLogClear",   ()=>{ el.textContent = ""; });
  const sel = $("autoSel");
  if (sel) sel.addEventListener("change", applyAutoRefresh);
}

/* ===== Bootstrap ===== */
document.addEventListener("DOMContentLoaded", ()=>{
  if (!localStorage.getItem("aid_server")) localStorage.setItem("aid_server", normalizeBase(window.location.origin));
  if (!localStorage.getItem("aid_token"))  localStorage.setItem("aid_token", (new URL(location.href)).searchParams.get("token") || "AID_TOKEN");
  bindClicks();
  // 초기 주기(드롭다운 default=5s)로 상태/로그 모두 시작
  applyAutoRefresh();
});
</script>
</body>
</html>
