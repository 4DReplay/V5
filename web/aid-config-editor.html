<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>AId Public Config Editor (Section UI)</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root { --bg:#0f0f10; --fg:#e8e8ea; --muted:#9aa0a6; --accent:#3ea6ff; --danger:#ff5e57; --ok:#30c75d; --panel:#121316; }
  * { box-sizing: border-box; }
  body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--fg); background:var(--bg); }
  header { display:flex; gap:10px; align-items:center; padding:10px 14px; background:#111; position:sticky; top:0; z-index:30; }
  .btn { padding:6px 10px; background:#1f2227; border:1px solid #333; border-radius:8px; color:var(--fg); cursor:pointer; }
  .btn:hover { border-color:#444; }
  .btn-danger { border-color:#502; color:#faa; }
  .ok { color:var(--ok); } .err{ color:var(--danger); } .muted{ color:var(--muted); }
  .spacer { flex:1 1 auto; }
  #status { font-size:12px; }
  #app { display:grid; grid-template-columns: 280px 1fr; gap:0; }
  aside { border-right:1px solid #222; background:var(--panel); height: calc(100vh - 52px); position:sticky; top:52px; overflow:auto; }
  .side-head { padding:10px; display:grid; gap:8px; border-bottom:1px solid #1e1f23; }
  .side-head input { width:100%; padding:8px 10px; background:#1a1b1e; border:1px solid #333; border-radius:8px; color:var(--fg); }
  .side-tools { display:flex; gap:6px; }
  .section-list { padding:8px; }
  .section-item { padding:8px 10px; border-radius:6px; cursor:pointer; font-size:14px; }
  .section-item:hover { background:#1a1b1e; }
  .section-item.active { background:#2a2d32; border:1px solid #3a3d42; }
  main { padding:14px; }
  .card { background:#141517; border:1px solid #2a2b2f; border-radius:14px; margin:10px 0; }
  .card .head { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; cursor:pointer; }
  .card .head h3 { margin:0; font-size:15px; font-weight:600; }
  .card .tools { display:flex; gap:8px; }
  .card .body { padding:12px; display:none; }
  .row { display:grid; grid-template-columns: 240px 1fr auto; gap:10px; align-items:center; margin:8px 0; }
  .row label { color:var(--muted); font-size:13px; }
  .row input[type="text"], .row input[type="number"], .row select { width:100%; padding:8px 10px; background:#1a1b1e; border:1px solid #333; border-radius:8px; color:var(--fg); }
  @media (max-width: 1100px){ .row { grid-template-columns: 1fr; } }
  #settings { position: fixed; top: 56px; right: 12px; width: 320px; background:#111; border:1px solid #2a2b2f; border-radius:12px; padding:10px; display:none; z-index:40; }
  #settings .row { grid-template-columns: 80px 1fr; }
</style>
</head>
<body>
<header>
  <button id="btnLoad" class="btn">Load</button>
  <button id="btnSaveAll" class="btn">Save All</button>
  <div class="spacer"></div>
  <button id="btnSettings" class="btn">Settings</button>
  <span id="status" class="muted">Ready</span>
</header>

<div id="settings">
  <div class="row">
    <label>Server</label><input id="server" type="text" placeholder="http://host:5086"/>
  </div>
  <div class="row">
    <label>Token</label><input id="token" type="text" placeholder="AID_TOKEN"/>
  </div>
  <div class="row">
    <label></label>
    <div>
      <button id="btnSaveSettings" class="btn">Apply & Close</button>
      <button id="btnClearSettings" class="btn btn-danger">Reset</button>
    </div>
  </div>
</div>

<div id="app">
  <aside>
    <div class="side-head">
      <input id="filter" placeholder="Filter sections..."/>
      <div class="side-tools">
        <button id="btnExpand" class="btn" title="Expand all">Expand</button>
        <button id="btnCollapse" class="btn" title="Collapse all">Collapse</button>
        <!-- Add Section button removed to prevent structural changes -->
      </div>
    </div>
    <div id="sectionList" class="section-list"></div>
  </aside>
  <main><div id="root"></div></main>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const st = (msg, ok=null)=>{ const el=$("status"); el.textContent=msg; el.className = ok===null?"muted":(ok?"ok":"err"); };

function normalizeBase(v){
  const def = window.location.origin;
  if(!v || typeof v!=="string") return def;
  v = v.trim();
  v = v.replace(/^https?:\/+$/,"");
  v = v.replace(/^http:\/\/http:\/\//i, "http://");
  v = v.replace(/^https:\/\/https:\/\//i, "https://");
  v = v.replace(/\/+$/ ,"");
  if(!/^https?:\/\//i.test(v)) v = window.location.protocol+"//"+v;
  return v || def;
}
function getSettings(){
  const url = new URL(window.location.href);
  const urlToken = url.searchParams.get("token");
  const lsToken = localStorage.getItem("aid_token");
  const lsServer = localStorage.getItem("aid_server");
  const token = urlToken || lsToken || "AID_TOKEN";
  const server = normalizeBase(lsServer || window.location.origin);
  return { token, server };
}
function setSettings({token, server}){
  if (token) localStorage.setItem("aid_token", token);
  if (server) localStorage.setItem("aid_server", normalizeBase(server));
}
function clearSettings(){
  localStorage.removeItem("aid_token");
  localStorage.removeItem("aid_server");
}

async function api(path, opts={}){
  const {token, server} = getSettings();
  opts.headers = Object.assign({"X-Auth-Token": token}, opts.headers||{});
  const res = await fetch(normalizeBase(server) + path, opts);
  return res;
}

function isPlainObject(o){ return o && typeof o==="object" && !Array.isArray(o); }
function typeOfValue(v){
  if (v === null) return "null";
  if (Array.isArray(v)) return "array";
  const t = typeof v;
  if (t==="boolean" || t==="number" || t==="string" || t==="object") return t;
  return "string";
}
function inputForValue(key, value){
  const t = typeOfValue(value);
  const container = document.createElement("div");
  if (t==="boolean"){
    const sel = document.createElement("select");
    sel.innerHTML = `<option value="true"${value? " selected":""}>true</option>
                     <option value="false"${!value? " selected":""}>false</option>`;
    sel.dataset.type = "boolean"; container.appendChild(sel);
  } else if (t==="number"){
    const inp = document.createElement("input");
    inp.type = "number"; inp.value = String(value); inp.dataset.type = "number";
    container.appendChild(inp);
  } else if (t==="null"){
    // Keep ability to set a concrete type, but no structural add/remove.
    const sel = document.createElement("select");
    sel.innerHTML = `<option value="null" selected>null</option>
                     <option value="string">string</option>
                     <option value="number">number</option>
                     <option value="boolean">boolean</option>`;
    sel.dataset.type = "null"; container.appendChild(sel);
  } else if (t==="array"){
    const wrap = document.createElement("div");
    (value||[]).forEach((item, idx)=> wrap.appendChild(arrayItemRow(idx, item)));
    container.append(wrap); container.dataset.type = "array";
  } else if (t==="object"){
    container.appendChild(objectEditor(value)); container.dataset.type = "object";
  } else {
    const inp = document.createElement("input");
    inp.type = "text"; inp.value = value ?? ""; inp.dataset.type = "string";
    container.appendChild(inp);
  }
  return container;
}
function arrayItemRow(idx, val){
  const row = document.createElement("div");
  row.className = "row";
  const label = document.createElement("label"); label.textContent = `[${idx}]`;
  const valBox = inputForValue(idx, val);
  // Remove button intentionally omitted (no item removal allowed)
  row.append(label, valBox);
  return row;
}
function objectEditor(obj){
  const box = document.createElement("div");
  const grid = document.createElement("div"); grid.className = "kv";
  Object.keys(obj||{}).sort().forEach(k=>{
    const row = document.createElement("div"); row.className = "row";
    const label = document.createElement("label"); label.textContent = k;
    const valBox = inputForValue(k, obj[k]);
    // Remove button omitted; Add-new-key UI removed
    row.append(label, valBox);
    grid.appendChild(row);
  });
  box.append(grid);
  return box;
}
function readValueFromWidget(node){
  const t = node.dataset?.type;
  if (!t){
    const rows = [...node.querySelectorAll(':scope > .row')];
    if (rows.length){
      const obj = {};
      rows.forEach(r=>{
        const key = r.querySelector("label")?.textContent ?? "";
        const valNode = r.children[1];
        obj[key] = readValueFromWidget(valNode);
      });
      return obj;
    }
    return null;
  }
  if (t==="boolean"){ return node.querySelector("select").value === "true"; }
  if (t==="number"){
    const v = node.querySelector('input[type="number"]').value;
    const n = Number(v); return isNaN(n) ? 0 : n;
  }
  if (t==="null"){
    const sel = node.querySelector("select").value;
    if (sel==="null") return null;
    if (sel==="string") return "";
    if (sel==="number") return 0;
    if (sel==="boolean") return false;
  }
  if (t==="array"){
    const rows = [...node.querySelectorAll(':scope > .row')];
    return rows.map(r=> readValueFromWidget(r.children[1]));
  }
  if (t==="object"){
    const obj = {};
    const rows = [...node.querySelectorAll(':scope > .kv > .row')];
    rows.forEach(r=>{
      const key = r.querySelector("label")?.textContent ?? "";
      obj[key] = readValueFromWidget(r.children[1]);
    });
    return obj;
  }
  if (t==="string"){ return node.querySelector('input[type="text"]').value; }
  return null;
}

let currentData = {};
function render(data){
  currentData = isPlainObject(data)? data : {};
  renderSidebar(Object.keys(currentData));
  const root = $("root"); root.innerHTML = "";
  Object.keys(currentData).sort().forEach(section=>{
    const card = buildSectionCard(section, currentData[section]);
    root.appendChild(card);
  });
}
function buildSectionCard(section, value){
  const card = document.createElement("div"); card.className="card"; card.id = "sec-"+section;
  const head = document.createElement("div"); head.className="head";
  const h = document.createElement("h3"); h.textContent = section;
  const tools = document.createElement("div"); tools.className="tools";
  const btnSave = document.createElement("button"); btnSave.className="btn"; btnSave.textContent="Save Section";
  btnSave.onclick = (e)=>{ e.stopPropagation(); saveSection(section, card); };
  tools.appendChild(btnSave);
  head.append(h, tools);
  const body = document.createElement("div"); body.className="body";
  const editor = inputForValue(section, value);
  body.appendChild(editor);
  head.onclick = ()=>{ body.style.display = (body.style.display==="block"?"none":"block"); };
  card.append(head, body);
  body.style.display="block";
  return card;
}

function renderSidebar(keys){
  const list = $("sectionList");
  const q = ($("filter").value || "").toLowerCase().trim();
  list.innerHTML = "";
  keys.sort().forEach(k=>{
    if(q && !k.toLowerCase().includes(q)) return;
    const item = document.createElement("div"); item.className="section-item"; item.textContent=k;
    item.onclick = ()=>{
      document.querySelectorAll(".section-item").forEach(el=>el.classList.remove("active"));
      item.classList.add("active");
      const el = document.getElementById("sec-"+k);
      if(el){
        el.scrollIntoView({behavior:"smooth", block:"start"});
        const body = el.querySelector(".body"); body.style.display="block";
      }
    };
    list.appendChild(item);
  });
}

$("filter").addEventListener("input", ()=> renderSidebar(Object.keys(currentData)));
$("btnExpand").onclick = ()=> document.querySelectorAll(".card .body").forEach(b=>b.style.display="block");
$("btnCollapse").onclick = ()=> document.querySelectorAll(".card .body").forEach(b=>b.style.display="none");
// btnAddSection removed to prevent adding new sections

async function load(){
  try{
    st("Loading...");
    const res = await api("/config/public");
    if(!res.ok){ st("Load failed: "+res.status+" "+(await res.text()), false); return; }
    const data = await res.json();
    render(data);
    st("Loaded", true);
  }catch(e){ st("Load error: "+e, false); }
}
function collectAll(){
  const out = {};
  document.querySelectorAll("#root > .card").forEach(card=>{
    const sec = card.querySelector(".head h3")?.textContent || "";
    const editor = card.querySelector(".body").children[0];
    out[sec] = readValueFromWidget(editor);
  });
  return out;
}
async function saveAll(){
  try{
    const payload = collectAll();
    st("Saving all...");
    const res = await api("/config/public/replace", {
      method:"POST", headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const text = await res.text();
    if(!res.ok){ st("Save failed: "+text, false); return; }
    st("Saved", true);
  }catch(e){ st("Save error: "+e, false); }
}
async function saveSection(section, cardEl){
  try{
    const editor = cardEl.querySelector(".body").children[0];
    const value = readValueFromWidget(editor);
    st(`Saving [${section}]...`);
    const res = await api("/config/public/by-path", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ path: section, value })
    });
    const text = await res.text();
    if(!res.ok){ st(`Save [${section}] failed: `+text, false); return; }
    st(`Saved [${section}]`, true);
  }catch(e){ st(`Save [${section}] error: `+e, false); }
}

// Settings
$("btnSettings").onclick = ()=>{
  const s = $("settings");
  s.style.display = s.style.display==="block" ? "none" : "block";
  const cur = getSettings(); $("server").value = cur.server; $("token").value = cur.token;
};
$("btnSaveSettings").onclick = ()=>{
  setSettings({ server:$("server").value, token:$("token").value });
  $("settings").style.display="none";
  load();
};
$("btnClearSettings").onclick = ()=>{
  clearSettings(); $("server").value = window.location.origin; $("token").value = "AID_TOKEN";
};

// Top buttons
$("btnLoad").onclick = load;
$("btnSaveAll").onclick = saveAll;

// Bootstrap: default AID_TOKEN + current origin, then auto-load
window.addEventListener("load", ()=>{
  const cur = getSettings();
  if (!localStorage.getItem("aid_server")) localStorage.setItem("aid_server", normalizeBase(window.location.origin));
  if (!localStorage.getItem("aid_token"))  localStorage.setItem("aid_token", cur.token);
  load();
});
</script>
</body>
</html>
