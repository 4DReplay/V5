<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-store" />

  <!-- Common OMS Loader -->
  <script src="/web/oms-common.js"></script>
  <script>
    OMS.initAssets();
    OMS.applyPageConfig("Liveview");
    OMS.initActions();
  </script>

  <style>
    body {
      background-color: #0b0f14;
      color: #eee;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    .btn {
      background: #1e40af;
      color: #fff;
      border: 0;
      border-radius: 8px;
      padding: 8px 14px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.2s;
    }

    .btn:hover {
      filter: brightness(1.15);
    }

    #statusLed {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #555;
      margin-left: 6px;
    }

    .page-wrap {
      padding: 20px;
      width: 100%;
    }

    .card {
      background: #1a1a1a;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    select {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #222;
      color: #fff;
      width: 100%;
      max-width: 280px;
    }

    iframe {
      width: 100%;
      height: 72vh;
      border: none;
      background: black;
      border-radius: 8px;
      margin-top: 12px;
    }

    #btnFull {
      margin-top: 10px;
      background: #555;
      width: 150px;
    }
  </style>
</head>

<body>

  <!-- Title -->
  <h2 class="page-title">
    <span id="pageTitle"></span>    
    <small id="meta"></small>
  </h2>

  <div class="toolbar">
    <button class="btn" onclick="location.href='/camera'">📸 Camera</button>
    <span class="divider"></span>
    <button id="btnRestart" class="btn" style="background:#334155;">🔄Restart</button>
    <button id="btnToggle" class="btn">ON / OFF</button>
    <span style="display:flex;align-items:center;">MediaMTX <span id="statusLed"></span></span>
  </div>

  <div class="page-wrap">

    <!-- Camera selection -->
    <div class="card">
      <label>📸 Select Camera</label>
      <div class="row">
        <select id="cameraSelect"></select>
      </div>
    </div>

    <!-- Live View -->
    <div class="card">
      <iframe id="liveFrame"></iframe>
      <button id="btnFull" class="btn">Fullscreen</button>
    </div>
  </div>


  <script>
    function withPrefix(url) {
      const m = location.pathname.match(/^\/proxy\/([^/]+)/);
      const prefix = m ? `/proxy/${encodeURIComponent(m[1])}` : "";
      return prefix + url;
    }

    const cameraSelect = document.getElementById("cameraSelect");

    function openLive(ip) {
      if (!ip) return;

      const path = `cam_${ip.replace(/\./g, "_")}`;
      const url = `http://10.82.104.210:8889/${path}/`;

      document.getElementById("liveFrame").src = url;
    }

    // Camera select auto-change → open live
    cameraSelect.addEventListener("change", () => {
      openLive(cameraSelect.value);
    });

    async function loadCameraList() {
      const res = await fetch(withPrefix("/oms/state"));
      const j = await res.json();

      cameraSelect.innerHTML = "";

      j.cameras.forEach(cam => {
        const op = document.createElement("option");
        op.value = cam.IP;
        op.textContent = cam.IP;
        cameraSelect.appendChild(op);
      });

      // Auto-select first camera & open live
      if (j.cameras.length > 0) {
        cameraSelect.value = j.cameras[0].IP;
        openLive(j.cameras[0].IP);
      }
    }

    // MediaMTX Status
    const led = document.getElementById("statusLed");
    const toggleBtn = document.getElementById("btnToggle");
    const restartBtn = document.getElementById("btnRestart");

    function updateLed(running) {
      led.style.background = running ? "#22c55e" : "#ef4444";
      toggleBtn.textContent = running ? "Turn OFF" : "Turn ON";
    }

    async function refreshStatus() {
      try {
        const res = await fetch(withPrefix("/oms/liveview/status"));
        const j = await res.json();
        updateLed(j.running);
        toggleBtn.dataset.state = j.running ? "on" : "off";
      } catch {
        updateLed(false);
      }
    }

    // Toggle ON/OFF
    toggleBtn.onclick = async () => {
      const state = toggleBtn.dataset.state;
      const endpoint = state === "on" ? "/oms/liveview/off" : "/oms/liveview/on";

      await fetch(withPrefix(endpoint), { method: "POST" });
      await new Promise(r => setTimeout(r, 700));
      refreshStatus();

      // Re-open selected camera
      openLive(cameraSelect.value);
    };

    // Restart sequence
    restartBtn.onclick = async () => {
      await fetch(withPrefix("/oms/liveview/off"), { method: "POST" });
      await new Promise(r => setTimeout(r, 800));
      await fetch(withPrefix("/oms/liveview/on"), { method: "POST" });
      await new Promise(r => setTimeout(r, 800));
      refreshStatus();

      // Re-open selected camera
      openLive(cameraSelect.value);
    };

    document.getElementById("btnFull").onclick = () => {
      const f = document.getElementById("liveFrame");
      if (f.requestFullscreen) f.requestFullscreen();
    };

    // Init
    loadCameraList();
    refreshStatus();
    setInterval(refreshStatus, 4000);
  </script>

</body>
</html>
