<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <!-- common title/style -->
  <script src="/web/oms-common.js"></script>
  <script src="/web/oms-actions.js"></script>
  <script>
    OMS.initAssets();
    OMS.applyPageConfig("Liveview");
    OMS.initActions();
  </script>
  <style>
    /* body — common과 다른 부분만 */
    body {
      color: #eee;              /* common: #eef2f7 → 다름 */
      margin: 0;                /* common: 24px → 다름 */
      padding: 0;               /* common: 없음 → 다름 */
      font-family: Arial, sans-serif;  /* common과 다름 */
      background-color: #0b0f14; /* 같지만 유지 (페이지 독립적) */
    }
    /* .btn — 다른 값만 */
    .btn {
      border-radius: 8px;       /* common: 10px → 다름 */
      padding: 8px 14px;        /* common: 8px 12px → 다름 */
    }
    .btn:hover {
      filter: brightness(1.15); /* common과 동일 → 제거 가능하지만 유지해도 무해 */
    }
    /* #statusLed — common에 없음 → 유지 */
    #statusLed {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #555;
      margin-left: 6px;
    }
    /* .page-wrap — common에 없음 → 유지 */
    .page-wrap {
      padding: 20px;
      width: 100%;
    }
     /* .row — common에 없음 → 유지 */
    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    /* select — 모두 common과 다름 */
    select {
      padding: 10px;            /* common 없음 */
      border: 1px solid #444;   /* common: #243045 → 다름 */
      background: #222;         /* common: #0b1220 → 다름 */
      color: #fff;              /* common: #e5e7eb → 다름 */
      border-radius: 6px;
      width: 100%;
      max-width: 280px;
    }
    /* iframe — common에 없음 → 유지 */
    iframe {
      width: 100%;
      height: 72vh;
      border: none;
      background: black;
      border-radius: 8px;
      margin-top: 12px;
    }

    /* 버튼 풀스크린 — common에 없음 → 유지 */
    #btnFull {
      margin-top: 10px;
      background: #555;
      width: 150px;
    }
  </style>
</head>

<body>

  <!-- Title -->
  <h2 class="page-title">
    <span id="pageTitle"></span>    
    <small id="meta"></small>
  </h2>

  <div class="toolbar">
    <button class="btn" onclick="location.href='/camera'">📸 Camera</button>
    <span class="divider"></span>
    <button id="btnAutoFocus" class="btn">🎯 Auto Focus All</button>
    <span class="divider"></span>
    <button id="btnRestart" class="btn" style="background:#334155;">🔄Restart</button>
    <button id="btnToggle" class="btn">ON / OFF</button>
    <span style="display:flex;align-items:center;">MediaMTX <span id="statusLed"></span></span>
  </div>

  <div class="page-wrap">

    <!-- Camera selection -->
    <div class="card">
      <label>📸 Select Camera</label>
      <div class="row">
        <select id="cameraSelect"></select>
        <!-- 🔹 단일 카메라 Auto Focus 버튼 -->
        <button id="btnAutoFocusOne" class="btn" style="background:#475569;">
          🎯 Auto Focus
        </button>
      </div>
    </div>

    <!-- Live View -->
    <div class="card">
      <iframe id="liveFrame"></iframe>
      <button id="btnFull" class="btn">Fullscreen</button>
    </div>
  </div>


  <script>
    function withPrefix(url) {
      const m = location.pathname.match(/^\/proxy\/([^/]+)/);
      const prefix = m ? `/proxy/${encodeURIComponent(m[1])}` : "";
      return prefix + url;
    }

    const cameraSelect = document.getElementById("cameraSelect");

    function openLive(ip) {
      if (!ip) return;

      const path = `cam_${ip.replace(/\./g, "_")}`;
      const url = `http://10.82.104.210:8889/${path}/`;

      document.getElementById("liveFrame").src = url;
    }

    // Camera select auto-change → open live
    cameraSelect.addEventListener("change", () => {
      openLive(cameraSelect.value);
    });

    async function loadCameraList() {
      const res = await fetch(withPrefix("/oms/state"));
      const j = await res.json();

      cameraSelect.innerHTML = "";

      j.cameras.forEach(cam => {
        const op = document.createElement("option");
        op.value = cam.IP;
        op.textContent = cam.IP;
        cameraSelect.appendChild(op);
      });

      // Auto-select first camera & open live
      if (j.cameras.length > 0) {
        cameraSelect.value = j.cameras[0].IP;
        openLive(j.cameras[0].IP);
      }
    }

    // ---- All Camera Auto Focus ----
    const btnAF = document.getElementById("btnAutoFocus");
    if (btnAF && window.OMS && OMS.Actions.autoFocus) {
      btnAF.onclick = () => OMS.Actions.autoFocus(null);   // ← PointerEvent 제거
    }
    // ---- Single Camera Auto Focus ----
    const btnAF1 = document.getElementById("btnAutoFocusOne");
    if (btnAF1 && window.OMS && OMS.Actions.autoFocus) {
      btnAF1.onclick = () => {
        const ip = cameraSelect.value;
        if (!ip) {
          alert("No camera selected");
          return;
        }
        OMS.Actions.autoFocus(ip);   // ▶ 단일 카메라 AF
      };
    }

    // MediaMTX Status
    const led = document.getElementById("statusLed");
    const toggleBtn = document.getElementById("btnToggle");
    const restartBtn = document.getElementById("btnRestart");

    function updateLed(running) {
      led.style.background = running ? "#22c55e" : "#ef4444";
      toggleBtn.textContent = running ? "Turn OFF" : "Turn ON";
    }

    async function refreshStatus() {
      try {
        const res = await fetch(withPrefix("/oms/liveview/status"));
        const j = await res.json();
        updateLed(j.running);
        toggleBtn.dataset.state = j.running ? "on" : "off";
      } catch {
        updateLed(false);
      }
    }

    // Toggle ON/OFF
    toggleBtn.onclick = async () => {
      const state = toggleBtn.dataset.state;
      const endpoint = state === "on" ? "/oms/liveview/off" : "/oms/liveview/on";

      await fetch(withPrefix(endpoint), { method: "POST" });
      await new Promise(r => setTimeout(r, 700));
      refreshStatus();

      // Re-open selected camera
      openLive(cameraSelect.value);
    };

    // Restart sequence
    restartBtn.onclick = async () => {
      await fetch(withPrefix("/oms/liveview/off"), { method: "POST" });
      await new Promise(r => setTimeout(r, 800));
      await fetch(withPrefix("/oms/liveview/on"), { method: "POST" });
      await new Promise(r => setTimeout(r, 800));
      refreshStatus();

      // Re-open selected camera
      openLive(cameraSelect.value);
    };

    document.getElementById("btnFull").onclick = () => {
      const f = document.getElementById("liveFrame");
      if (f.requestFullscreen) f.requestFullscreen();
    };

    // Init
    loadCameraList();
    refreshStatus();
    setInterval(refreshStatus, 4000);
  </script>

</body>
</html>
