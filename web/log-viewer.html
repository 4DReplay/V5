<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Log Viewer</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <link rel="icon" type="image/x-icon" href="web/images/4DMain.ico">
  <script>
    (function () {
      const m = location.pathname.match(/^\/proxy\/([^/]+)/);
      const PROXY_PREFIX = m ? "/proxy/" + encodeURIComponent(m[1]) : "";
      const bust = "?v=" + Date.now();

      const CSS_CANDIDATES = [
        PROXY_PREFIX + "/web/4d-common-style.css",
        "./4d-common-style.css",
      ];
      const JS_CANDIDATES = [
        PROXY_PREFIX + "/web/4d-common-style.js",
        "./4d-common-style.js",
      ];

      function injectCSS(list, i = 0) {
        if (i >= list.length) return;
        const el = document.createElement("link");
        el.rel = "stylesheet";
        el.href = list[i] + bust;
        el.onerror = () => {
          console.warn("[CSS miss]", list[i]);
          injectCSS(list, i + 1);
        };
        document.head.appendChild(el);
      }

      function injectJS(list, i = 0) {
        if (i >= list.length) return;
        const el = document.createElement("script");
        el.defer = true;
        el.src = list[i] + bust;
        el.onerror = () => {
          console.warn("[JS miss]", list[i]);
          injectJS(list, i + 1);
        };
        document.head.appendChild(el);
      }

      injectCSS(CSS_CANDIDATES);
      injectJS(JS_CANDIDATES);
    })();
  </script>
  <style>
    :root {
      --bg: #0b0f14;
      --fg: #eef2f7;
      --muted: #94a3b8;
      --card: #0b1220;
      --line: #243045;
      --btn: #1e40af;
      --btn2: #334155;
      --th: #0f172a;
    }

    html,
    body {
      height: 100%
    }

    body {
      background: var(--bg);
      color: var(--fg);
      font: 14px/1.5 -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      margin: 16px
    }

    header {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 10px
    }

    h2 {
      margin: 0 12px 0 0;
      font-size: 20px
    }

    button {
      background: var(--btn);
      color: #fff;
      border: 0;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer
    }

    button.btn2 {
      background: var(--btn2)
    }

    select,
    input[type="text"] {
      background: #0b1220;
      color: #e5e7eb;
      border: 1px solid var(--line);
      border-radius: 6px;
      padding: 6px 8px
    }

    label {
      display: flex;
      align-items: center;
      gap: 6px
    }

    #meta {
      margin-left: auto;
      font-size: 12px;
      color: #cbd5e1
    }

    #log {
      height: calc(100vh - 76px);
      overflow: auto;
      background: #0b1220;
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 10px;
      white-space: pre-wrap;
      margin: 0
    }

    a.link {
      color: #93c5fd;
      text-decoration: none
    }
  </style>
</head>

<body>
  <header>
    <h2 id="title">Logs</h2>

    <input id="tbName" type="text" placeholder="process name" style="min-width:140px">
    <select id="selDate" title="date"></select>
    <select id="selTail" title="tail bytes">
      <option value="20000">20 KB</option>
      <option value="50000" selected>50 KB</option>
      <option value="200000">200 KB</option>
      <option value="1000000">1 MB</option>
    </select>
    <label title="auto refresh"><input type="checkbox" id="cbAuto" checked> auto</label>
    <button id="btnRefresh" class="btn2">Refresh</button>
    <span id="meta">-</span>
  </header>

  <pre id="log">(loading...)</pre>

  <script>
    (function () {
      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Proxy ì§€ì›: /proxy/<node>/ ìžë™ê°ì§€ + fetch íŒ¨ì¹˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      const PROXY_NODE = (() => {
        const m = location.pathname.match(/^\/proxy\/([^/]+)\//);
        return m ? decodeURIComponent(m[1]) : "";
      })();

      if (PROXY_NODE) {
        // <base> ì£¼ìž…: ìƒëŒ€ê²½ë¡œë¥¼ /proxy/<node>/ ê¸°ì¤€ìœ¼ë¡œ í•´ì„
        const base = document.createElement("base");
        base.href = `/proxy/${encodeURIComponent(PROXY_NODE)}/`;
        document.head.prepend(base);

        // fetch íŒ¨ì¹˜: ì ˆëŒ€ê²½ë¡œ("/...") ì•žì— /proxy/<node> ìžë™ë¶€ì°©
        const orig = window.fetch;
        window.fetch = function (input, init) {
          let url = (typeof input === "string") ? input : (input && input.url) || "";
          if (typeof url === "string" && url.startsWith("/") && !url.startsWith("/proxy/")) {
            url = `/proxy/${encodeURIComponent(PROXY_NODE)}${url}`;
          }
          if (typeof input !== "string" && input && input.url) {
            return orig(new Request(url, input), init);
          }
          return orig(url, init);
        };
      }

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Query Params â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      const qs = new URLSearchParams(location.search);
      const NODE_Q = qs.get("node") || "";            // ì¿¼ë¦¬ì˜ node (ì—†ì–´ë„ ë¨)
      const NAME0 = qs.get("name") || "";
      const DATE0 = qs.get("date") || "";
      const TAIL0 = qs.get("tail") || "";
      const AUTO0 = qs.get("auto");                  // "1"|"0"|null

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Mode / Base URL â”€â”€â”€â”€â”€â”€â”€â”€â”€
         ìš°ì„ ìˆœìœ„: â‘  URLì´ /proxy/<node>/ë¡œ ì—´ë ¸ìœ¼ë©´ ê·¸ ë…¸ë“œ ì‚¬ìš©
                   â‘¡ ì¿¼ë¦¬ì— node= ìžˆìœ¼ë©´ ê·¸ ë…¸ë“œ ì‚¬ìš©
                   â‘¢ ê·¸ ì™¸ì—ëŠ” ë¡œì»¬(DMS ì§ì ‘ ì ‘ê·¼) */
      const EFFECTIVE_NODE = PROXY_NODE || NODE_Q;
      const BASE = EFFECTIVE_NODE ? `/proxy/${encodeURIComponent(EFFECTIVE_NODE)}` : "";

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      const title = document.getElementById("title");
      const tbName = document.getElementById("tbName");
      const selDate = document.getElementById("selDate");
      const selTail = document.getElementById("selTail");
      const cbAuto = document.getElementById("cbAuto");
      const btnRefresh = document.getElementById("btnRefresh");
      const meta = document.getElementById("meta");
      const logEl = document.getElementById("log");
      let timer = null;

      if (TAIL0) selTail.value = TAIL0;
      if (AUTO0 === "0") cbAuto.checked = false;
      tbName.value = NAME0;

      function setTitle() {
        const nm = tbName.value.trim() || "(unknown)";
        const bullet = "\u2022";
        title.textContent = EFFECTIVE_NODE
          ? `Logs ${bullet} ${nm} @ ${EFFECTIVE_NODE}`
          : `Logs ${bullet} ${nm}`;
      }
      setTitle();

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Fetch helper â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      async function jget(path) {
        const r = await fetch(path, { cache: "no-store" });
        const ct = r.headers.get("content-type") || "";
        const isJson = ct.includes("application/json");
        if (!r.ok) {
          let msg;
          try { msg = isJson ? (await r.json()).error || r.statusText : await r.text(); } catch { msg = r.statusText; }
          throw new Error(msg || `HTTP ${r.status}`);
        }
        return isJson ? r.json() : r.text();
      }

      function baseFor(proc) {
        return `/daemon/${encodeURIComponent(proc)}/log`;
      }

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Dates load â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      async function loadDates() {
        selDate.innerHTML = "";
        const name = tbName.value.trim();
        if (!name) {
          const opt = document.createElement("option");
          opt.value = ""; opt.textContent = "(enter name)";
          selDate.appendChild(opt);
          return;
        }
        try {
          const r = await jget(`${baseFor(name)}/list`);
          const dates = Array.isArray(r?.dates) ? r.dates : (Array.isArray(r) ? r : []);
          if (dates.length === 0) {
            const opt = document.createElement("option");
            opt.value = ""; opt.textContent = "(no logs)";
            selDate.appendChild(opt);
          } else {
            dates.forEach(d => {
              const opt = document.createElement("option");
              opt.value = d; opt.textContent = d;
              selDate.appendChild(opt);
            });

            // ✅ 쿼리스트링에 date가 있으면 그대로 사용
            //    없으면 가장 최근(마지막) 날짜를 기본 선택
            if (DATE0 && dates.includes(DATE0)) {
              selDate.value = DATE0;
            } else {
              selDate.value = dates[dates.length - 1];
            }
          }
        } catch (e) {
          const opt = document.createElement("option");
          opt.value = ""; opt.textContent = "(load failed)";
          selDate.appendChild(opt);
        }
      }

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Log refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      async function refresh() {
        const name = tbName.value.trim();
        if (!name) {
          logEl.textContent = "(name required)";
          meta.textContent = "-";
          return;
        }
        const params = new URLSearchParams();
        const d = selDate.value;
        if (d) params.set("date", d);
        params.set("tail", selTail.value || "50000");
        try {
          const url = `${baseFor(name)}?${params.toString()}`;
          const r = await jget(url);
          if (r && r.ok) {
            logEl.textContent = r.text || "";
            const bullet = "\u2022";
            meta.textContent =
              `${r.path || url} ${bullet} ${r.size ?? '-'} bytes `
              + `${bullet} date ${r.date ?? (selDate.value || '-')} `
              + `${bullet} tail ${r.tail ?? selTail.value} bytes`;
            logEl.scrollTop = logEl.scrollHeight;
          } else {
            logEl.textContent = (r && r.error) ? r.error : "(no content)";
            meta.textContent = "-";
          }
        } catch (e) {
          logEl.textContent = String(e.message || e);
          meta.textContent = "-";
        }
      }

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Auto refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      function startAuto() {
        stopAuto();
        if (cbAuto.checked) {
          timer = setInterval(refresh, 2000);
        }
      }
      function stopAuto() {
        if (timer) { clearInterval(timer); timer = null; }
      }

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      btnRefresh.addEventListener("click", refresh);
      cbAuto.addEventListener("change", startAuto);
      selTail.addEventListener("change", refresh);
      selDate.addEventListener("change", refresh);
      tbName.addEventListener("change", async () => {
        setTitle();
        await loadDates();
        await refresh();
      });

      // Keyboard: Ctrl/Cmd+R to refresh (prevent full reload)
      document.addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "r") {
          e.preventDefault();
          refresh();
        }
      });

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      (async function init() {
        await loadDates();
        await refresh();
        startAuto();
      })();

    })();
  </script>
</body>

</html>