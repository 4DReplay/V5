<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>4DReplay V5 - OMs System</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <link rel="icon" href="images/4dmain.ico" type="image/x-icon">
  <style>
    :root{
      --bg:#0b0f14; --fg:#eef2f7; --muted:#94a3b8;
      --th:#0f172a; --line:#243045; --line2:#1f2937;
      --row-run:#0e2416; --row-stop:#171a1e;
      --badge-ok:#1f9d48; --badge-bad:#b83a3a;
      --btn:#1e40af; --btn2:#334155; --ok:#16a34a; --bad:#ef4444; --warn:#f59e0b;
    }
    html,body{height:100%}
    body{background:var(--bg);color:var(--fg);font:14px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,
      "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Noto Emoji",sans-serif;margin:24px}
    h2{font-size:32px;margin:0 0 14px;display:flex;align-items:center;gap:8px}
    h2 small{font-size:14px;color:var(--muted)}
    .toolbar{display:flex;gap:10px;margin:8px 0 16px;align-items:center;flex-wrap:wrap}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid var(--line);padding:10px}
    th{background:var(--th);text-align:left}
    tr.running td{ background:var(--row-run); }
    tr.other   td{ background:var(--row-stop); }
    .pill{
      font-family: inherit;
      display:inline-block;padding:6px 12px;border-radius:999px;border:1px solid;
      line-height:1;font-weight:500;letter-spacing:.3px;background:transparent
    }
    .badge-ok { color:#22c55e;border-color:var(--badge-ok); }
    .badge-bad{ color:#f87171;border-color:var(--badge-bad); }
    .pill-ok{ color:#22c55e;border-color:var(--ok); }
    .pill-bad{ color:#f87171;border-color:var(--bad); }
    .pill-warn{ color:#fbbf24;border-color:var(--warn); }
    .muted{color:var(--muted)}
    button{
      font-family: inherit;
      background:var(--btn);color:#fff;border:0;border-radius:14px;
      padding:8px 14px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;
      transition:filter .2s ease
    }
    .btn-secondary{ background:var(--btn2); }
    button:hover{ filter:brightness(1.08) }
    .toolbar button{ border-radius:12px; padding:10px 16px }
    a.node{color:#93c5fd;text-decoration:none}
    a.node:hover{text-decoration:underline}
    .spacer{flex:1}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#0f172a;border-radius:12px;padding:6px 10px;color:var(--fg)}
    #progressChip{
      min-width: 180px;
      justify-content: center;
      white-space: nowrap;
      flex: 0 0 auto;
      visibility: hidden;
    }
    #busyMsg{margin-left:8px;opacity:.9}
    #err{display:none;margin:8px 0;padding:10px;border-radius:8px;background:#3b0d0d;border:1px solid #ef4444;color:#ffe0e0;white-space:pre-wrap}

    .panel{margin-top:18px;border:1px solid var(--line2);border-radius:12px;padding:12px;background:#0b1220}
    .kv{display:grid;grid-template-columns:150px 1fr;gap:8px;align-items:center}
    textarea{width:100%;height:180px;resize:vertical;background:#0b1220;color:#e5e7eb;border:1px solid var(--line);border-radius:8px;padding:8px;font:13px ui-monospace,monospace;}
    pre{white-space:pre-wrap;word-break:break-word;background:#0b1220;border:1px solid var(--line);border-radius:8px;padding:10px;max-height:280px;overflow:auto}
    .btn-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <h2>
    <span>4DReplay V5 - OMs System</span>
    <small id="meta"></small>
  </h2>

  <div class="toolbar">
    <button id="btnConfig" class="btn-secondary">üìù Config Editor</button>
    <button id="btnReload" class="btn-secondary">üîÑ Reload</button>
    <button id="omsRestartAll" class="btn-secondary">‚ü≥ Restart All</button>
    <span id="progressChip" class="chip" role="status" aria-live="polite"></span>
    <span class="spacer"></span>
    <span class="chip" id="hb">poll -</span>
  </div>

  <div id="err"></div>

  <table id="grid">
    <thead>
      <tr>
        <th>Node</th>
        <th>Process</th>
        <th>Version</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p class="muted" style="margin-top:10px">
    Tip: Logs are reachable via OMS proxy (<code>/proxy/&lt;node&gt;/‚Ä¶</code>).
  </p>

  <div class="panel">
    <h3 style="margin:0 0 8px">Connect Sequence (one-by-one via /oms/mtd-connect)</h3>
    <div class="kv">
      <span>MTd Host</span>
      <input id="seqHost" type="text" placeholder="10.82.x.x or hostname">
      <span>MTd Port</span>
      <input id="seqPort" type="number" min="1" max="65535" value="19765">
      <span>DMPDIP</span>
      <input id="seqMgmtIP" type="text" placeholder="127.0.0.1">
    </div>

    <div class="btn-row" style="margin:8px 0">
      <label class="chip"><input type="checkbox" id="seqAutoToken" checked> Auto Token</label>
      <label class="chip"><input type="checkbox" id="seqSanitize" checked> Sanitize DaemonList</label>
      <label class="chip"><input type="checkbox" id="seqDryRun"> Dry-Run</label>
      <button id="btnSeqFillFromList" class="btn-secondary">üß© Fill from List</button>
      <span class="spacer"></span>
      <span id="seqStatus" class="pill">Idle</span>
    </div>

    <div class="kv">
      <span>Daemon Map (JSON)</span>
      <textarea id="seqDaemonMap" spellcheck="false" placeholder='{
  "EMd": "10.82.104.210",
  "CCd": "10.82.104.210",
  "SCd": "10.82.104.210",
  "GCd": "10.82.104.210",
  "PCd": "10.82.104.210",
  "SPd": "10.82.104.213",
  "AId": "10.82.104.215"
}'></textarea>
    </div>

    <div class="btn-row" style="margin-top:8px">
      <button id="btnSeqStart">üöÄ Run Sequence</button>
      <button id="btnSeqAbort" class="btn-secondary">‚õî Abort</button>
      <span class="spacer"></span>
      <button id="btnCopySeqLog" class="btn-secondary">üìã Copy Log</button>
      <button id="btnSaveSeqLog" class="btn-secondary">üíæ Save Log</button>
    </div>

    <h4 style="margin:12px 0 6px">Progress</h4>
    <pre id="seqLog">-</pre>
  </div>

  <script>
    const DEBUG=false;
    const TBody=document.querySelector("#grid tbody");
    const HB=document.getElementById("hb");
    const META=document.getElementById("meta");
    const PROG=document.getElementById("progressChip");
    const ERR=document.getElementById("err");
    const BTN_RELOAD=document.getElementById("btnReload");
    const BTN_CONFIG=document.getElementById("btnConfig");
    const BTN_RA=document.getElementById("omsRestartAll");
    let lastData=null;
    let OMS_ALIAS_MAP = {};
    let POLLER = null;
    let RA_LOCK = false;
    let POLL_MS = 3000;
    let RA_FINAL = false;          // ÏôÑÎ£å/ÏóêÎü¨/idle Ïù¥ÌõÑ true ‚Üí Îçî Ïù¥ÏÉÅ ÎçÆÏßÄ ÏïäÏùå
    let RA_MSG_PRIORITY = 0;       // ÌòÑÏû¨ Î©îÏãúÏßÄ Ïö∞ÏÑ†ÏàúÏúÑ (ÎÜíÏùÑÏàòÎ°ù Í∞ïÌï®)
    let RA_SEEN_RUNNING = false;   // running ÏùÑ Ìïú Î≤àÏù¥ÎùºÎèÑ Î≥∏ ÌõÑÏóêÎßå ÏôÑÎ£å Ïù∏Ï†ï
    let RA_SESSION_ID = 0;         // Ïû¨ÏãúÏûë ÏÑ∏ÏÖò Í∞ÄÎìú
    const RA_IDLE_GRACE_MS = 3000; // ÌÅ¥Î¶≠ ÌõÑ Ï¥àÍ∏∞ idle Î¨¥Ïãú Ïú†Ïòà
    

    function startPolling(ms){
      if (typeof ms === "number" && isFinite(ms) && ms > 0) {
        POLL_MS = ms;
      }
      stopPolling();
      POLLER = setInterval(()=>{ if(!RA_LOCK) reloadNow().catch(()=>{}); }, POLL_MS);
      if (DEBUG) console.debug("[OMS] poll started:", POLL_MS, "ms");
    }
    function stopPolling(){
      if (POLLER){ clearInterval(POLLER); POLLER=null; }
    }

    // ‚îÄ‚îÄ ÏßÑÌñâÏπ© Ïπ¥Ïö¥ÌåÖ Ïú†Ìã∏: ÏÑ†ÌÉùÎêú ÌîÑÎ°úÏÑ∏Ïä§ Ï§ë running/stop Ïàò Í≥ÑÏÇ∞
    function computeProgressFromStatus(data){
      const nodes = Array.isArray(data && data.nodes) ? data.nodes : [];
      let total=0, run=0, stop=0;
      const toList = (status)=>{
        if (!status) return [];
        if (status.data && typeof status.data==="object") return Object.values(status.data);
        if (Array.isArray(status.processes)) return status.processes;
        if (Array.isArray(status.executables)) return status.executables;
        return [];
      };
      for (const n of nodes){
        const procs = toList(n.status);
        for (const p of procs){
          if (p && p.select === true){
            total += 1;
            if (p.running) run += 1; else stop += 1;
          }
        }
      }
      return { total, run, stop };
    }

    // ‚îÄ‚îÄ Restart-All Ï§ë ÏßÑÌñâÏπ©Îßå Í∞±Ïã†ÌïòÎäî Í≤ΩÎüâ Ìè¥Îü¨
    let RA_PROGRESS_POLLER = null;
    async function startRaProgressPolling(){
      stopRaProgressPolling();
      RA_PROGRESS_POLLER = setInterval(async ()=>{
        try{
          const st = await api("/oms/status");
          const { total, run, stop } = computeProgressFromStatus(st);
          const s = await api("/oms/restart/state").catch(()=>null);
          const base = (s && s.message) ? s.message : "Restarting‚Ä¶";
          raWrite(`${base} (${run}/${total} running ¬∑ ${stop}/${total} stopped)`, 1);
        }catch(_){}
      }, 800);
    }
    function stopRaProgressPolling(){
      if (RA_PROGRESS_POLLER){ clearInterval(RA_PROGRESS_POLLER); RA_PROGRESS_POLLER=null; }
    }
    async function api(path, init={}) {
      const res = await fetch(path, { cache:"no-store", ...init });
      const ct = res.headers.get("content-type") || "";
      const isJson = ct.includes("application/json");
      const body = isJson ? await res.json().catch(()=>({})) : await res.text().catch(()=> "");
      if (!res.ok) throw new Error(isJson ? (body.error||`HTTP ${res.status}`) : (body||`HTTP ${res.status}`));
      return body;
    }
    function showErr(m){ ERR.style.display="block"; ERR.textContent=m; }
    function clearErr(){ ERR.style.display="none"; ERR.textContent=""; }
    function setBusy(on){
      BTN_RELOAD.disabled = on || RA_LOCK;
      BTN_CONFIG.disabled  = on || RA_LOCK;
      BTN_RA.disabled      = on || RA_LOCK;
    }

    const PROG_LS_KEY = "oms_ra_progress";
    /**
     * ÏßÑÌñâÏπ© Î©îÏãúÏßÄ Ïì∞Í∏∞ (Ïö∞ÏÑ†ÏàúÏúÑ Í∏∞Î∞ò)
     * @param {string} text
     * @param {number} priority 1=progress, 2=live, 3=SSE, 10=final
     */
    function raWrite(text, priority=1){
      if (RA_FINAL && priority < 10) return;            // ÏôÑÎ£å Ïù¥ÌõÑÏóî finalÎßå ÌóàÏö©
      if (priority < RA_MSG_PRIORITY) return;           // ÎÇÆÏùÄ Ïö∞ÏÑ†ÏàúÏúÑÎäî Î¨¥Ïãú
      RA_MSG_PRIORITY = priority;
      PROG.style.visibility = "visible";
      const msg = (text && String(text).trim()) ? text : (PROG.textContent.trim() || "Working‚Ä¶");
      if (PROG.textContent !== msg) PROG.textContent = msg;
      try { localStorage.setItem(PROG_LS_KEY, msg); } catch {}
    }
    function raClear(){
      // ÏãúÏûë Ïãú Ï¥àÍ∏∞Ìôî (ÏôÑÎ£å Î©îÏãúÏßÄÎäî Ïú†ÏßÄ)
      RA_FINAL = false;
      RA_MSG_PRIORITY = 0;
      RA_SEEN_RUNNING = false;
    }
    new MutationObserver(()=>{
      // ÏôÑÎ£å Ïû†Í∏à Ïãú Ïô∏Î∂Ä Î≥µÍµ¨ ÏãúÎèÑ Î¨¥Ïãú
      if (RA_FINAL) return;
      if (!PROG.textContent || !PROG.textContent.trim()){
        const cached = localStorage.getItem(PROG_LS_KEY);
        if (cached && cached.trim()) PROG.textContent = cached;
        else PROG.textContent = "Working‚Ä¶";
      }
    }).observe(PROG, {characterData:true, childList:true, subtree:true});
    window.addEventListener("storage", (e)=>{
      // ÏôÑÎ£å Ïû†Í∏à Ïãú Ïô∏Î∂Ä ÌÉ≠ Í∞±Ïã† Î¨¥Ïãú
      if (RA_FINAL) return;
      if (e.key === PROG_LS_KEY && typeof e.newValue === "string"){
        PROG.style.visibility = "visible";
        if (e.newValue.trim()) PROG.textContent = e.newValue;
      }
    });
    (function(){ const cached = localStorage.getItem(PROG_LS_KEY); if (cached) { PROG.style.visibility="visible"; PROG.textContent=cached; }})();

    function toProcList(status){
      if (!status) return [];
      if (status.data && typeof status.data==="object") return Object.values(status.data);
      if (Array.isArray(status.processes)) return status.processes;
      if (Array.isArray(status.executables)) return status.executables;
      return [];
    }
    function nodeCellHtml(n,i,total){
      const href = `/proxy/${encodeURIComponent(n.name)}/dms-system.html`;
      return `<a class="node" href="${href}" target="_blank">${(n.alias||n.name)}</a><br><span class="muted">${n.host}:${n.port}${total?` (${i+1}/${total})`:""}</span>`;
    }

    function applyOverlays(data){
      const extra = (data && data.extra) || {};
      const verMap = extra.versions || {};
      const presdVer = extra.presd_versions || {};
      const conn = extra.connected_daemons || {};
      const presdIps = extra.presd_ips || [];
      const nodes = Array.isArray(data.nodes) ? data.nodes : [];
      const toList = (status)=>{
        if (!status) return [];
        if (status.data && typeof status.data==="object") return Object.values(status.data);
        if (Array.isArray(status.processes)) return status.processes;
        if (Array.isArray(status.executables)) return status.executables;
        return [];
      };
      for (const n of nodes){
        const procs = toList(n.status);
        for (const p of procs){
          if (!p || !p.name) continue;
          const ip = p.ip || p.IP || p.addr || p.address || "";
          if (p.name === "PreSd" && ip && presdVer[ip]){
            p.version = presdVer[ip].version || "-";
            p.version_date = presdVer[ip].date || "-";
          } else if (p.name === "MMd" && verMap.MMd){
            p.version = verMap.MMd.version || "-";
            p.version_date = verMap.MMd.date || "-";
          } else if (verMap[p.name]){
            p.version = verMap[p.name].version || "-";
            p.version_date = verMap[p.name].date || "-";
          }
          if (conn.SPd && (p.name==="MMd" || p.name==="MMc")){
            p.connection_state = "CONNECTED";
          }
          if (conn.PreSd && p.name==="PreSd"){
            if (!presdIps.length || (ip && presdIps.includes(ip))){
              p.connection_state = "CONNECTED";
            }
          }
          if (conn[p.name]){
            p.connection_state = "CONNECTED";
          }
        }
      }
    }

    function render(data){
      applyOverlays(data);
      OMS_ALIAS_MAP = (data && data.extra && data.extra.alias_map) || {};
      lastData=data;

      const hbSecRaw = Number(data && data.heartbeat_interval_sec);
      if (!Number.isNaN(hbSecRaw) && hbSecRaw > 0) {
        const nextMs = Math.max(800, Math.min(10000, Math.floor(hbSecRaw * 1000)));
        if (!RA_LOCK && nextMs !== POLL_MS) {
          startPolling(nextMs);
        }
        HB.textContent = `poll ${hbSecRaw}s`;
      } else {
        HB.textContent = "poll -";
      }

      const nodes = Array.isArray(data.nodes)? data.nodes : [];
      META.textContent = `nodes: ${nodes.length}`;
      TBody.innerHTML="";
      if (nodes.length===0){
        TBody.innerHTML = `<tr class="other"><td colspan="5" class="muted">no nodes</td></tr>`; return;
      }
      for(let i=0;i<nodes.length;i++){
        const n=nodes[i];
        const all=toProcList(n.status);
        const shown = all.filter(p=>p && p.select===true);
        if (!n.status || all.length===0){
          TBody.insertAdjacentHTML("beforeend", `<tr class="other"><td>${nodeCellHtml(n,i,nodes.length)}</td><td colspan="4" class="muted">unreachable</td></tr>`); continue;
        }
        if (shown.length===0){
          TBody.insertAdjacentHTML("beforeend", `<tr class="other"><td>${nodeCellHtml(n,i,nodes.length)}</td><td colspan="4" class="muted">no selected processes</td></tr>`); continue;
        }
        for(const p of shown){
          const running=!!p.running;
          const conn=(p.connection_state||"").toUpperCase();
          const badge = conn==="CONNECTED" ? `<span class="pill badge-ok">CONNECTED</span>` :
                        conn==="STOPPED"   ? `<span class="pill badge-bad">STOPPED</span>` :
                        (running ? `<span class="pill badge-ok">RUNNING</span>` : `<span class="pill badge-bad">STOPPED</span>`);
          const verHtml = (p.version || p.version_date)
            ? `${(p.version||"-")}<br><span class="muted">${(p.version_date||"-")}</span>`
            : `<span class="muted">-<br>-</span>`;
          const dmsAlias = (p.alias || "").trim();
          const omsAlias = (OMS_ALIAS_MAP[p.name] || "").trim();
          let aliasHtml = "";
          if (dmsAlias && omsAlias && dmsAlias !== omsAlias) {
            aliasHtml = `<br><span class="muted" title="OMS alias: ${omsAlias}">${dmsAlias}</span>`;
          } else {
            const a = dmsAlias || omsAlias;
            aliasHtml = a ? `<br><span class="muted">${a}</span>` : "";
          }

          TBody.insertAdjacentHTML("beforeend", `
            <tr class="${running?'running':'other'}">
              <td>${nodeCellHtml(n,i,nodes.length)}</td>
              <td>${p.name||"-"}${aliasHtml}</td>
              <td>${verHtml}</td>
              <td>${badge}</td>
              <td>
                <button class="btn-secondary" data-a="logs"  data-node="${n.name}" data-proc="${p.name}">üìú Logs</button>
              </td>
            </tr>`);
        }
      }
    }

    async function reloadNow(){
      try{
        if (!RA_LOCK) setBusy(true);
        clearErr();
        render(await api("/oms/status"));
      }catch(e){
        showErr(e.message||e);
      }finally{
        if (!RA_LOCK) setBusy(false);
      }
    }

    document.querySelector("#grid tbody").addEventListener("click", ev=>{
      const b=ev.target.closest("button"); if(!b) return;
      if (b.dataset.a==="logs"){
        const url = `/web/log-viewer.html?node=${encodeURIComponent(b.dataset.node)}&name=${encodeURIComponent(b.dataset.proc)}`;
        window.open(url,"_blank");
      }
    });

    // ==== Restart-All ÏßÑÌñâ Ïπ¥Ïö¥ÌåÖ & ÎùºÏù¥Î∏å ÏßÑÌñâÏπ© Í∞±Ïã† ====
    function pluckProcs(status){
      if (!status) return [];
      if (status.data && typeof status.data==="object") return Object.values(status.data);
      if (Array.isArray(status.processes)) return status.processes;
      if (Array.isArray(status.executables)) return status.executables;
      return [];
    }
    function calcProgressFromOmsStatus(omsStatus){
      const nodes = Array.isArray(omsStatus && omsStatus.nodes) ? omsStatus.nodes : [];
      let total=0, run=0, stop=0, unknown=0;
      for (const n of nodes){
        const list = pluckProcs(n && n.status);
        for (const p of list){
          if (!p || p.select !== true) continue;
          total += 1;
          if (p.running === true) run += 1;
          else if (p.running === false) stop += 1;
          else unknown += 1;
        }
      }
      return { total, run, stop, unknown };
    }
    const sleep = (ms)=>new Promise(r=>setTimeout(r, ms));

    let RA_LIVE = null;
    async function startRaLiveProgressLoop(){
      stopRaLiveProgressLoop();
      RA_LIVE = setInterval(async ()=>{
        try{
          const data = await api("/oms/status");
          const p = calcProgressFromOmsStatus(data);
          const sec = Math.round((performance.now() - (window.__raStartTs||performance.now()))/1000);
          if (p.total > 0){
            raWrite(`Restarting‚Ä¶ (${p.run}/${p.total} running ¬∑ ${p.stop}/${p.total} stopped ¬∑ ${sec}s)`, 2);
          }else{
            raWrite(`Restarting‚Ä¶ (discovering ¬∑ ${sec}s)`, 2);
          }
        }catch{}
      }, 600);
    }
    function stopRaLiveProgressLoop(){
      if (RA_LIVE){ clearInterval(RA_LIVE); RA_LIVE = null; }
    }

    // ==== SSE & Ìè¥Î∞± Ìè¥ÎßÅ ====
    let evtSrc=null, sseTimer=null, statePoller=null;
    function closeSSE(){ if(evtSrc){evtSrc.close(); evtSrc=null;} if(sseTimer){clearInterval(sseTimer); sseTimer=null;} }
    function onProgressState(s){
      if (!s) return;
      if (s.message) raWrite(s.message, 3);
      // running Ïã†Ìò∏ Í∞êÏßÄ ‚Üí Ïù¥ÌõÑÏóêÎßå ÏôÑÎ£å Ïù∏Ï†ï
      if (s.state === "running") {
        RA_SEEN_RUNNING = true;
        return;
      }

      // ÌÅ¥Î¶≠ ÏßÅÌõÑ idleÏùÄ Ï°∞Í∏∞ ÏôÑÎ£åÎ°ú Ïò§Ïù∏Îê† Ïàò ÏûàÏúºÎØÄÎ°ú Ïú†Ïòà
      if (s.state === "idle" && !RA_SEEN_RUNNING) {
        const elapsed = performance.now() - (window.__raStartTs || performance.now());
        if (elapsed < RA_IDLE_GRACE_MS) {
          // Ï°∞Ïö©Ìûà Î¨¥ÏãúÌïòÍ±∞ÎÇò Í∞ÄÎ≤ºÏö¥ ÎåÄÍ∏∞ Î©îÏãúÏßÄ
          raWrite(`Waiting to start‚Ä¶ (${Math.max(1, Math.round((RA_IDLE_GRACE_MS - elapsed)/1000))}s)`, 2);
          return;
        }
        // Ïú†Ïòà ÌõÑÏóêÎèÑ runningÏùÑ Î™ª Î¥§Îã§Î©¥ "ÏßÑÌñâ ÏóÜÏùå"ÏúºÎ°ú ÏïàÎÇ¥Îßå ÌïòÍ≥† ÏôÑÎ£å Ï≤òÎ¶¨ÌïòÏßÄ ÏïäÏùå
        raWrite("No restart in progress (idle).", 2);
        return;
      }
      if (s.state==="done" || s.state==="error" || (s.state==="idle" && RA_SEEN_RUNNING)){         
        // ÏôÑÎ£å Ï≤òÎ¶¨: Î™®Îì† ÏûëÏÑ±Ïûê Ï†ïÏßÄ + ÏµúÏ¢Ö Î©îÏãúÏßÄ Í≥†Ï†ï
        RA_FINAL = true;
        stopRaProgressPolling();
        stopRaLiveProgressLoop();
        closeSSE();

        RA_LOCK = false; setBusy(false);
        // ÏÑúÎ≤Ñ ÏöîÏïΩ Ïö∞ÏÑ†
        if (s.summary && typeof s.summary === "object"){
          const sum = s.summary;
          const took = (sum.elapsedSec!=null) ? `${Math.round(sum.elapsedSec)}s`
                    : `${Math.round((performance.now() - (window.__raStartTs||performance.now()))/1000)}s`;
          const stopOk = sum.stop?.ok ?? 0, stopFail = sum.stop?.fail ?? 0;
          const startOk = sum.start?.ok ?? 0, startFail = sum.start?.fail ?? 0;
          raWrite(`Restart-All done: stop ok ${stopOk}, fail ${stopFail}; start ok ${startOk}, fail ${startFail}; elapsed ${took}`, 10);
          if ((sum.stop?.fail||0) + (sum.start?.fail||0) > 0 && Array.isArray(sum.failedNames) && sum.failedNames.length){
            showErr("Restart-All partial failures: " + sum.failedNames.join(", "));
          }
        } else {
          // ÏÑúÎ≤Ñ ÏöîÏïΩÏù¥ ÏóÜÏúºÎ©¥ ÎùºÏù¥Î∏å Ïä§ÎÉÖÏÉ∑ÏúºÎ°ú ÏûÑÏãú ÏöîÏïΩ
          (async ()=>{
            try{
              const snap = await api("/oms/status");
              const p = calcProgressFromOmsStatus(snap);
              const took = `${Math.round((performance.now() - (window.__raStartTs||performance.now()))/1000)}s`;
              const fails = Math.max(0, p.total - p.run);
              const label = RA_SEEN_RUNNING ? "Restart-All done (live)" : "Restart-All finished (no activity)";
              raWrite(`${label}: start ok ${p.run}, fail ${fails}; elapsed ${took}`, 10);
              if (fails > 0){
                // Ïã§Ìå® Íµ¨Ï≤¥ Î™©Î°ùÏùÄ ÏÑúÎ≤ÑÏóêÏÑú Ï†úÍ≥µÎêòÏßÄ ÏïäÏúºÎØÄÎ°ú ÏÉùÎûµ(ÏõêÌïòÎ©¥ /oms/restart/state ÌôïÏû• ÌïÑÏöî)
              }
            }catch{
              raWrite("Restart-All done", 10);
            }
          })();
        }

        startPolling(POLL_MS);
        if (statePoller){ clearInterval(statePoller); statePoller=null; }
        reloadNow().catch(()=>{});
      }
    }
    function startSSE(){
      closeSSE();
      if ("EventSource" in window){
        evtSrc = new EventSource("/oms/restart/stream");
        // ÏÑúÎ≤ÑÎäî event: progress ÏÇ¨Ïö© ‚Üí Ï†ïÌôï Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        const handler = (e)=>{ try{ onProgressState(JSON.parse(e.data)); }catch{} };
        evtSrc.addEventListener("progress", handler);
        // ÌòπÏãú Î∞∞Ìè¨Ïóê Îî∞Îùº Í∏∞Î≥∏ onmessageÎ°ú Ïò¨ ÏàòÎèÑ ÏûàÏñ¥ÏÑú Î∞±ÏóÖ Ïú†ÏßÄ
        evtSrc.onmessage = handler;
        evtSrc.onerror = ()=>{ startStatePolling(); };
      } else {
        startStatePolling();
      }
    }
    function startStatePolling(){
      if (statePoller) return;
      statePoller = setInterval(async ()=>{
        try{ const s = await api("/oms/restart/state"); onProgressState(s); }catch{}
      }, 750);
    }

    BTN_RELOAD.onclick = reloadNow;
    BTN_CONFIG.onclick = ()=> location.href="oms-config.html";
    BTN_RA.onclick = async ()=>{
      const mySession = ++RA_SESSION_ID;
      RA_LOCK = true;
      RA_FINAL = false;
      RA_MSG_PRIORITY = 0;
      RA_SEEN_RUNNING = false;
      stopPolling();
      clearErr(); setBusy(true);
      raWrite("Restarting‚Ä¶ preparing", 3);
      window.__raStartTs = performance.now();
      try{
        await api("/oms/restart/all", {method:"POST"});
        // ÏÑúÎ≤ÑÍ∞Ä state=running ÏúºÎ°ú Ï†ÑÌôòÌï† Ïú†Ïòà
        setTimeout(() => {
          if (mySession !== RA_SESSION_ID) return; // Ïò§ÎûòÎêú ÏÑ∏ÏÖò Î≥¥Ìò∏
          startRaLiveProgressLoop();
          startSSE();
          startRaProgressPolling();
        }, 250);
      }catch(e){
        showErr(e.message||e);
        RA_LOCK=false; setBusy(false); startPolling(POLL_MS);
        stopRaProgressPolling();
        stopRaLiveProgressLoop();
      }
    };

    (async function(){
      try{
        const s = await api("/oms/restart/state");
        if (s && s.state === "running"){
          RA_LOCK=true; setBusy(true);
          raWrite(s.message || "Working‚Ä¶", 3);
          window.__raStartTs = performance.now();
          startRaLiveProgressLoop();
          startSSE();
          RA_SEEN_RUNNING = true;
        }
      }catch{}
      await reloadNow();
      startPolling(POLL_MS);
    })();
  </script>

  <script src="/web/oms-system.js" defer></script>
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      if (typeof window.initOmsSystem !== 'function') {
        console.error('initOmsSystem not found'); return;
      }
      window.initOmsSystem({});
    });
  </script>
</body>
</html>
