<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>4DReplay V5 - OMs System</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <link rel="icon" href="images/4dmain.ico" type="image/x-icon">
  <style>
    :root{
      --bg:#0b0f14; --fg:#eef2f7; --muted:#94a3b8;
      --th:#0f172a; --line:#243045; --line2:#1f2937;
      --row-run:#0e2416; --row-stop:#171a1e;
      --badge-ok:#1f9d48; --badge-bad:#b83a3a;
      --btn:#1e40af; --btn2:#334155; --ok:#16a34a; --bad:#ef4444; --warn:#f59e0b;
    }
    html,body{height:100%}
    body{background:var(--bg);color:var(--fg);font:14px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,
      "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Noto Emoji",sans-serif;margin:24px}
    h2{font-size:32px;margin:0 0 14px;display:flex;align-items:center;gap:8px}
    h2 small{font-size:14px;color:var(--muted)}
    .toolbar{display:flex;gap:10px;margin:8px 0 16px;align-items:center;flex-wrap:wrap}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid var(--line);padding:10px}
    th{background:var(--th);text-align:left}
    tr.running td{ background:var(--row-run); }
    tr.other   td{ background:var(--row-stop); }
    .pill{
      /* ë¶€ëª¨ í°íŠ¸ ìƒì† â†’ ì´ëª¨ì§€ í°íŠ¸ ì‚¬ìš© */
      font-family: inherit;
      display:inline-block;padding:6px 12px;border-radius:999px;border:1px solid;
      line-height:1;font-weight:500;letter-spacing:.3px;background:transparent
    }
    .badge-ok { color:#22c55e;border-color:var(--badge-ok); }
    .badge-bad{ color:#f87171;border-color:var(--badge-bad); }
    .pill-ok{ color:#22c55e;border-color:var(--ok); }
    .pill-bad{ color:#f87171;border-color:var(--bad); }
    .pill-warn{ color:#fbbf24;border-color:var(--warn); }
    .muted{color:var(--muted)}
    button{
      /* ë²„íŠ¼ë„ ìƒì† â†’ ì´ëª¨ì§€ ì •ìƒ í‘œì‹œ */
      font-family: inherit;
      background:var(--btn);color:#fff;border:0;border-radius:14px;
      padding:8px 14px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;
      transition:filter .2s ease
    }
    .btn-secondary{ background:var(--btn2); }
    button:hover{ filter:brightness(1.08) }
    .toolbar button{ border-radius:12px; padding:10px 16px }
    a.node{color:#93c5fd;text-decoration:none}
    a.node:hover{text-decoration:underline}
    .spacer{flex:1}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#0f172a;border-radius:12px;padding:6px 10px;color:var(--fg)}
    /* ì§„í–‰ì¹©: í•­ìƒ ìë¦¬ë¥¼ ìœ ì§€(ë ˆì´ì•„ì›ƒ ê³ ì •) */
    #progressChip{
      min-width: 180px;
      justify-content: center;
      white-space: nowrap;   /* ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
      flex: 0 0 auto;        /* ìˆ˜ì¶• ê¸ˆì§€ */
      visibility: hidden;    /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€(ìë¦¬ ìœ ì§€) */
    }
    /* íˆ´ë°”ëŠ” wrap í—ˆìš©ì´ì§€ë§Œ ì§„í–‰ì¹©ì€ ì¤„ë°”ê¿ˆ ë˜ì§€ ì•ŠìŒ(ìœ„ flex ì„¤ì •ìœ¼ë¡œ ë³´í˜¸) */#busyMsg{margin-left:8px;opacity:.9}
    #err{display:none;margin:8px 0;padding:10px;border-radius:8px;background:#3b0d0d;border:1px solid #ef4444;color:#ffe0e0;white-space:pre-wrap}

    /* sequence panel */
    .panel{margin-top:18px;border:1px solid var(--line2);border-radius:12px;padding:12px;background:#0b1220}
    .kv{display:grid;grid-template-columns:150px 1fr;gap:8px;align-items:center}
    textarea{width:100%;height:180px;resize:vertical;background:#0b1220;color:#e5e7eb;border:1px solid var(--line);border-radius:8px;padding:8px;font:13px ui-monospace,monospace;}
    pre{white-space:pre-wrap;word-break:break-word;background:#0b1220;border:1px solid var(--line);border-radius:8px;padding:10px;max-height:280px;overflow:auto}
    .btn-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <h2>
    <span>4DReplay V5 - OMs System</span>
    <small id="meta"></small>
  </h2>

  <div class="toolbar">
    <button id="btnConfig" class="btn-secondary">ğŸ“ Config Editor</button>
    <button id="btnReload" class="btn-secondary">ğŸ”„ Reload</button>
    <button id="omsRestartAll" class="btn-secondary">âŸ³ Restart All</button>
    <!-- ì§„í–‰ ìƒí™© ì „ìš© ì¹© (SSE/í´ë§ìœ¼ë¡œë§Œ ê°±ì‹ ; ë‹¤ë¥¸ ì½”ë“œì—ì„œ ê±´ë“¤ì§€ ì•ŠìŒ) -->
    <span id="progressChip" class="chip" role="status" aria-live="polite"></span>
    <span class="spacer"></span>
    <!-- í´ë§ ìƒíƒœ(ì½ê¸° ì „ìš©) -->
    <span class="chip" id="hb">poll -</span>
  </div>

  <div id="err"></div>

  <!-- grid -->
  <table id="grid">
    <thead>
      <tr>
        <th>Node</th>
        <th>Process</th>
        <th>Version</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p class="muted" style="margin-top:10px">
    Tip: Logs are reachable via OMS proxy (<code>/proxy/&lt;node&gt;/â€¦</code>).
  </p>

  <!-- sequence panel -->
  <div class="panel">
    <h3 style="margin:0 0 8px">Connect Sequence (one-by-one via /oms/mtd-connect)</h3>
    <div class="kv">
      <span>MTd Host</span>
      <input id="seqHost" type="text" placeholder="10.82.x.x or hostname">
      <span>MTd Port</span>
      <input id="seqPort" type="number" min="1" max="65535" value="19765">
      <span>DMPDIP</span>
      <input id="seqMgmtIP" type="text" placeholder="127.0.0.1">
    </div>

    <div class="btn-row" style="margin:8px 0">
      <label class="chip"><input type="checkbox" id="seqAutoToken" checked> Auto Token</label>
      <label class="chip"><input type="checkbox" id="seqSanitize" checked> Sanitize DaemonList</label>
      <label class="chip"><input type="checkbox" id="seqDryRun"> Dry-Run</label>
      <button id="btnSeqFillFromList" class="btn-secondary">ğŸ§© Fill from List</button>
      <span class="spacer"></span>
      <span id="seqStatus" class="pill">Idle</span>
    </div>

    <div class="kv">
      <span>Daemon Map (JSON)</span>
      <textarea id="seqDaemonMap" spellcheck="false" placeholder='{
  "EMd": "10.82.104.210",
  "CCd": "10.82.104.210",
  "SCd": "10.82.104.210",
  "GCd": "10.82.104.210",
  "PCd": "10.82.104.210",
  "SPd": "10.82.104.213",
  "AId": "10.82.104.215"
}'></textarea>
    </div>

    <div class="btn-row" style="margin-top:8px">
      <button id="btnSeqStart">ğŸš€ Run Sequence</button>
      <button id="btnSeqAbort" class="btn-secondary">â›” Abort</button>
      <span class="spacer"></span>
      <button id="btnCopySeqLog" class="btn-secondary">ğŸ“‹ Copy Log</button>
      <button id="btnSaveSeqLog" class="btn-secondary">ğŸ’¾ Save Log</button>
    </div>

    <h4 style="margin:12px 0 6px">Progress</h4>
    <pre id="seqLog">-</pre>
  </div>

  <script>
    // ===== util & grid rendering =====
    const DEBUG=false;
    const TBody=document.querySelector("#grid tbody");
    const HB=document.getElementById("hb");
    const META=document.getElementById("meta");
    const PROG=document.getElementById("progressChip");
    const ERR=document.getElementById("err");    
    const BTN_RELOAD=document.getElementById("btnReload");
    const BTN_CONFIG=document.getElementById("btnConfig");
    const BTN_RA=document.getElementById("omsRestartAll");
    let lastData=null;
    let OMS_ALIAS_MAP = {};
    // í´ë§/ë½ ìƒíƒœ
    let POLLER = null;
    let RA_LOCK = false; // Restart All ì§„í–‰ ì¤‘
    let POLL_MS = 3000;  // ê¸°ë³¸ê°’(3s), ìƒíƒœì— ë”°ë¼ ë™ì ìœ¼ë¡œ êµì²´

    function startPolling(ms){
      if (typeof ms === "number" && isFinite(ms) && ms > 0) {
        POLL_MS = ms;
      }
      stopPolling();
      POLLER = setInterval(()=>{ if(!RA_LOCK) reloadNow().catch(()=>{}); }, POLL_MS);
      if (DEBUG) console.debug("[OMS] poll started:", POLL_MS, "ms");
    }
    function stopPolling(){
      if (POLLER){ clearInterval(POLLER); POLLER=null; }
    }

    async function api(path, init={}) {
      const res = await fetch(path, { cache:"no-store", ...init });
      const ct = res.headers.get("content-type") || "";
      const isJson = ct.includes("application/json");
      const body = isJson ? await res.json().catch(()=>({})) : await res.text().catch(()=> "");
      if (!res.ok) throw new Error(isJson ? (body.error||`HTTP ${res.status}`) : (body||`HTTP ${res.status}`));
      return body;
    }
    function showErr(m){ ERR.style.display="block"; ERR.textContent=m; }
    function clearErr(){ ERR.style.display="none"; ERR.textContent=""; }
    // í´ë§/ë²„íŠ¼ ìƒíƒœë§Œ ì œì–´(ë©”ì‹œì§€ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
    function setBusy(on){
      BTN_RELOAD.disabled = on || RA_LOCK;
      BTN_CONFIG.disabled  = on || RA_LOCK;
      BTN_RA.disabled      = on || RA_LOCK;
    }

    // â”€â”€ ì§„í–‰ì¹©: ë‹¨ì¼ ì“°ê¸° ê²½ë¡œ (SSE/í´ë§/ìŠ¤í† ë¦¬ì§€ ì´ë²¤íŠ¸ë§Œ ë³€ê²½ ê°€ëŠ¥)
    const PROG_LS_KEY = "oms_ra_progress";
    function raWrite(text){
      PROG.style.visibility = "visible";
      const msg = (text && String(text).trim()) ? text : (PROG.textContent.trim() || "Workingâ€¦");
      if (PROG.textContent !== msg) PROG.textContent = msg;
      // ë¡œì»¬ ìºì‹œ(ë‹¤ë¥¸ íƒ­/í˜ì´ì§€ ë™ê¸°í™”)
      try { localStorage.setItem(PROG_LS_KEY, msg); } catch {}
    }
    function raClear(){
      // ì™„ë£Œ í›„ì—ë„ ì§€ìš°ì§€ ë§ê³  ë§ˆì§€ë§‰ ë©”ì‹œì§€ ìœ ì§€ ìš”êµ¬ â†’ ìˆ¨ê¸°ì§€ ì•ŠìŒ
      // í•„ìš” ì‹œ ìˆ˜ë™ìœ¼ë¡œë§Œ ì´ˆê¸°í™”
    }
    // ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ê°€ ì¹©ì„ ë¹„ìš°ë©´ ì¦‰ì‹œ ë³µêµ¬
    new MutationObserver(()=>{
      if (!PROG.textContent || !PROG.textContent.trim()){
        const cached = localStorage.getItem(PROG_LS_KEY);
        if (cached && cached.trim()) PROG.textContent = cached;
        else PROG.textContent = "Workingâ€¦";
      }
    }).observe(PROG, {characterData:true, childList:true, subtree:true});
    // ë‹¤ë¥¸ íƒ­/í˜ì´ì§€ì—ì„œ ê°±ì‹ ë˜ë©´ ë™ê¸° ë°˜ì˜(ê°™ì€ ì˜¤ë¦¬ì§„)
    window.addEventListener("storage", (e)=>{
      if (e.key === PROG_LS_KEY && typeof e.newValue === "string"){
        PROG.style.visibility = "visible";
        if (e.newValue.trim()) PROG.textContent = e.newValue;
      }
    });
    // ì´ˆê¸° ë³µì›
    (function(){ const cached = localStorage.getItem(PROG_LS_KEY); if (cached) { PROG.style.visibility="visible"; PROG.textContent=cached; }})();


    function toProcList(status){
      if (!status) return [];
      if (status.data && typeof status.data==="object") return Object.values(status.data);
      if (Array.isArray(status.processes)) return status.processes;
      if (Array.isArray(status.executables)) return status.executables;
      return [];
    }
    function nodeCellHtml(n,i,total){
      const href = `/proxy/${encodeURIComponent(n.name)}/dms-system.html`;
      return `<a class="node" href="${href}" target="_blank">${(n.alias||n.name)}</a><br><span class="muted">${n.host}:${n.port}${total?` (${i+1}/${total})`:""}</span>`;
    }

    // â–¼ ì¶”ê°€: extra.* ë¥¼ í”„ë¡œì„¸ìŠ¤ë“¤ì— ë°˜ì˜
    function applyOverlays(data){
      const extra = (data && data.extra) || {};
      const verMap = extra.versions || {};                 // { EMd:{version,date}, MTd:{...}, MMd:{...}, ... }
      const presdVer = extra.presd_versions || {};         // { "10.82.104.211":{version,date}, ... }
      const conn = extra.connected_daemons || {};          // { EMd:true, SPd:true, PreSd:true, ... }
      const presdIps = extra.presd_ips || [];              // ["10.82.104.211", "10.82.104.212"]

      const nodes = Array.isArray(data.nodes) ? data.nodes : [];

      // ìƒíƒœ/í”„ë¡œì„¸ìŠ¤ ì ‘ê·¼ ìœ í‹¸
      const toList = (status)=>{
        if (!status) return [];
        if (status.data && typeof status.data==="object") return Object.values(status.data);
        if (Array.isArray(status.processes)) return status.processes;
        if (Array.isArray(status.executables)) return status.executables;
        return [];
      };

      for (const n of nodes){
        const procs = toList(n.status);
        for (const p of procs){
          if (!p || !p.name) continue;

          // ---- ë²„ì „ ì˜¤ë²„ë ˆì´ ----
          // 1) PreSdëŠ” IPë³„ ë²„ì „ì„ ìš°ì„  ë§¤ì¹­
          const ip = p.ip || p.IP || p.addr || p.address || "";
          if (p.name === "PreSd" && ip && presdVer[ip]){
            p.version = presdVer[ip].version || "-";
            p.version_date = presdVer[ip].date || "-";
          }
          // 2) MMdëŠ” ì„œë²„ê°€ SPdì—ì„œ ë°›ì•„ ì €ì¥í•˜ë¯€ë¡œ MMd í‚¤ë¡œ ì£¼ì…
          else if (p.name === "MMd" && verMap.MMd){
            p.version = verMap.MMd.version || "-";
            p.version_date = verMap.MMd.date || "-";
          }
          // 3) ì¼ë°˜ ë°ëª¬(EMd/MTd/CCd/SCd/PCd/GCd/SPd ë“±)
          else if (verMap[p.name]){
            p.version = verMap[p.name].version || "-";
            p.version_date = verMap[p.name].date || "-";
          }

          // ---- ì—°ê²° ìƒíƒœ ì˜¤ë²„ë ˆì´ ----
          // SPdê°€ OKë©´ MMd/MMcê¹Œì§€ CONNECTED ì²˜ë¦¬
          if (conn.SPd && (p.name==="MMd" || p.name==="MMc")){
            p.connection_state = "CONNECTED";
          }
          // PreSd OKë©´ presd_ipsê°€ ìˆìœ¼ë©´ í•´ë‹¹ IPë§Œ, ì—†ìœ¼ë©´ ì „ì²´ PreSdë¥¼ CONNECTED
          if (conn.PreSd && p.name==="PreSd"){
            if (!presdIps.length || (ip && presdIps.includes(ip))){
              p.connection_state = "CONNECTED";
            }
          }
          // ê·¸ ì™¸ í‚¤ë“¤ì€ ê°™ì€ ì´ë¦„ì˜ ë°ëª¬ì— ì§ì ‘ ë°˜ì˜ (ì˜ˆ: EMd, CCd ë“±)
          if (conn[p.name]){
            p.connection_state = "CONNECTED";
          }
        }
      }
    }

    function render(data){
      // â–¼ ì¶”ê°€: ì„œë²„ê°€ ë³´ê´€ ì¤‘ì¸ ë²„ì „/ì—°ê²° ì •ë³´ë¥¼ í”„ë¡œì„¸ìŠ¤ ë¦¬ìŠ¤íŠ¸ì— ì£¼ì…
      applyOverlays(data);
      OMS_ALIAS_MAP = (data && data.extra && data.extra.alias_map) || {};
      lastData=data;

      // ---- Heartbeat ê¸°ë°˜ í´ë§ ì£¼ê¸° ë™ì  ë°˜ì˜ ----
      const hbSecRaw = Number(data && data.heartbeat_interval_sec);
      if (!Number.isNaN(hbSecRaw) && hbSecRaw > 0) {
        // ìµœì†Œ/ìµœëŒ€ ê°€ë“œ(0.8s ~ 10s ì •ë„ë¡œ ì•ˆì „ ë²”ìœ„)
        const nextMs = Math.max(800, Math.min(10000, Math.floor(hbSecRaw * 1000)));
        // Restart All ì¤‘ì—ëŠ” í´ë§ ì£¼ê¸°ë¥¼ ë°”ê¾¸ì§€ ì•ŠìŒ(ê¹œë¹¡ì„ ë°©ì§€)
        if (!RA_LOCK && nextMs !== POLL_MS) {
          startPolling(nextMs);
        }
        HB.textContent = `poll ${hbSecRaw}s`;
      } else {
        HB.textContent = "poll -";
      }
      
      const nodes = Array.isArray(data.nodes)? data.nodes : [];
      META.textContent = `nodes: ${nodes.length}`;
      TBody.innerHTML="";
      if (nodes.length===0){
        TBody.innerHTML = `<tr class="other"><td colspan="5" class="muted">no nodes</td></tr>`; return;
      }
      for(let i=0;i<nodes.length;i++){
        const n=nodes[i];
        const all=toProcList(n.status);
        const shown = all.filter(p=>p && p.select===true);
        if (!n.status || all.length===0){
          TBody.insertAdjacentHTML("beforeend", `<tr class="other"><td>${nodeCellHtml(n,i,nodes.length)}</td><td colspan="4" class="muted">unreachable</td></tr>`); continue;
        }
        if (shown.length===0){
          TBody.insertAdjacentHTML("beforeend", `<tr class="other"><td>${nodeCellHtml(n,i,nodes.length)}</td><td colspan="4" class="muted">no selected processes</td></tr>`); continue;
        }
        for(const p of shown){
          const running=!!p.running;
          const conn=(p.connection_state||"").toUpperCase();
          const badge = conn==="CONNECTED" ? `<span class="pill badge-ok">CONNECTED</span>` :
                        conn==="STOPPED"   ? `<span class="pill badge-bad">STOPPED</span>` :
                        (running ? `<span class="pill badge-ok">RUNNING</span>` : `<span class="pill badge-bad">STOPPED</span>`);

          // â–¼ Version í‘œì‹œ(ì„œë²„ ì˜¤ë²„ë ˆì´ ê°’ ì‚¬ìš©)
          const verHtml = (p.version || p.version_date)
            ? `${(p.version||"-")}<br><span class="muted">${(p.version_date||"-")}</span>`
            : `<span class="muted">-<br>-</span>`;

          // â–¼ Alias ë³‘í•©: DMS(status)ì˜ alias ìš°ì„ , ì—†ìœ¼ë©´ OMS(extra.alias_map) ì‚¬ìš©
          const dmsAlias = (p.alias || "").trim();
          const omsAlias = (OMS_ALIAS_MAP[p.name] || "").trim();
          let aliasHtml = "";
          if (dmsAlias && omsAlias && dmsAlias !== omsAlias) {
            // DMS ìš°ì„  í‘œê¸°, OMSì™€ ë‹¤ë¥´ë©´ titleë¡œ ë³´ì¡° ë…¸ì¶œ
            aliasHtml = `<br><span class="muted" title="OMS alias: ${omsAlias}">${dmsAlias}</span>`;
          } else {
            const a = dmsAlias || omsAlias;
            aliasHtml = a ? `<br><span class="muted">${a}</span>` : "";
          }

          TBody.insertAdjacentHTML("beforeend", `
            <tr class="${running?'running':'other'}">
              <td>${nodeCellHtml(n,i,nodes.length)}</td>
              <td>${p.name||"-"}${aliasHtml}</td>
              <td>${verHtml}</td>
              <td>${badge}</td>
              <td>
                <button class="btn-secondary" data-a="logs"  data-node="${n.name}" data-proc="${p.name}">ğŸ“œ Logs</button>
              </td>
            </tr>`);
        }
      }
    }

    async function reloadNow(){
      try{
        if (!RA_LOCK) setBusy(true);   // ë©”ì‹œì§€ ë³€ê²½ ì—†ìŒ(ê¹œë¹¡ì„ ì œê±°)
        clearErr();
        render(await api("/oms/status"));
      }catch(e){
        showErr(e.message||e);
      }finally{
        if (!RA_LOCK) setBusy(false);
      }
    }

    BTN_RELOAD.onclick = reloadNow;
    BTN_CONFIG.onclick = ()=> location.href="oms-config.html";
    // Restart All: ì„œë²„ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° í˜¸ì¶œ â†’ SSE êµ¬ë… ì‹œì‘
    BTN_RA.onclick = async ()=>{
      RA_LOCK = true;
      stopPolling();
      clearErr(); setBusy(true);
      raWrite("Restartingâ€¦ preparing");
      try{
        await api("/oms/restart/all", {method:"POST"});
        // SSE êµ¬ë… ì‹œì‘(ìˆìœ¼ë©´ ì¬ì‹œì‘)
        startSSE();
      }catch(e){
        showErr(e.message||e);
        RA_LOCK=false; setBusy(false); startPolling(POLL_MS);
      }
    };

    document.querySelector("#grid tbody").addEventListener("click", ev=>{
      const b=ev.target.closest("button"); if(!b) return;
      if (b.dataset.a==="logs"){
        const url = `/web/log-viewer.html?node=${encodeURIComponent(b.dataset.node)}&name=${encodeURIComponent(b.dataset.proc)}`;
        window.open(url,"_blank");
      }
    });

    // â”€â”€ SSE & í´ë°± í´ë§
    let evtSrc=null, sseTimer=null, statePoller=null;
    function closeSSE(){ if(evtSrc){evtSrc.close(); evtSrc=null;} if(sseTimer){clearInterval(sseTimer); sseTimer=null;} }
    function onProgressState(s){
      if (!s) return;
      if (s.message) raWrite(s.message);
      if (s.state==="done" || s.state==="error" || s.state==="idle"){
        RA_LOCK = false; setBusy(false);
        // ë§ˆì§€ë§‰ ë©”ì‹œì§€ ë‚¨ê¸°ê³  í´ë§ ì¬ê°œ
        startPolling(POLL_MS);
        closeSSE();
        if (statePoller){ clearInterval(statePoller); statePoller=null; }
        // ìµœì‹  í‘œë¡œ 1íšŒ ë°˜ì˜
        reloadNow().catch(()=>{});
      }
    }
    function startSSE(){
      closeSSE();
      if ("EventSource" in window){
        evtSrc = new EventSource("/oms/restart/stream");
        evtSrc.onmessage = (e)=>{ try{ onProgressState(JSON.parse(e.data)); }catch{} };
        evtSrc.onerror = ()=>{ /* ë„¤íŠ¸ì›Œí¬ hiccup â†’ í´ë°± í´ë§ */ startStatePolling(); };
        // SSE keepaliveê°€ ìˆë‹¤ë©´ setInterval í•„ìš” ì—†ìŒ
      } else {
        startStatePolling();
      }
    }
    function startStatePolling(){
      if (statePoller) return;
      statePoller = setInterval(async ()=>{
        try{ const s = await api("/oms/restart/state"); onProgressState(s); }catch{}
      }, 750);
    }

    // í˜ì´ì§€ ì´ˆê¸°í™”
    (async function(){
      // ê¸°ì¡´ ì¬ì‹œì‘ì´ ì„œë²„ì—ì„œ ì´ë¯¸ ëŒê³  ìˆë‹¤ë©´ ë°”ë¡œ êµ¬ë…
      try{
        const s = await api("/oms/restart/state");
        if (s && s.state === "running"){ RA_LOCK=true; setBusy(true); raWrite(s.message || "Workingâ€¦"); startSSE(); }
      }catch{}
      await reloadNow();
      startPolling(POLL_MS);
    })();
  </script>

  <!-- ì‹œí€€ìŠ¤ ëŸ¬ë„ˆ ë¡œë”© & ì´ˆê¸°í™” -->
  <script src="/web/oms-system.js" defer></script>
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      if (typeof window.initOmsSystem !== 'function') {
        console.error('initOmsSystem not found'); return;
      }
      window.initOmsSystem({});
    });
  </script>
</body>
</html>
