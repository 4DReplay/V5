<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>4DReplay V5 - OMs Config Editor</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root{
      --bg:#0b0f14; --fg:#eef2f7; --muted:#94a3b8;
      --card:#0b1220; --line:#243045; --line2:#1f2937;
      --btn:#1e40af; --btn2:#334155; --ok:#16a34a; --bad:#ef4444;
    }
    html,body{height:100%}
    body{background:var(--bg);color:var(--fg);font:14px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px}
    h2{font-size:28px;margin:0 0 12px;display:flex;align-items:center;gap:10px}
    h2 small{font-size:14px;opacity:.8}
    .toolbar{display:flex;gap:10px;align-items:center;margin:10px 0 14px}
    .toolbar .note{color:var(--muted);font-size:13px}
    button{background:var(--btn);color:#fff;border:0;border-radius:10px;padding:8px 12px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;transition:filter .2s ease}
    button:hover{filter:brightness(1.15)}
    button[disabled]{opacity:.55;cursor:not-allowed}
    .btn-ghost{background:transparent;border:1px solid var(--line);color:#e5e7eb}
    .btn-secondary{background:var(--btn2)}
    .pill{display:inline-block;border:1px solid var(--line);background:#0f172a;border-radius:999px;font-size:12px;padding:2px 10px}
    .pill-ok{border-color:var(--ok);color:#a7f3d0;background:#0d3b1a}
    .pill-bad{border-color:var(--bad);color:#fecaca;background:#3b0d0d}
    table{border-collapse:collapse;width:100%;max-width:1300px}
    th,td{border:1px solid var(--line2);padding:4px 6px;vertical-align:middle}
    th{background:#0f172a;text-align:left;position:sticky;top:0}
    tbody tr:nth-child(odd){background:#0c121b}
    input[type="text"], input[type="number"], textarea, select{
      width:100%;box-sizing:border-box;background:#0b1220;color:#e5e7eb;border:1px solid var(--line);
      border-radius:6px;padding:4px 6px;font:13px ui-monospace,monospace;
    }
    textarea{height:36px;resize:none}
    .col-btns{white-space:nowrap}
    .muted{color:var(--muted)}
    .right{margin-left:auto}
    .global-settings{margin:14px 0;padding:10px;background:#0c121b;border:1px solid var(--line2);border-radius:8px;max-width:600px}
    .global-settings label{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .global-settings input{flex:1}
  </style>
</head>
<body>
  <h2>
    <span>4DReplay V5 - OMs Config Editor</span>
    <small id="titleHost"></small>
  </h2>

  <div class="toolbar">
    <button id="btnGoDashboard" class="btn-secondary" title="Back to OMS Control">🧭 OMS Control</button>
    <button id="btnReload" class="btn-secondary">🔄 Reload</button>
    <button id="btnFormat" class="btn-ghost">🧹Format</button>
    <button id="btnAdd" class="btn-ghost">➕ Add</button>
    <button id="btnSave">💾 Save</button>
    <span id="saveState" class="pill">Idle</span>
    <span class="right note">
      File: <span id="metaPath">-</span> (<span id="metaSize">-</span> bytes, mtime <span id="metaMtime">-</span>)
      • Agent heartbeat: <span id="hb">-</span>s
    </span>
  </div>

  <!-- ───── Global Settings Section ───── -->
  <div class="global-settings">
    <h3 style="margin-top:0;color:#a5b4fc;">Global Settings</h3>
    <label>HTTP Host: <input id="inputHttpHost" type="text" placeholder="0.0.0.0"></label>
    <label>HTTP Port: <input id="inputHttpPort" type="number" placeholder="52050" min="1" max="65535"></label>
    <label>Heartbeat Interval (sec): <input id="inputHeartbeat" type="number" placeholder="3" min="1" max="60"></label>
  </div>

  <table id="grid">
    <thead>
      <tr>
        <th>Name</th>
        <th>Alias</th>
        <th>Host</th>
        <th>Port</th>
        <th class="col-btns">Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- ───── Tip Section ───── -->
  <p class="muted" style="margin-top:10px">
    Tip: <b>Heartbeat Interval (sec)</b> changes apply immediately; <b>HTTP Port</b> changes require a service restart.
  </p>

<script>
/* ───── API core ───── */
async function api(path, method="GET", body=null){
  const opt = { method, cache:"no-store", headers:{} };
  if (body !== null){
    if (typeof body === "string"){ opt.headers["Content-Type"]="text/plain; charset=utf-8"; opt.body=body; }
    else { opt.headers["Content-Type"]="application/json"; opt.body=JSON.stringify(body); }
  }
  const r = await fetch(path, opt);
  const ct = r.headers.get("content-type") || "";
  const isJson = ct.includes("application/json");
  if (!r.ok){
    let msg = r.statusText;
    try{ msg = isJson ? (await r.json()).error || r.statusText : await r.text(); }catch{}
    throw new Error(msg || `HTTP ${r.status}`);
  }
  return isJson ? await r.json() : await r.text();
}

async function saveConfigText(text){
  try {
    return await api("/config","POST",text);
  } catch (e){
    const m = String(e.message||"").toLowerCase();
    if (m.includes("not found") || m.includes("404")){
      return await api("/oms/config","POST",text);
    }
    throw e;
  }
}

async function getWithFallback(primary,fallback,method="GET",body=null){
  try{ return await api(primary,method,body); }
  catch(e){
    const m = String(e.message||"").toLowerCase();
    if (m.includes("not found") || m.includes("404")){
      return await api(fallback,method,body);
    }
    throw e;
  }
}

/* ───── DOM ───── */
const TBody=document.querySelector("#grid tbody");
const SaveTag=document.getElementById("saveState");
const HB_EL=document.getElementById("hb");
const M_PATH=document.getElementById("metaPath");
const M_SIZE=document.getElementById("metaSize");
const M_TIME=document.getElementById("metaMtime");
const TITLE=document.getElementById("titleHost");
if(TITLE) TITLE.textContent=`(${location.hostname||"-"})`;

/* ───── endpoints ───── */
const EP={
  status:()=>getWithFallback(`/status`,`/oms/status`),
  config:()=>getWithFallback(`/config`,`/oms/config`),
  configMeta:()=>getWithFallback(`/config/meta`,`/oms/config/meta`),
  configFormat:(t)=>getWithFallback(`/config/format`,`/oms/config/format`,"POST",t),
  saveConfig:(t)=>getWithFallback(`/config`,`/oms/config`,"POST",t),
  apply: () => getWithFallback(`/config/apply`, `/oms/config/apply`, "POST", {}),
}

/* ───── state ───── */
let CONFIG=null; let POLL=null; let POLL_MS=1500; let IS_SAVING=false;

/* ───── helpers ───── */
function ensureOmsShape(cfg){
  cfg=cfg||{};
  if(!Array.isArray(cfg.nodes)) cfg.nodes=[];
  cfg.nodes=cfg.nodes.map(n=>({name:n?.name??"",alias:n?.alias??"",host:n?.host??"",port:Number(n?.port??51050)}));
  return cfg;
}
function uniqueNodeName(base){
  const used=new Set((CONFIG.nodes||[]).map(n=>n.name));
  if(!used.has(base)) return base;
  let i=2; while(used.has(`${base}_${i}`)) i++; return `${base}_${i}`;
}
function touchDirty(text="Edited"){SaveTag.textContent=text;SaveTag.className="pill";}

/* ───── UI Render ───── */
function rowNode(node,idx){
  const tr=document.createElement("tr");
  tr.innerHTML=`
    <td><input type="text" data-k="name" value="${node.name||""}"></td>
    <td><input type="text" data-k="alias" value="${node.alias||""}"></td>
    <td><input type="text" data-k="host" value="${node.host||""}"></td>
    <td><input type="text" data-k="port" value="${node.port??51050}"></td>
    <td class="col-btns">
      <button data-a="up" class="btn-ghost">▲</button>
      <button data-a="down" class="btn-ghost">▼</button>
      <button data-a="dup" class="btn-ghost">Duplicate</button>
      <button data-a="del" class="btn-secondary">Delete</button>
    </td>`;
  tr.addEventListener("change",ev=>{
    const t=ev.target,k=t.getAttribute("data-k"); if(!k)return;
    let v=t.value; if(k==="port") v=Math.max(1,parseInt(v||"51050",10));
    CONFIG.nodes[idx][k]=v; touchDirty("Edited");
  });
  tr.addEventListener("click",ev=>{
    const b=ev.target.closest("button"); if(!b)return;
    const a=b.getAttribute("data-a"),arr=CONFIG.nodes;
    if(a==="up"&&idx>0){[arr[idx-1],arr[idx]]=[arr[idx],arr[idx-1]];render();}
    else if(a==="down"&&idx<arr.length-1){[arr[idx+1],arr[idx]]=[arr[idx],arr[idx+1]];render();}
    else if(a==="dup"){const copy=JSON.parse(JSON.stringify(arr[idx]));copy.name=uniqueNodeName(copy.name||"NewNode");arr.splice(idx+1,0,copy);render();}
    else if(a==="del"){if(confirm("Delete this node?")){arr.splice(idx,1);render();}}
  });
  return tr;
}

function render(){
  CONFIG=ensureOmsShape(CONFIG);
  document.getElementById("inputHttpHost").value=CONFIG.http_host||"0.0.0.0";
  document.getElementById("inputHttpPort").value=CONFIG.http_port||52050;
  document.getElementById("inputHeartbeat").value=CONFIG.heartbeat_interval_sec||3;
  TBody.innerHTML="";
  CONFIG.nodes.forEach((n,i)=>TBody.appendChild(rowNode(n,i)));
}

/* ───── meta & heartbeat ───── */
async function loadMeta(){
  try{
    const m=await EP.configMeta();
    if(m&&typeof m==="object"){
      M_PATH.textContent=m.path||"-";M_SIZE.textContent=String(m.size??"-");M_TIME.textContent=m.mtime||"-";
    }
  }catch{M_PATH.textContent="(meta error)";}
}
async function loadHeartbeat(){
  try{
    const s=await EP.status();
    const hb=Number(s&&s.heartbeat_interval_sec);
    if(!isNaN(hb)&&hb>0){HB_EL.textContent=hb;const next=Math.max(1000,Math.floor(hb*1000));if(next!==POLL_MS){POLL_MS=next;restartPolling();}}
  }catch{HB_EL.textContent="-";}
}
function restartPolling(){if(POLL){clearInterval(POLL);POLL=null;}POLL=setInterval(()=>Promise.allSettled([loadMeta(),loadHeartbeat()]),POLL_MS);}

/* ───── load/save/format ───── */
async function loadConfigObj(){
  const raw=await EP.config();
  if(typeof raw==="string"){try{return JSON.parse(raw);}catch{const fm=await EP.configFormat(raw).catch(()=>null);return fm&&fm.text?JSON.parse(fm.text):JSON.parse(raw);}}
  return raw;
}
async function saveConfig(){
  if(IS_SAVING)return;
  IS_SAVING=true;
  try{
    CONFIG.http_host=document.getElementById("inputHttpHost").value||"0.0.0.0";
    CONFIG.http_port=parseInt(document.getElementById("inputHttpPort").value||"52050",10);
    CONFIG.heartbeat_interval_sec=parseFloat(document.getElementById("inputHeartbeat").value||"3");
    const txt=JSON.stringify(CONFIG,null,2);
    const res=await saveConfigText(txt);
    await EP.apply(); // ← 런타임 적용 트리거
    SaveTag.textContent="Saved";SaveTag.className="pill pill-ok";

    await reloadConfig();await loadMeta();
  }catch(e){
    alert("Save failed: "+(e.message||e));SaveTag.textContent="Save failed";SaveTag.className="pill pill-bad";
  }finally{IS_SAVING=false;}
}
async function reloadConfig(){
  SaveTag.textContent="Loading...";SaveTag.className="pill";
  CONFIG=await loadConfigObj();CONFIG=ensureOmsShape(CONFIG);
  render();SaveTag.textContent="Loaded";SaveTag.className="pill";
  await Promise.allSettled([loadMeta(),loadHeartbeat()]);
}

/* ───── buttons ───── */
document.getElementById("btnGoDashboard").addEventListener("click",()=>{location.href="oms-control.html";});
document.getElementById("btnReload").addEventListener("click",reloadConfig);
document.getElementById("btnFormat").addEventListener("click",async()=>{
  const txt=JSON.stringify(CONFIG);
  try{const r=await EP.configFormat(txt);if(r&&r.text)CONFIG=JSON.parse(r.text);}catch{}
  render();touchDirty("Formatted");
});
document.getElementById("btnAdd").addEventListener("click",()=>{
  CONFIG=ensureOmsShape(CONFIG);
  CONFIG.nodes.push({name:uniqueNodeName("DMS-NEW"),alias:"",host:"",port:51050});
  render();touchDirty("Edited");
});
document.getElementById("btnSave").addEventListener("click",(ev)=>{ev.preventDefault();saveConfig();});

/* ───── init ───── */
(async function init(){await reloadConfig();})();

 
</script>
</body>
</html>
