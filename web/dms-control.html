<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>4DReplay V5 - DMs Dashboard</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root{
      --bg:#0b0f14; --fg:#eef2f7; --muted:#94a3b8;
      --card:#0b1220; --line:#1f2937; --line2:#243045;
      --ok:#16a34a; --bad:#ef4444; --off:#52525b;
      --btn:#1e40af; --btn2:#334155;
    }
    body{background:var(--bg);color:var(--fg);font:14px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px}
    h2{font-size:32px;margin:0 0 14px;display:flex;align-items:center;gap:8px}
    h2 small{font-size:14px;opacity:.8}
    .toolbar{display:flex;gap:10px;margin:8px 0 16px;align-items:center;flex-wrap:wrap}
    .toolbar small{opacity:.8;margin-left:8px}
    button{background:var(--btn);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
    button.btn-secondary{background:var(--btn2)}
    button:hover{opacity:.92}
    button[disabled]{opacity:.6;cursor:not-allowed}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid var(--line2);padding:10px}
    th{background:#0f172a;text-align:left}
    tr.running{background:#06220a}
    tr.stopped{background:#1b0f0f}
    tr.disabled{background:#111827}
    .pill{display:inline-block;padding:3px 10px;border-radius:14px;font-size:12px;border:1px solid}
    .ok{background:#0d3b1a;border-color:#16a34a;color:#a7f3d0}
    .bad{background:#3b0d0d;border-color:#ef4444;color:#fecaca}
    .off{background:#27272a;border-color:#52525b;color:#d4d4d8}
    .select-cell{display:flex;gap:6px;align-items:center}
    .namecell small{opacity:.8}
    #err{display:none;margin:8px 0;padding:10px;border-radius:8px;background:#3b0d0d;border:1px solid #ef4444;color:#ffe0e0;white-space:pre-wrap}
    /* ‚úÖ ÏïÑÎûò Î∂ÄÎ∂Ñ ÏÉàÎ°ú Ï∂îÍ∞Ä */
    button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: filter 0.2s ease;
    }
    button:hover {
      filter: brightness(1.15);
    }
  </style>
</head>

<body>
  <h2>
    <span>4DReplay V5 - DMs Dashboard</span>
    <small id="titleHost"></small>
  </h2>

  <div class="toolbar">
    <button id="btnOpenConfig" class="btn-secondary" title="Open configuration editor">
  üìù Config Editor
    </button>
    <button id="btnStartAll">‚ñ∂Ô∏è Start All</button>
    <button id="btnStopAll">‚èπ Stop All</button>
    <button id="btnRestartAll">üîÅ Restart All</button>
    <small id="bulkStatus"></small>
  </div>

  <div id="err"></div>

  <table id="tbl">
    <thead>
      <tr>
        <th style="width:100px">Select</th>
        <th>Name / Alias</th>
        <th>Exe</th>
        <th>PID</th>
        <th>Status</th>
        <th>Last RC</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p style="margin-top:8px;color:#94a3b8">Auto refresh: <span id="beat">-</span></p>

  <!-- Í∞ÑÎã® Config ÏóêÎîîÌÑ∞ ÌÜ†Í∏Ä ÏòÅÏó≠ -->
  <div id="cfgBox" style="display:none;margin-top:12px">
    <div style="opacity:.8;margin-bottom:6px">Editing <code>config/dms_config.json5</code></div>
    <textarea id="cfgText" style="width:100%;height:50vh;background:#0b1220;color:#e5e7eb;border:1px solid #243045;border-radius:8px;font-family:ui-monospace,monospace;font-size:13px;padding:10px"></textarea>
    <div style="margin-top:8px;display:flex;gap:8px">
      <button id="btnCfgReload" class="btn-secondary">Reload</button>
      <button id="btnCfgSave">Save</button>
    </div>
  </div>

<script>
/* ---------- Ìó§Îçî Ìò∏Ïä§Ìä∏ ÌëúÍ∏∞ ---------- */
(function(){
  try{
    const host=(window.DASHBOARD_HOST&&String(window.DASHBOARD_HOST).trim())||(location&&location.hostname)||"";
    const el=document.getElementById("titleHost"); if(el&&host) el.textContent=`(${host})`;
  }catch(_){}
})();

/* ---------- Í≥µÌÜµ API ---------- */
const ERR = document.getElementById("err");
function showErr(msg){ ERR.style.display="block"; ERR.textContent=String(msg||""); }
function clearErr(){ ERR.style.display="none"; ERR.textContent=""; }

async function api(path,method="GET",body=null){
  const opt={method,cache:"no-store",headers:{}};
  if(body!==null){
    if(typeof body==="string"){ opt.headers["Content-Type"]="text/plain; charset=utf-8"; opt.body=body; }
    else { opt.headers["Content-Type"]="application/json"; opt.body=JSON.stringify(body); }
  }
  const r=await fetch(path,opt);
  if(!r.ok){
    let txt=""; try{ txt=await r.text(); }catch{}
    throw new Error(txt || r.statusText || `HTTP ${r.status}`);
  }
  const ct=r.headers.get("content-type")||"";
  return ct.includes("application/json")?r.json():r.text();
}


/* ---------- ÏóòÎ¶¨Î®ºÌä∏ ---------- */
const TBL_BODY=document.querySelector("#tbl tbody"),
      BEAT=document.querySelector("#beat"),
      BULK=document.querySelector("#bulkStatus"),
      BTN_START_ALL=document.querySelector("#btnStartAll"),
      BTN_STOP_ALL=document.querySelector("#btnStopAll"),
      BTN_RESTART_ALL=document.querySelector("#btnRestartAll"),
      BTN_OPEN_CFG=document.querySelector("#btnOpenConfig"),
      CFG_BOX=document.querySelector("#cfgBox"),
      CFG_TEXT=document.querySelector("#cfgText"),
      BTN_CFG_RELOAD=document.querySelector("#btnCfgReload"),
      BTN_CFG_SAVE=document.querySelector("#btnCfgSave");

let CONFIG=null;
let STATUS_MAP={};  // name -> status row

/* ---------- ÏÑ§Ï†ï Î°úÎìú/Ï†ÄÏû• ---------- */
async function loadConfigText(){ return api("/config","GET"); }
async function saveConfigText(text){ return api("/config","POST",text); } // AgentÎäî POST Ï†ÄÏû•ÏúºÎ°ú Íµ¨ÌòÑÎê®
async function loadConfigObj(){
  const txt=await loadConfigText();
  // JSON5Í∞Ä ÏÑûÏó¨ÏûàÏùÑ Ïàò ÏûàÏúºÎØÄÎ°ú ÏÑúÎ≤Ñ Ìè¨Îß§ÌÑ∞ ÏÇ¨Ïö©
  const res=await api("/config-format","POST",txt);   // ‚òÖ Ïó¨Í∏∞! /config-format ÏúºÎ°ú Í≥†Ï†ï
  return JSON.parse(res.text);
}

/* ---------- ÏÉÅÌÉú Î°úÎìú ---------- */
async function loadStatus(){
  const j = await api("/status","GET");
  const itemsObj = j.data || {};               // ÏÑúÎ≤ÑÎäî { EMd:{‚Ä¶}, MTd:{‚Ä¶}, ‚Ä¶ } ÌòïÌÉú
  const items = Object.values(itemsObj);       // ‚Üê Î∞∞Ïó¥Î°ú Î≥ÄÌôò
  STATUS_MAP = {};
  for (const a of items) STATUS_MAP[a.name] = a;
  // Ìè¥ÎßÅ Ï£ºÍ∏∞ÎèÑ Î∞òÏòÅ
  if (typeof j.heartbeat_interval_sec !== "undefined") {
    const hb = Number(j.heartbeat_interval_sec);
    if (!Number.isNaN(hb) && hb > 0) { POLL_MS = Math.max(1000, Math.floor(hb*1000)); }
  }
}


function mergedItem(exe){
  const st = STATUS_MAP[exe.name] || {};
  return {
    name: exe.name,
    alias: exe.alias || st.alias || "",
    exe:  exe.path || st.path || st.exe || "",
    pid:  st.pid ?? "-",
    running: !!st.running,
    select: exe.select === true,
    last_rc: (st.last_rc ?? st.last_exit_code) ?? "-"
  };
}

function rowFromStatus(item){
  const tr = document.createElement("tr");
  tr.className = item.select ? (item.running ? "running" : "stopped") : "disabled";
  const statusHtml = item.select
    ? (item.running ? '<span class="pill ok">RUNNING</span>' : '<span class="pill bad">STOPPED</span>')
    : '<span class="pill off">DISABLED</span>';
  const exeShort = (item.exe||"").split(/[\\/]/).slice(-2).join("/");

  tr.innerHTML = `
    <td class="select-cell">
      <input type="checkbox" data-a="toggle-select" data-n="${item.name}" ${item.select?"checked":""}/>
      <span>${item.select?"on":"off"}</span>
    </td>
    <td class="namecell"><strong>${item.name}</strong><br><small>${item.alias}</small></td>
    <td title="${item.exe}">${exeShort}</td>
    <td>${item.pid}</td>
    <td>${statusHtml}</td>
    <td>${item.last_rc}</td>
    <td>
      <button data-a="start"   data-n="${item.name}" ${item.select?"":"disabled"}>Start</button>
      <button data-a="stop"    data-n="${item.name}">Stop</button>
      <button data-a="restart" data-n="${item.name}" ${item.select?"":"disabled"}>Restart</button>
      <!-- ‚úÖ Î°úÍ∑∏ Î≤ÑÌäº -->
    <button data-a="logs"    data-n="${item.name}" class="btn-secondary" title="Open logs">üìú Logs</button>
    </td>`;
  return tr;
}

/* ---------- Î†åÎçî ---------- */
function rowFromConfig(cfgExec){
  const status=STATUS_MAP[cfgExec.name]||{};
  const isSelected = cfgExec.select===true;
  const running = !!status.running;
  const lastRc = (status.last_rc??status.last_exit_code)??"-";
  const pid = status.pid ?? "-";
  const exePath = (cfgExec.path||status.path||status.exe||"");
  const exeShort = exePath.split(/[\\/]/).slice(-2).join("/");
  const alias = cfgExec.alias || status.alias || "";

  const tr=document.createElement("tr");
  tr.className = isSelected ? (running?"running":"stopped") : "disabled";

  const statusHtml = isSelected
    ? (running?'<span class="pill ok">RUNNING</span>':'<span class="pill bad">STOPPED</span>')
    : '<span class="pill off">DISABLED</span>';

  tr.innerHTML = `
    <td class="select-cell">
      <input type="checkbox" data-a="toggle-select" data-n="${cfgExec.name}" ${isSelected?"checked":""}/>
      <span>${isSelected?"on":"off"}</span>
    </td>
    <td class="namecell">
      <strong>${cfgExec.name}</strong><br><small>${alias}</small>
    </td>
    <td title="${exePath}">${exeShort}</td>
    <td>${pid}</td>
    <td>${statusHtml}</td>
    <td>${lastRc}</td>
    <td>
      <button data-a="start" data-n="${cfgExec.name}" ${isSelected?"":"disabled"}>Start</button>
      <button data-a="stop" data-n="${cfgExec.name}">Stop</button>
      <button data-a="restart" data-n="${cfgExec.name}" ${isSelected?"":"disabled"}>Restart</button>
    </td>`;
  return tr;
}

function render(){
  TBL_BODY.innerHTML = "";
  const execs = (CONFIG?.executables) || [];
  execs.forEach(exe => {
    const item = mergedItem(exe);
    TBL_BODY.appendChild(rowFromStatus(item));
  });
}

/* ---------- Ïù¥Î≤§Ìä∏ ---------- */
TBL_BODY.addEventListener("click", async (ev)=>{
  const btn=ev.target.closest("button");
  const chk=ev.target.closest("input[type=checkbox][data-a=toggle-select]");
  if(chk){
    clearErr();
    const name=chk.dataset.n;
    try{
      const execs=CONFIG.executables||[];
      const target=execs.find(x=>x.name===name);
      if(target){ target.select = chk.checked; }
      const fmt=await api("/config-format","POST", JSON.stringify(CONFIG));
      await saveConfigText(fmt.text);
      CONFIG = await loadConfigObj();
      await loadStatus();
      render();
    }catch(e){ showErr("Select update failed: "+(e.message||e)); }
    return;
  }
  if(!btn) return;
  const act=btn.dataset.a, name=btn.dataset.n;
  // ‚úÖ logsÎäî POST ÎÇ†Î¶¨ÏßÄ ÎßêÍ≥† Î™®Îã¨ Ïó¥Í∏∞
  if (act === "logs") {
    const name = btn.dataset.n || btn.dataset.name; // data-n / data-name Îëò Îã§ ÎåÄÏùë
    if (!name) return;
    location.href = `/web/log-viewer.html?name=${encodeURIComponent(name)}&tail=50000`;
    return;
  }
  try{
    clearErr();
    await api(`/${act}/${encodeURIComponent(name)}`,"POST");
  }catch(e){ showErr(`${act.toUpperCase()} failed: `+(e.message||e)); }
  await loadStatus();
  render();
});

/* ---------- Ï†ÑÏ≤¥ Ï†úÏñ¥ ---------- */
function setBulkBusy(busy,msg=""){
  [BTN_START_ALL,BTN_STOP_ALL,BTN_RESTART_ALL,BTN_OPEN_CFG].forEach(b=>b.disabled=busy);
  BULK.textContent=msg;
}
async function doBulk(action, onlySelected=true){
  clearErr();
  const execs=CONFIG.executables||[];
  const targets=execs.filter(e=>onlySelected?e.select===true:true).map(e=>e.name);
  if(!targets.length){ BULK.textContent="No targets."; return; }
  setBulkBusy(true, `${action.toUpperCase()}... (0/${targets.length})`);
  let ok=0, fail=0;
  for(let i=0;i<targets.length;i++){
    try{ await api(`/${action}/${encodeURIComponent(targets[i])}`,"POST"); ok++; }
    catch(e){ fail++; showErr(`${action.toUpperCase()} ${targets[i]} failed:\n${e.message||e}`); }
    setBulkBusy(true, `${action.toUpperCase()}... (${i+1}/${targets.length})`);
  }
  setBulkBusy(false, `${action.toUpperCase()} done: ${ok} ok, ${fail} failed`);
  await loadStatus(); render();
}
BTN_START_ALL.addEventListener("click", ()=>doBulk("start", true));
BTN_STOP_ALL.addEventListener("click",  ()=>doBulk("stop",  true));
BTN_RESTART_ALL.addEventListener("click",()=>doBulk("restart", true));

/* ---------- Config ÌÜ†Í∏Ä ---------- */
BTN_OPEN_CFG.addEventListener("click", ()=>{
  location.href = "/dms-config.html";
});

BTN_CFG_RELOAD.addEventListener("click", async ()=>{
  clearErr();
  try{ CFG_TEXT.value = await loadConfigText(); }
  catch(e){ showErr("Reload failed: "+(e.message||e)); }
});
BTN_CFG_SAVE.addEventListener("click", async ()=>{
  clearErr();
  try{
    await saveConfigText(CFG_TEXT.value);
    CONFIG = await loadConfigObj();
    render();
    alert("Saved");
  }catch(e){ showErr("Save failed: "+(e.message||e)); }
});

/* ---------- Ï£ºÍ∏∞ Í∞±Ïã† ---------- */
async function tick(){
  try{
    clearErr();
    if(!CONFIG) CONFIG = await loadConfigObj();
    await loadStatus();
    render();
  }catch(e){
    BEAT.textContent="-";
    showErr("Tick failed: "+(e.message||e));
  }
}
tick();
setInterval(tick, 1500);
</script>
<!-- ‚úÖ Log Viewer Modal -->
<div id="logModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:9999;">
  <div style="position:absolute; top:6%; left:50%; transform:translateX(-50%); width:min(1100px, 92vw); background:#0b1220; border:1px solid #243045; border-radius:12px; box-shadow:0 10px 50px rgba(0,0,0,.6);">
    <div style="display:flex; align-items:center; gap:10px; padding:12px 14px; border-bottom:1px solid #243045;">
      <strong id="logTitle" style="font-size:16px;">Logs</strong>
      <div class="right" style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <label style="display:flex; gap:6px; align-items:center;">
          Date
          <select id="logDate" class="btn-secondary" style="height:32px; padding:0 8px; border-radius:8px;"></select>
        </label>
        <label style="display:flex; gap:6px; align-items:center;">
          Tail
          <select id="logTail" class="btn-secondary" style="height:32px; padding:0 8px; border-radius:8px;">
            <option value="10000">10 KB</option>
            <option value="20000" selected>20 KB</option>
            <option value="50000">50 KB</option>
            <option value="200000">200 KB</option>
          </select>
        </label>
        <label style="display:flex; gap:6px; align-items:center;">
          <input type="checkbox" id="logAuto" /> Auto refresh (2s)
        </label>
        <button id="logRefresh" class="btn-secondary" title="Reload">üîÑ Refresh</button>
        <button id="logClose" title="Close">‚úñ Close</button>
      </div>
    </div>
    <pre id="logText" style="margin:0; padding:12px 14px; max-height:70vh; overflow:auto; font:13px ui-monospace, monospace; white-space:pre-wrap; color:#e5e7eb; background:#0b1220;"></pre>
    <div style="padding:8px 14px; border-top:1px solid #243045; color:#94a3b8; font-size:12px;">
      <span id="logMeta"></span>
    </div>
  </div>
</div>
</body>
</html>
