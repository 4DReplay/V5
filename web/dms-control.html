<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>4DReplay DMs Dashboard</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    body{background:#0b0f14;color:#eef2f7;font:14px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px}
    h2{font-size:28px;margin:0 0 16px}
    table{border-collapse:collapse;width:100%;max-width:1080px}
    th,td{border:1px solid #1f2937;padding:10px}
    th{background:#0f172a;text-align:left}
    tr.running{background:#06220a} tr.stopped{background:#1b0f0f}
    .pill{display:inline-block;padding:2px 10px;border-radius:14px;font-size:12px}
    .ok{background:#0d3b1a;border:1px solid #16a34a;color:#a7f3d0}
    .bad{background:#3b0d0d;border:1px solid #ef4444;color:#fecaca}
    button{background:#1e40af;color:#fff;border:0;border-radius:8px;padding:6px 10px;cursor:pointer}
    button:hover{opacity:.9}
  </style>
</head>
<body>
  <h2>4DReplay DMs Dashboard</h2>
  <table id="tbl">
    <thead>
      <tr><th>Name</th><th>Exe</th><th>PID</th><th>Status</th><th>Last RC</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <p style="margin-top:8px;color:#94a3b8">Auto refresh: <span id="beat">-</span></p>
<script>
const TBL=document.querySelector("#tbl tbody"),BEAT=document.querySelector("#beat");
async function api(path,method="GET"){
  const r=await fetch(path,{method,cache:"no-store"});
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
function row(app){
  const tr=document.createElement("tr"); tr.className=app.running?"running":"stopped";
  const exe = (app.path || app.exe || "").split(/[\\/]/).slice(-2).join("/");
  tr.innerHTML=`<td>${app.name}</td>
<td title="${app.path||app.exe}">${exe}</td>
<td>${app.pid??"-"}</td>
<td>${app.running?'<span class="pill ok">RUNNING</span>':'<span class="pill bad">STOPPED</span>'}</td>
<td>${(app.last_rc??app.last_exit_code)??"-"}</td>
<td>
  <button data-a="start" data-n="${app.name}">Start</button>
  <button data-a="stop" data-n="${app.name}">Stop</button>
  <button data-a="restart" data-n="${app.name}">Restart</button>
</td>`;
  return tr;
}
async function refresh(){
  try{
    const j=await api("/status");
    const items = j.data || {};
    TBL.innerHTML="";
    Object.values(items).forEach(app=>TBL.appendChild(row(app)));
    BEAT.textContent=new Date().toLocaleTimeString();
  }catch(e){ BEAT.textContent="ERR: "+e; }
}
TBL.addEventListener("click",async(ev)=>{
  const b=ev.target.closest("button"); if(!b) return;
  const act=b.dataset.a, name=b.dataset.n;
  try{ await api(`/${act}/${encodeURIComponent(name)}`,"POST"); }catch(e){ alert(e); }
  refresh();
});
refresh(); setInterval(refresh,3000);
</script>
</body>
</html>
