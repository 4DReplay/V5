<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>4DReplay V5 - Camera Manager</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <link rel="icon" type="image/x-icon" href="web/images/4DMain.ico">
  <!-- proxy-safe asset loader: works for /proxy/<node>/... and direct port -->
  <script>
    (function () {
      // e.g., /proxy/DMS-1/oms-system.html  =>  /proxy/DMS-1
      const m = location.pathname.match(/^\/proxy\/([^/]+)/);
      const PROXY_PREFIX = m ? "/proxy/" + encodeURIComponent(m[1]) : "";
      const bust = "?v=" + Date.now(); // cache-buster to avoid stale css/js

      const CSS_CANDIDATES = [
        PROXY_PREFIX + "/web/4d-common-style.css",
        "./4d-common-style.css",
      ];
      const JS_CANDIDATES = [
        PROXY_PREFIX + "/web/4d-common-style.js",
        "./4d-common-style.js",
      ];

      function injectCSS(list, i = 0) {
        if (i >= list.length) return;
        const el = document.createElement("link");
        el.rel = "stylesheet"; el.href = list[i] + bust;
        el.onerror = () => { console.warn("[CSS miss]", list[i]); injectCSS(list, i + 1); };
        document.head.appendChild(el);
      }
      function injectJS(list, i = 0) {
        if (i >= list.length) return;
        const el = document.createElement("script");
        el.defer = true; el.src = list[i] + bust;
        el.onerror = () => { console.warn("[JS miss]", list[i]); injectJS(list, i + 1); };
        document.head.appendChild(el);
      }
      injectCSS(CSS_CANDIDATES); injectJS(JS_CANDIDATES);
    })();
  </script>
</head>

<body>
  <!-- Title -->
  <h2 class="page-title">
    <span id="pageTitle">4DReplay V5 - Camera Manager</span>
    <small id="camStats" class="muted" style="font-size:13px;">cameras: 0 • connected: 0</small>
    <span id="pollChip" class="chip pill">poll -</span>
  </h1>
  <!-- Controls under title -->
  <div class="toolbar" style="justify-content:flex-start">
    <button id="btnRun" class="btn-secondary">🚀 Connect Cameras</button>
    <button id="btnSwAllReboot" class="btn-secondary" title="Reboot all switches">🔁 Restart Cameras</button>
    <label class="chip" style="margin-left:12px">
      <input type="checkbox" id="selAll" /> Select All Cameras
    </label>
    <small id="busy" class="muted"></small>
  </div>

  <!-- Hidden (kept for JS compatibility) -->
  <div style="display:none">
    <input id="camHost" type="text" value="127.0.0.1" />
    <input id="camPort" type="number" value="19765" />
    <input id="camMgmt" type="text" value="" />
    <button id="btnRefresh"></button>
    <small id="meta"></small>
  </div>

  <div class="panel" style="margin-top:16px">
    <h3 style="margin:0 0 6px; display:flex; align-items:center; justify-content:space-between;">
      <span>Switch Details</span>
      <span></span>
    </h3>
    <table>
      <thead>
        <tr>
          <th>IP</th>
          <th>Brand</th>
          <th>Model</th>
          <th style="width:220px">Actions</th>
        </tr>
      </thead>
      <tbody id="tblSwitch">
        <tr>
          <td colspan="4" class="muted">no data</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="panel" style="margin-top:16px">
    <h3 style="margin:0 0 6px">Camera Details</h3>
    <table>
      <thead id="theadUnified">
        <!-- JS가 pre/post 단계별로 동적으로 생성 -->
      </thead>
      <tbody id="tblUnified">
        <tr>
          <td class="muted">no data</td>
        </tr>
      </tbody>
    </table>
  </div>

  <script src="/web/oms-camera.js" defer></script>
  <!-- Common Title -->
  <script>
    (function () {
      function applyCommonConfig(cfg) {
        if (!cfg || typeof cfg !== "object") return;
        // 공통 prefix (원하면 사용)
        var appName = cfg.appName || "4DReplay";
        var version = cfg.version || "V5";
        var pageCfg = (cfg.pages && cfg.pages.omsCamera) || {};

        // 1) HTML <title>
        if (pageCfg.htmlTitle) {
          document.title = pageCfg.htmlTitle;
        } else {
          // json에 없으면 기본 규칙 사용
          document.title = appName + " " + version + " - Dashboard";
        }

        // 2) 화면 내 H1 타이틀
        var h1 = document.getElementById("pageTitle");
        if (h1 && pageCfg.pageTitle) {
          h1.textContent = pageCfg.pageTitle;
        }

        // 3) favicon (link[rel=icon] 교체)
        if (cfg.faviconHref) {
          var existing = document.querySelector('link[rel="icon"]');
          if (!existing) {
            existing = document.createElement("link");
            existing.rel = "icon";
            existing.type = "image/x-icon";
            document.head.appendChild(existing);
          }
          existing.href = cfg.faviconHref;
        }
      }

      function init() {
        // 이미 로딩돼 있으면 바로 적용
        if (window.OmsCommonConfig) {
          applyCommonConfig(window.OmsCommonConfig);
        }

        // 나중에 로딩될 수도 있으니 이벤트도 구독
        try {
          window.addEventListener("oms:config-ready", function (e) {
            applyCommonConfig(e.detail || window.OmsCommonConfig || {});
          });
        } catch (e) { /* 이벤트 미지원 브라우저면 무시 */ }
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>