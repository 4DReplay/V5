<!doctype html>
<html>

<head>
  <meta charset="utf-8" />  
  <meta http-equiv="Cache-Control" content="no-store" />  
  <!-- common title/style -->
  <script src="/web/oms-common.js"></script>
  <script>
    OMS.initAssets();             // common CSS/JS auto loading
    OMS.applyPageConfig("Camera");
    OMS.initActions();            // oms-actions.js
  </script>
</head>

<body>
  <!-- Title -->
  <h2 class="page-title">
    <span id="pageTitle"></span>
    <small id="camStats" class="muted" style="font-size:13px;">cameras: 0 • connected: 0</small>    
  </h1>

  <!-- Controls under title -->
  <div class="toolbar" id="camToolbar" style="justify-content:flex-start; flex-wrap:wrap;">
    <button id="btnDashboard">📊 Dashboard</button>
    <span class="divider"></span>

    <button id="btnCamRebootAll" class="btn-secondary">🔄 Restart</button>
    <button id="btnCamStopAll" class="btn-secondary">🛑 Turn Off</button>
    <button id="btnCamStartAll" class="btn-secondary">🟢 Turn On</button>
    <span class="divider"></span>

    <button id="btnCamConnect" class="btn-secondary">📸 Connect</button>     
    <span class="spacer"></span>
    <span class="chip" id="pollChip">poll -</span>    
    <small id="busy" class="muted"></small>
  </div>

  <!-- ✔ 버튼 아래로 이동한 message chips -->
  <div id="camChipRow" style="
       margin-top:8px;
       display:flex;
       gap:10px;
       align-items:center;
       ">
      <span id="camStateChip" class="chip chip-blue"></span>
      <span id="camMessageChip" class="chip"></span>
  </div>
  <!-- Hidden (kept for JS compatibility) -->
  <div style="display:none">
    <input id="camHost" type="text" value="127.0.0.1" />
    <input id="camPort" type="number" value="19765" />
    <input id="camMgmt" type="text" value="" />
    <button id="btnRefresh"></button>
    <small id="meta"></small>
  </div>

  <!-- Switch Detail Table -->
  <div class="panel" style="margin-top:16px">
    <h3 style="margin:0 0 6px; display:flex; align-items:center; justify-content:space-between;">
      <span>🎛️ Switch Details</span>
      <span></span>
    </h3>
    <table>
      <thead>
        <tr>
          <th>IP</th>
          <th>Brand</th>
          <th>Model</th>
          <th style="width:220px">Actions</th>
        </tr>
      </thead>
      <tbody id="tblSwitch">
        <tr>
          <td colspan="4" class="muted">no data</td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <!-- Camera Tools -->
  <div class="toolbar" style="margin-top:16px; justify-content:flex-start;">
    <button id="btnRecord" class="btn-primary">🎥 Record</button>
    <button id="btnLiveview" class="btn-primary">👁️ Liveview</button>
    <span class="divider"></span>
    <button id="btnAutoFocus" class="btn-primary">🎯 Auto Focus</button>
  </div>

  <!-- Camera Detail Table -->
  <div class="panel" style="margin-top:16px">
    <h3 style="margin:0 0 6px">📷 Camera Details</h3>
    <table>
      <thead id="theadUnified">
        <!-- JS가 pre/post 단계별로 동적으로 생성 -->
      </thead>
      <tbody id="tblUnified">
        <tr>
          <td class="muted">no data</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- UI Style -->
  <style>
    .cam-icon {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 999px;
      vertical-align: middle;
    }
    .cam-icon-connected {
      background: #22c55e; /* green */
    }
    .cam-icon-on {
      background: #eab308; /* yellow */
    }
    .cam-icon-off {
      background: #9ca3af; /* gray */
    }

    .camera-summary {
      margin-left: 8px;
      font-size: 0.9rem;
      color: #666;
    }
  </style>

  <!-- bootstrap 1 -->
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // Always init switch + camera table
    if (window.OMS?.Actions?.initSwitchDetailsFromStatus) {
      window.OMS.Actions.initSwitchDetailsFromStatus();
    }
    if (window.OMS?.Actions?.initCameraDetailsFromStatus) {
      window.OMS.Actions.initCameraDetailsFromStatus();
    }
  });
  </script>
  
  <!-- bootstrap 2 -->
  <script>
    (function bootstrap() {
      function initCameraPage() {
        const path = location.pathname || "";
        if (path.endsWith("/web/oms-camera.html") || path.endsWith("oms-camera.html")) {
          // Switch 정보 초기화 (이미 쓰고 있었다면 그대로 유지)
          if (window.OMS && window.OMS.Actions && typeof window.OMS.Actions.initSwitchDetailsFromStatus === "function") {
            window.OMS.Actions.initSwitchDetailsFromStatus();
          }
          // 🔹 Camera Details 초기화 (Unknown 상태로 채우기)
          if (window.OMS && window.OMS.Actions && typeof window.OMS.Actions.initCameraDetailsFromStatus === "function") {
            window.OMS.Actions.initCameraDetailsFromStatus();
          }
        }
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initCameraPage);        
      } else {
        initCameraPage();
      }
    })();
  </script>
  
  <!-- Polling -->
  <script>
    function renderStatusIcon(cam) {
      // 🔥 status 를 alive 기반으로 재생성
      const status = cam.alive ? "on" : "off";

      const connected = cam.connected === true ||
                        cam.connected === 1 ||
                        cam.connected === "true";

      const recording = cam.record === true ||
                        cam.record === 1 ||
                        cam.record === "true";

      // 1) RECORDING 최우선
      if (recording) {
        return '<span class="pill recording">RECORDING</span>';
      }

      // 2) CONNECTED (CCD OK)
      if (connected) {
        return '<span class="pill connected">CONNECTED</span>';
      }

      // 3) ON (ping alive)
      if (status === "on") {
        return '<span class="pill on">ON</span>';
      }

      // 4) OFF
      return '<span class="pill off">OFF</span>';
    }

    // previous camera condition
    window._prevCameraCount = window._prevCameraCount ?? null;
    window.updateCameraUI = function updateCameraUI(state, status) {
      if (!state) return;

      const cameras = Array.isArray(state.cameras) ? state.cameras : []; 
      const count = cameras.length;           
      // ★ 1) 카메라 수 변화 감지 → 테이블 전체 재빌드
      if (window._prevCameraCount !== count) {
        console.log("Camera list changed → rebuild table");
        window._prevCameraCount = count;

        if (window.OMS?.Actions?.initCameraDetailsFromStatus) {
          window.OMS.Actions.initCameraDetailsFromStatus();  
        }
      }

      // ★ 2) 카메라 수 0 → UI 초기화 (no data)
      if (count === 0) {
        const tbody = document.getElementById("tblUnified");
        tbody.innerHTML = '<tr><td class="muted">no data</td></tr>';
        return;
      }
        
      // ==== 1) Summary 갱신 ====
      const summary = state.summary || {};
      const statsSpan = document.getElementById("camStats");
      if (statsSpan) {
        const camCount = summary.cameras ?? cameras.length;
        const recCount = summary.record ?? 0;
        const connCount = summary.connected ?? 0;
        const onCount   = summary.alive ?? 0;  // alive = ping on
        const offCount  = summary.off ?? 0;

        // 🔥 요청한 최종 출력 형태
        statsSpan.textContent =
          `cameras: ${camCount} ( record: ${recCount} / connect: ${connCount} / on: ${onCount} / off: ${offCount} )`;
      }

      // ==== 2) 상세 정보 맵 ====
      // connect 이후 서버가 info 를 채워줄 경우 사용
      const detailByIp = {};
      for (const cam of cameras) {
        const ip = String(cam.IP).trim();        
        if (cam.info) {          
          detailByIp[ip] = cam.info;
        }
      }
      
      // ==== 3) Row 업데이트 ====
      const tbody = document.getElementById("tblUnified");
      if (!tbody) return;

      const rows = tbody.querySelectorAll("tr[data-ip]");
      rows.forEach(row => {
        const ip = (row.getAttribute("data-ip") || "").trim();
        if (!ip) return;

        const base = cameras.find(c => String(c.IP).trim() === ip);
        if (!base) return;  // 기본 정보가 없으면 스킵

        // ---- 상태 업데이트 ----
        const statusCell =
          row.querySelector(".col-status") ||
          row.querySelector('[data-col="status"]');
        if (statusCell) {
          statusCell.innerHTML = renderStatusIcon(base);
        }

        // ---- 상세 정보는 info 가 있을 때만 반영 ----
        const detail = detailByIp[ip];
        if (!detail) 
          return; // connect 전 → 정보 없음 → 그대로 유지

        // helper
        const setText = (sel, val) => {
          const cell = row.querySelector(sel);
          if (cell) cell.textContent = val ?? "-";
        };

        setText(".col-fw",       detail.FirmwareVersion);
        setText(".col-format",   detail.VideoFormatMain);
        setText(".col-codec",    detail.Codec);
        setText(".col-bitrate",  detail.VideoBitrateMain);
        setText(".col-gop",      detail.VideoGop);
        setText(".col-aperture", detail.Aperture);
        setText(".col-shutter",  detail.ShutterSpeed);
        setText(".col-iso",      detail.ISO);
        setText(".col-wb",       detail.WhiteBalance);
      });
    };
    window.fetchCameraState = async function fetchCameraState() {
      try {
        const [stateCamera, stateSystem] = await Promise.all([
          fetch("/oms/camera/state",  { cache: "no-store" }),
          fetch("/oms/system/state",  { cache: "no-store" })
        ]);

        const stateCam = await stateCamera.json();
        const stateSys = await stateSystem.json();

        // 기존 UI 업데이트 (카메라 테이블 갱신)
        if (window.updateCameraUI) {
          window.updateCameraUI(stateCam, stateSys);
        }

        // ★ 공통 함수 적용: Camera State + Message 칩 업데이트
        applyStateAndMessage({
          state: stateCam.state,
          message: stateCam.message,
          stateEl: document.getElementById("camStateChip"),
          messageEl: document.getElementById("camMessageChip")
        });        

      } catch (err) {
        console.error("State update failed:", err);
      }
    }

    // --- polling interval control ---
    let CAMERA_POLL_SEC = 1;
    let cameraPollTimer = null;

    function startCameraPolling() {
      if (cameraPollTimer) {
        clearInterval(cameraPollTimer);
      }
      cameraPollTimer = setInterval(fetchCameraState, CAMERA_POLL_SEC * 1000);

      const chip = document.getElementById("pollChip");
      if (chip) {
        chip.textContent = `poll ${CAMERA_POLL_SEC}s`;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Camera table DOM 생성 이후 실행
      setTimeout(() => {
        fetchCameraState();
        startCameraPolling();
      }, 200);
    });            // ← 닫는 괄호 추가
  </script>

  <!-- Connect Camera Button -->
  <script>
    (function () {
      function bindButtons() {
        // dashboard
        const btnDashboard = document.getElementById("btnDashboard");
        const m = location.pathname.match(/^\/proxy\/([^/]+)\//);
        const __PROXY_PREFIX__ = m ? "/proxy/" + encodeURIComponent(decodeURIComponent(m[1])) : "";
        if (btnDashboard) {
          btnDashboard.onclick = () => {
            const base = __PROXY_PREFIX__ || "";
            window.location.href = base + "/dashboard";
          };
        }
        // camera connect (btnCamConnect -> cameraConnectAll)
        const btnCamConnect = document.getElementById("btnCamConnect");
        if (btnCamConnect && window.OMS && window.OMS.Actions && typeof window.OMS.Actions.cameraConnectAll === "function") {
          btnCamConnect.onclick = window.OMS.Actions.cameraConnectAll;
        }
        // camera connect (btnCamStopAll -> cameraStopAll)
        const btnStopAll = document.getElementById("btnCamStopAll");
        if (btnStopAll && window.OMS && OMS.Actions.cameraStopAll) {
          btnStopAll.onclick = OMS.Actions.cameraStopAll;
        }
        // camera connect (btnCamStartAll -> cameraStartAll)
        const btnStartAll = document.getElementById("btnCamStartAll");
        if (btnStartAll && window.OMS && OMS.Actions.cameraStartAll) {
          btnStartAll.onclick = OMS.Actions.cameraStartAll;
        }
        // camera stop all (btnCamRebootAll -> cameraRebootAll)
        const btnCamRebootAll = document.getElementById("btnCamRebootAll");
        if (btnCamRebootAll && window.OMS && OMS.Actions.cameraRebootAll) {
          btnCamRebootAll.onclick = OMS.Actions.cameraRebootAll;
        }        
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", bindButtons);
      } else {
        bindButtons();
      }
    })();
  </script>

  <script>
  (function(){
    function bind(){
      // Liveview 이동
      const btnRec = document.getElementById("btnRecord");
      if(btnRec){
        btnRec.onclick = () => {
          window.location.href = "/record";
        };
      }
      // Liveview 이동
      const btnLive = document.getElementById("btnLiveview");
      if(btnLive){
        btnLive.onclick = () => {
          window.location.href = "/liveview";
        };
      }
      // Auto Focus 실행
      const btnAF = document.getElementById("btnAutoFocus");
      if (btnAF && window.OMS && OMS.Actions.autoFocus) {
        btnAF.onclick = () => OMS.Actions.autoFocus(null);   // ← PointerEvent 제거
      }
    }

    if(document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", bind);
    } else {
      bind();
    }
  })();
  </script>
  
  <script src="/web/oms-actions.js"></script>  
</body>
</html>