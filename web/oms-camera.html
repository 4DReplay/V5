<!doctype html>
<html>

<head>
  <meta charset="utf-8" />  
  <meta http-equiv="Cache-Control" content="no-store" />  
  <!-- common title/style -->
  <script src="/web/oms-common.js"></script>
  <script>
    OMS.initAssets();             // 공통 CSS/JS 자동 로딩
    OMS.applyPageConfig("Camera");
    OMS.initActions();            // oms-actions.js 자동 로딩
  </script>
</head>

<body>
  <!-- Title -->
  <h2 class="page-title">
    <span id="pageTitle"></span>
    <small id="camStats" class="muted" style="font-size:13px;">cameras: 0 • connected: 0</small>    
  </h1>

  <!-- Controls under title -->
  <div class="toolbar" style="justify-content:flex-start">
    <button id="btnDashboard">📊 Dashboard</button>
    <span class="divider"></span>

    <button id="btnCamRebootAll" class="btn-secondary">⟳ Restart All</button>
    <button id="btnCamStopAll" class="btn-secondary">■ Stop All</button>
    <button id="btnCamStartAll" class="btn-secondary">▶ Start All</button>
    <span class="divider"></span>

    <!-- Connect + progressChip -->
    <button id="btnCamConnect" class="btn-secondary">📸 Connect</button>
    <span id="progressChip" class="chip" role="status" aria-live="polite"></span>

    <span class="spacer"></span>

    <span class="chip" id="pollChip">poll -</span>    
    <small id="busy" class="muted"></small>
  </div>

  <!-- Hidden (kept for JS compatibility) -->
  <div style="display:none">
    <input id="camHost" type="text" value="127.0.0.1" />
    <input id="camPort" type="number" value="19765" />
    <input id="camMgmt" type="text" value="" />
    <button id="btnRefresh"></button>
    <small id="meta"></small>
  </div>

  <!-- Switch Detail Table -->
  <div class="panel" style="margin-top:16px">
    <h3 style="margin:0 0 6px; display:flex; align-items:center; justify-content:space-between;">
      <span>🎛️ Switch Details</span>
      <span></span>
    </h3>
    <table>
      <thead>
        <tr>
          <th>IP</th>
          <th>Brand</th>
          <th>Model</th>
          <th style="width:220px">Actions</th>
        </tr>
      </thead>
      <tbody id="tblSwitch">
        <tr>
          <td colspan="4" class="muted">no data</td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <!-- Camera Tools -->
  <div class="toolbar" style="margin-top:16px; justify-content:flex-start;">
    <button id="btnLiveview" class="btn-primary">▶ Liveview</button>
    <button id="btnAutoFocus" class="btn-primary">🎯 Auto Focus</button>
  </div>

  <!-- Camera Detail Table -->
  <div class="panel" style="margin-top:16px">
    <h3 style="margin:0 0 6px">📷 Camera Details</h3>
    <table>
      <thead id="theadUnified">
        <!-- JS가 pre/post 단계별로 동적으로 생성 -->
      </thead>
      <tbody id="tblUnified">
        <tr>
          <td class="muted">no data</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- UI Style -->
  <style>
    .cam-icon {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 999px;
      vertical-align: middle;
    }
    .cam-icon-connected {
      background: #22c55e; /* green */
    }
    .cam-icon-on {
      background: #eab308; /* yellow */
    }
    .cam-icon-off {
      background: #9ca3af; /* gray */
    }

    .camera-summary {
      margin-left: 8px;
      font-size: 0.9rem;
      color: #666;
    }
  </style>

  <script src="/web/oms-actions.js" defer></script>
  <!-- bootstrap 1 -->
  <script>
    (function bootstrap() {
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => {
          const path = location.pathname || "";
          if (path.endsWith("/web/oms-camera.html") || path.endsWith("oms-camera.html")) {
            initSwitchDetailsFromStatus();  // 이제 정상 동작
          }
        });
      } else {
        // 혹시 이미 DOM 준비된 상태에서 들어오는 경우
        const path = location.pathname || "";
        if (path.endsWith("/web/oms-camera.html") || path.endsWith("oms-camera.html")) {
          initSwitchDetailsFromStatus();
        }
      }
    })();
  </script>
  
  <!-- bootstrap 2 -->
  <script>
    (function bootstrap() {
      function initCameraPage() {
        const path = location.pathname || "";
        if (path.endsWith("/web/oms-camera.html") || path.endsWith("oms-camera.html")) {
          // Switch 정보 초기화 (이미 쓰고 있었다면 그대로 유지)
          if (window.OMS && window.OMS.Actions && typeof window.OMS.Actions.initSwitchDetailsFromStatus === "function") {
            window.OMS.Actions.initSwitchDetailsFromStatus();
          }
          // 🔹 Camera Details 초기화 (Unknown 상태로 채우기)
          if (window.OMS && window.OMS.Actions && typeof window.OMS.Actions.initCameraDetailsFromStatus === "function") {
            window.OMS.Actions.initCameraDetailsFromStatus();
          }
        }
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initCameraPage);
      } else {
        initCameraPage();
      }
    })();
  </script>
  
  <!-- Polling -->
  <script>
    function renderStatusIcon(cam) {
      const status = (cam.status || "").toString().toLowerCase();
      const connected = cam.connected === true ||
                        cam.connected === 1 ||
                        cam.connected === "true";

      // 1) ON + CONNECTED  → CONNECTED pill (oms-system 과 동일 계열)
      if (status === "on" && connected) {
        return '<span class="pill connected">CONNECTED</span>';
      }

      // 2) ON (전원은 켜져 있으나 연결 안 됨) → RUNNING 스타일과 동일한 ON
      if (status === "on") {
        // 4d-common-style.css 에서 .pill.on 이 RUNNING 계열 스타일을 사용 :contentReference[oaicite:1]{index=1}
        return '<span class="pill on">ON</span>';
      }

      // 3) 나머지는 전부 OFF → STOPPED 와 같은 디자인
      //   (4d-common-style.css 의 .pill.off 이 STOPPED 계열 스타일을 사용) :contentReference[oaicite:2]{index=2}
      return '<span class="pill off">OFF</span>';
    }

    function updateCameraUI(data) {
      if (!data || !Array.isArray(data.cameras)) return;

      const cameras = data.cameras;
      const summary = data.summary || {};
      const statsSpan = document.getElementById("camStats");

      // --- title right side with summary from backend ---
      if (statsSpan) {
        const camCount = summary.cameras != null ? summary.cameras : cameras.length;
        const connCount = summary.connected != null ? summary.connected : 0;
        const onCount   = summary.on != null ? summary.on : 0;
        const offCount  = summary.off != null ? summary.off : 0;

        statsSpan.textContent =
          `cameras: ${camCount} ( connected: ${connCount} / on: ${onCount} / off: ${offCount} )`;
      }

      const tbody = document.getElementById("tblUnified");
      if (!tbody) return;

      const camByIp = {};
      for (const cam of cameras) {
        if (cam && cam.IP) {
          camByIp[String(cam.IP).trim()] = cam;
        }
      }

      const rows = tbody.querySelectorAll("tr");
      rows.forEach((row) => {
        let ip =
          row.getAttribute("data-ip") &&
          row.getAttribute("data-ip").trim();

        if (!ip) {
          const ipCell =
            row.querySelector('[data-col="ip"]') ||
            row.querySelector(".col-ip") ||
            row.cells[1];
          if (!ipCell) return;
          ip = (ipCell.textContent || "").trim();
        }

        if (!ip) return;
        const cam = camByIp[ip];
        if (!cam) return;

        const statusCell =
          row.querySelector('[data-col="status"]') ||
          row.querySelector(".camera-status-cell") ||
          row.querySelector(".col-status") ||
          row.cells[row.cells.length - 1];

        if (!statusCell) return;

        statusCell.innerHTML = renderStatusIcon(cam);
      });
    }

    function fetchCameraState() {
      fetch("/oms/state", { cache: "no-store" })
        .then(function (res) {
          if (!res.ok) throw new Error("HTTP " + res.status);
          return res.json();
        })
        .then(function (data) {
          updateCameraUI(data);
        })
        .catch(function (err) {
          console.error("Failed to fetch /oms/state:", err);
        });
    }

    // --- polling interval control ---
    // NOTE: change this value to update polling interval (seconds)
    let CAMERA_POLL_SEC = 1;
    let cameraPollTimer = null;

    function startCameraPolling() {
      // 기존 타이머 정리
      if (cameraPollTimer) {
        clearInterval(cameraPollTimer);
      }
      cameraPollTimer = setInterval(fetchCameraState, CAMERA_POLL_SEC * 1000);

      // ✅ 버튼 모양 pollChip 텍스트 업데이트: "1 sec", "2 sec" …
      const chip = document.getElementById("pollChip");
      if (chip) {
        chip.textContent = `poll ${CAMERA_POLL_SEC}s`;
      }
    }

    // 초기 1회 실행
    fetchCameraState();
    startCameraPolling();
  </script>

  <!-- Connect Camera Button -->
  <script>
    (function () {
      function bindButtons() {
        // dashboard
        const btnDashboard = document.getElementById("btnDashboard");
        const m = location.pathname.match(/^\/proxy\/([^/]+)\//);
        const __PROXY_PREFIX__ = m ? "/proxy/" + encodeURIComponent(decodeURIComponent(m[1])) : "";
        if (btnDashboard) {
          btnDashboard.onclick = () => {
            const base = __PROXY_PREFIX__ || "";
            window.location.href = base + "/dashboard";
          };
        }
        // camera connect (btnCamConnect -> cameraConnectAll)
        const btnCamConnect = document.getElementById("btnCamConnect");
        if (btnCamConnect && window.OMS && window.OMS.Actions && typeof window.OMS.Actions.cameraConnectAll === "function") {
          btnCamConnect.onclick = window.OMS.Actions.cameraConnectAll;
        }
        // camera connect (btnCamStopAll -> cameraStopAll)
        const btnStopAll = document.getElementById("btnCamStopAll");
        if (btnStopAll && window.OMS && OMS.Actions.cameraStopAll) {
          btnStopAll.onclick = OMS.Actions.cameraStopAll;
        }
        // camera connect (btnCamStartAll -> cameraStartAll)
        const btnStartAll = document.getElementById("btnCamStartAll");
        if (btnStartAll && window.OMS && OMS.Actions.cameraStartAll) {
          btnStartAll.onclick = OMS.Actions.cameraStartAll;
        }
        // camera stop all (btnCamRebootAll -> cameraRebootAll)
        const btnCamRebootAll = document.getElementById("btnCamRebootAll");
        if (btnCamRebootAll && window.OMS && OMS.Actions.cameraRebootAll) {
          btnCamRebootAll.onclick = OMS.Actions.cameraRebootAll;
        }        
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", bindButtons);
      } else {
        bindButtons();
      }
    })();
  </script>

  <script>
  (function(){
    function sendAutoFocus(){
      fetch("/oms/cam-action/autofocus", { method: "POST" })
        .then(res => res.json())
        .then(data => {

          // 실패한 경우 처리
          if (!data.ok) {
            // detail이 없으면 data 전체를 출력
            const detail = data.detail || data.error || data || "Unknown Error";
            alert("Auto Focus Fail\n\n" + JSON.stringify(detail, null, 2));
            return;
          }

          // 성공 처리
          alert(
            `Auto Focus Finish\n\n` +
            `Success: ${data.detail.ok_count}\n` +
            `Fail: ${data.detail.fail_count}`
          );
        })
        .catch(err => {
          alert("Auto Focus Request Fail: " + err);
        });
    }

    function bind(){
      // Liveview 이동
      const btnLive = document.getElementById("btnLiveview");
      if(btnLive){
        btnLive.onclick = () => {
          window.location.href = "/liveview";
        };
      }

      // Auto Focus 실행
      const btnAF = document.getElementById("btnAutoFocus");
      if(btnAF){
        btnAF.onclick = sendAutoFocus;
      }
    }

    if(document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", bind);
    } else {
      bind();
    }
  })();
  </script>
</body>
</html>