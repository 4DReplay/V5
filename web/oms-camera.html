<!doctype html>
<html>

<head>
  <meta charset="utf-8" />  
  <meta http-equiv="Cache-Control" content="no-store" />  
  <!-- common title/style -->
  <script src="/web/oms-common.js"></script>
  <script>
    OMS.initAssets();             // common CSS/JS auto loading
    OMS.applyPageConfig("Camera");
    OMS.initActions();            // oms-actions.js
  </script>
</head>

<body>
  <!-- Title -->
  <h2 class="page-title">
    <span id="pageTitle"></span>
    <small id="camStats" class="muted" style="font-size:13px;">cameras: 0 • connected: 0</small>    
  </h1>

  <!-- Controls under title -->
  <div class="toolbar" style="justify-content:flex-start">
    <button id="btnDashboard">📊 Dashboard</button>
    <span class="divider"></span>

    <button id="btnCamRebootAll" class="btn-secondary">⟳ Restart All</button>
    <button id="btnCamStopAll" class="btn-secondary">■ Stop All</button>
    <button id="btnCamStartAll" class="btn-secondary">▶ Start All</button>
    <span class="divider"></span>

    <!-- Connect + progressChip -->
    <button id="btnCamConnect" class="btn-secondary">📸 Connect</button>
    <span id="progressChip" class="chip" role="status" aria-live="polite"></span>

    <span class="spacer"></span>

    <span class="chip" id="pollChip">poll -</span>    
    <small id="busy" class="muted"></small>
  </div>

  <!-- Hidden (kept for JS compatibility) -->
  <div style="display:none">
    <input id="camHost" type="text" value="127.0.0.1" />
    <input id="camPort" type="number" value="19765" />
    <input id="camMgmt" type="text" value="" />
    <button id="btnRefresh"></button>
    <small id="meta"></small>
  </div>

  <!-- Switch Detail Table -->
  <div class="panel" style="margin-top:16px">
    <h3 style="margin:0 0 6px; display:flex; align-items:center; justify-content:space-between;">
      <span>🎛️ Switch Details</span>
      <span></span>
    </h3>
    <table>
      <thead>
        <tr>
          <th>IP</th>
          <th>Brand</th>
          <th>Model</th>
          <th style="width:220px">Actions</th>
        </tr>
      </thead>
      <tbody id="tblSwitch">
        <tr>
          <td colspan="4" class="muted">no data</td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <!-- Camera Tools -->
  <div class="toolbar" style="margin-top:16px; justify-content:flex-start;">
    <button id="btnLiveview" class="btn-primary">▶ Liveview</button>
    <button id="btnAutoFocus" class="btn-primary">🎯 Auto Focus</button>
  </div>

  <!-- Camera Detail Table -->
  <div class="panel" style="margin-top:16px">
    <h3 style="margin:0 0 6px">📷 Camera Details</h3>
    <table>
      <thead id="theadUnified">
        <!-- JS가 pre/post 단계별로 동적으로 생성 -->
      </thead>
      <tbody id="tblUnified">
        <tr>
          <td class="muted">no data</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- UI Style -->
  <style>
    .cam-icon {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 999px;
      vertical-align: middle;
    }
    .cam-icon-connected {
      background: #22c55e; /* green */
    }
    .cam-icon-on {
      background: #eab308; /* yellow */
    }
    .cam-icon-off {
      background: #9ca3af; /* gray */
    }

    .camera-summary {
      margin-left: 8px;
      font-size: 0.9rem;
      color: #666;
    }
  </style>

  <script src="/web/oms-actions.js" defer></script>
  <!-- bootstrap 1 -->
  <script>
    (function bootstrap() {
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => {
          const path = location.pathname || "";
          if (path.endsWith("/web/oms-camera.html") || path.endsWith("oms-camera.html")) {
            initSwitchDetailsFromStatus();  // 이제 정상 동작
          }
        });
      } else {
        // 혹시 이미 DOM 준비된 상태에서 들어오는 경우
        const path = location.pathname || "";
        if (path.endsWith("/web/oms-camera.html") || path.endsWith("oms-camera.html")) {
          initSwitchDetailsFromStatus();
        }
      }
    })();
  </script>
  
  <!-- bootstrap 2 -->
  <script>
    (function bootstrap() {
      function initCameraPage() {
        const path = location.pathname || "";
        if (path.endsWith("/web/oms-camera.html") || path.endsWith("oms-camera.html")) {
          // Switch 정보 초기화 (이미 쓰고 있었다면 그대로 유지)
          if (window.OMS && window.OMS.Actions && typeof window.OMS.Actions.initSwitchDetailsFromStatus === "function") {
            window.OMS.Actions.initSwitchDetailsFromStatus();
          }
          // 🔹 Camera Details 초기화 (Unknown 상태로 채우기)
          if (window.OMS && window.OMS.Actions && typeof window.OMS.Actions.initCameraDetailsFromStatus === "function") {
            window.OMS.Actions.initCameraDetailsFromStatus();
          }
        }
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initCameraPage);
      } else {
        initCameraPage();
      }
    })();
  </script>
  
  <!-- Polling -->
  <script>
    function renderStatusIcon(cam) {
      const status = (cam.status || "").toString().toLowerCase();
      const connected = cam.connected === true ||
                        cam.connected === 1 ||
                        cam.connected === "true";

      // 1) ON + CONNECTED  → CONNECTED pill (oms-system 과 동일 계열)
      if (status === "on" && connected) {
        return '<span class="pill connected">CONNECTED</span>';
      }

      // 2) ON (전원은 켜져 있으나 연결 안 됨) → RUNNING 스타일과 동일한 ON
      if (status === "on") {
        // 4d-common-style.css 에서 .pill.on 이 RUNNING 계열 스타일을 사용 :contentReference[oaicite:1]{index=1}
        return '<span class="pill on">ON</span>';
      }

      // 3) 나머지는 전부 OFF → STOPPED 와 같은 디자인
      //   (4d-common-style.css 의 .pill.off 이 STOPPED 계열 스타일을 사용) :contentReference[oaicite:2]{index=2}
      return '<span class="pill off">OFF</span>';
    }

    window.updateCameraUI = function updateCameraUI(state, status) {
      if (!state) return;

      const baseList = Array.isArray(state.cameras) ? state.cameras : [];
      // 항상 /oms/state 에 있는 info 기반으로 사용
      let detailList = [];
      if (state && Array.isArray(state.cameras)) {
        detailList = state.cameras.map(c => {
          const info = c.info || {};
          return {
            IP: c.IP,
            FirmwareVersion: info.FirmwareVersion,
            VideoFormatMain: info.VideoFormatMain,
            Codec: info.Codec,
            VideoGop: info.VideoGop,
            VideoBitrateMain: info.VideoBitrateMain,
            Aperture: info.Aperture,
            ShutterSpeed: info.ShutterSpeed,
            ISO: info.ISO,
            WhiteBalance: info.WhiteBalance,
          };
        });
      }

      // 상단 summary 갱신
      const summary = state.summary || {};
      const statsSpan = document.getElementById("camStats");
      if (statsSpan) {
        const camCount = summary.cameras ?? baseList.length;
        const connCount = summary.connected ??
          baseList.filter(c => c.connected === true || c.connected === 1 || c.connected === "true").length;
        const onCount = summary.on ??
          baseList.filter(c => String(c.status || "").toLowerCase() === "on").length;
        const offCount = summary.off ?? (camCount - onCount);

        statsSpan.textContent =
          `cameras: ${camCount} ( connected: ${connCount} / on: ${onCount} / off: ${offCount} )`;
      }

      const detailByIp = {};
      for (const c of detailList) {
        if (c && c.IP) detailByIp[String(c.IP).trim()] = c;
      }

      const tbody = document.getElementById("tblUnified");
      if (!tbody) return;

      const rows = tbody.querySelectorAll("tr[data-ip]");
      rows.forEach(row => {
        const ip = (row.getAttribute("data-ip") || "").trim();
        if (!ip) return;

        const base   = baseList.find(x => String(x.IP).trim() === ip) || {};
        const detail = detailByIp[ip];

        // Status 업데이트
        const statusCell =
          row.querySelector(".col-status") ||
          row.querySelector('[data-col="status"]');
        if (statusCell) {
          statusCell.innerHTML = renderStatusIcon(base);
        }

        if (!detail) return;

        const setText = (sel, val) => {
          const cell = row.querySelector(sel);
          if (cell) cell.textContent = (val ?? "-");
        };

        setText(".col-fw",       detail.FirmwareVersion);
        setText(".col-format",   detail.VideoFormatMain);
        setText(".col-codec",    detail.Codec);
        setText(".col-bitrate",  detail.VideoBitrateMain);
        setText(".col-gop",      detail.VideoGop);
        setText(".col-aperture", detail.Aperture);
        setText(".col-shutter",  detail.ShutterSpeed);
        setText(".col-iso",      detail.ISO);
        setText(".col-wb",       detail.WhiteBalance);
      });
    }

    window.fetchCameraState = async function fetchCameraState() {
      try {
        const [stateRes, statusRes] = await Promise.all([
          fetch("/oms/state",  { cache: "no-store" }),
          fetch("/oms/status", { cache: "no-store" })
        ]);

        const state  = await stateRes.json();
        const status = await statusRes.json();

        if (window.updateCameraUI) {
          window.updateCameraUI(state, status);
        }
      } catch (err) {
        console.error("State update failed:", err);
      }
    }

    // --- polling interval control ---
    let CAMERA_POLL_SEC = 1;
    let cameraPollTimer = null;

    function startCameraPolling() {
      if (cameraPollTimer) {
        clearInterval(cameraPollTimer);
      }
      cameraPollTimer = setInterval(fetchCameraState, CAMERA_POLL_SEC * 1000);

      const chip = document.getElementById("pollChip");
      if (chip) {
        chip.textContent = `poll ${CAMERA_POLL_SEC}s`;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Camera table DOM 생성 이후 실행
      setTimeout(() => {
        fetchCameraState();
        startCameraPolling();
      }, 200);
    });            // ← 닫는 괄호 추가
  </script>

  <!-- Connect Camera Button -->
  <script>
    (function () {
      function bindButtons() {
        // dashboard
        const btnDashboard = document.getElementById("btnDashboard");
        const m = location.pathname.match(/^\/proxy\/([^/]+)\//);
        const __PROXY_PREFIX__ = m ? "/proxy/" + encodeURIComponent(decodeURIComponent(m[1])) : "";
        if (btnDashboard) {
          btnDashboard.onclick = () => {
            const base = __PROXY_PREFIX__ || "";
            window.location.href = base + "/dashboard";
          };
        }
        // camera connect (btnCamConnect -> cameraConnectAll)
        const btnCamConnect = document.getElementById("btnCamConnect");
        if (btnCamConnect && window.OMS && window.OMS.Actions && typeof window.OMS.Actions.cameraConnectAll === "function") {
          btnCamConnect.onclick = window.OMS.Actions.cameraConnectAll;
        }
        // camera connect (btnCamStopAll -> cameraStopAll)
        const btnStopAll = document.getElementById("btnCamStopAll");
        if (btnStopAll && window.OMS && OMS.Actions.cameraStopAll) {
          btnStopAll.onclick = OMS.Actions.cameraStopAll;
        }
        // camera connect (btnCamStartAll -> cameraStartAll)
        const btnStartAll = document.getElementById("btnCamStartAll");
        if (btnStartAll && window.OMS && OMS.Actions.cameraStartAll) {
          btnStartAll.onclick = OMS.Actions.cameraStartAll;
        }
        // camera stop all (btnCamRebootAll -> cameraRebootAll)
        const btnCamRebootAll = document.getElementById("btnCamRebootAll");
        if (btnCamRebootAll && window.OMS && OMS.Actions.cameraRebootAll) {
          btnCamRebootAll.onclick = OMS.Actions.cameraRebootAll;
        }        
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", bindButtons);
      } else {
        bindButtons();
      }
    })();
  </script>

  <script>
  (function(){
    function bind(){
      // Liveview 이동
      const btnLive = document.getElementById("btnLiveview");
      if(btnLive){
        btnLive.onclick = () => {
          window.location.href = "/liveview";
        };
      }

      // Auto Focus 실행
      const btnAF = document.getElementById("btnAutoFocus");
      if (btnAF && window.OMS && OMS.Actions.autoFocus) {
        btnAF.onclick = () => OMS.Actions.autoFocus(null);   // ← PointerEvent 제거
      }
    }

    if(document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", bind);
    } else {
      bind();
    }
  })();
  </script>
</body>
</html>