<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>4DReplay V5 - Dashboard</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />  
  <!-- common title/style -->
  <script src="/web/oms-common.js"></script>
  <script>
    OMS.initAssets();             // common CSS/JS auto loading
    OMS.applyPageConfig("Dashboard");
    OMS.initActions();            // oms-actions.js auto loading
  </script>
</head>

<body>
  <h1 class="page-title-with-actions">
    <span id="pageTitle"></span>
    <div class="page-top-buttons">
      <button class="btn-top" onclick="location.href='/user'">âš™ï¸ User Config</button>
      <button id="btnFullscreen" class="btn-top icon-only" title="Toggle fullscreen">â¤¢</button>
    </div>
  </h1> 
  <div class="grid">
    <!-- System card -->
    <section class="card-dashboard-card" id="sysCard">
      <h2>
        <button id="btnSystemTitle" class="title-btn btn-system">
          <span class="title-icon">âš™ï¸</span><span class="title-text">System</span>
        </button>
        <span id="sysPoll" class="chip-poll">poll -</span>
      </h2>
      <div id="sysMessageChip" class="message-chip"></div>
      <div class="ready" id="sysReady">Ready</div>      
      <div class="stats-wrapper">
        <div class="actions">
          <button id="btnSysRestart" class="btn-neo btn-green" title="Processes Restart">
            <span class="top">Processes</span>
            <span class="bottom">Restart</span>
          </button>
          <button id="btnSysConnect" class="btn-neo btn-blue" title="Processes Connect"
            data-reconnect="/oms/system/connect/sequence">
            <span class="top">Processes</span>
            <span class="bottom">Connect</span>
          </button>
        </div>
        <div class="stats stat-merged" id="sysStats">
          <div class="stat-line">
            node : <span id="sysNodes">-</span>, total processes : <span id="sysProcs">-</span>
          </div>
          <div class="stat-line">
            connected : <span id="sysConn">0</span> / running : <span id="sysRun">0</span> / stopped : <span id="sysStop">0</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Camera card -->
    <section class="card-dashboard-card" id="camCard">
      <h2>
        <button id="btnCameraTitle" type="button" class="title-btn btn-camera">
          <span class="title-icon">ğŸ“¸</span><span class="title-text">Camera</span>
        </button>
        <span id="camPoll" class="chip-poll">poll -</span>
      </h2>
      <div id="camMessageChip" class="message-chip"></div>
      <div class="ready" id="camReady">Ready</div>      
      <div class="stats-wrapper">
        <div class="actions">
          <button id="btnCamRestart" class="btn-neo btn-green" title="Cameras Restart">
            <span class="top">Cameras</span>
            <span class="bottom">Restart</span>
          </button>
          <button id="btnCamConnect" class="btn-neo btn-blue" title="Cameras Connect">
            <span class="top">Cameras</span>
            <span class="bottom">Connect</span>
          </button>
        </div>
        <div class="stats stat-merged" id="camStats">
          <div class="stat-line">
            total cameras : <span id="camTotal">-</span>
          </div>
          <div class="stat-line">
            connected : <span id="camConn">0</span> / on : <span id="camOn">0</span> / off : <span id="camOff">0</span>
          </div>
        </div>

    </section>
  </div>
  <!-- Dashboard Style (not shared common style) -->
  <style>
    #dashProgress {
      /* gridì˜ ë³„ë„ ì•„ì´í…œìœ¼ë¡œì„œ 2ë²ˆì§¸ ì»¬ëŸ¼(=Camera) ì•„ë˜ì— ë†“ê¸° */
      grid-column: 2;
      /* ë°ìŠ¤í¬í†±(2ì—´)ì—ì„œëŠ” ì˜¤ë¥¸ìª½ ì—´ì— ìœ„ì¹˜ */
      display: flex;
      justify-content: flex-end;
      /* ìš°ì¸¡ ì •ë ¬ */
      align-items: center;
      margin-top: 10px;
      /* ì¹´ë“œì™€ ê°„ê²© */
      pointer-events: none;
      /* ì¹© ì™¸ ì˜ì—­ì€ í´ë¦­ ì•ˆ ê°€ë¡œì±„ê²Œ */
    }
    /* ê¸°ë³¸: 2ì—´ ê³ ì • */
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      /* â† auto-fit/minmax ì œê±° */
      gap: 20px;
      align-items: start;
    }
    .ready {
      background: none !important;  /* ë°°ê²½ë§Œ ì—†ì• ê¸° */
      box-shadow: none !important;  /* ê·¸ë¦¼ì ì œê±° */
      /* color ì§€ì›€: status-ready / -warn / -danger ê°€ ìƒ‰ì„ ê²°ì •í•˜ë„ë¡ */
    }
    .btn-system {
      background:#2f3b4f!important;
      color:white!important;
    }
    .btn-camera {
      background:#2f3b4f!important;
      color:white!important;
    }
    /* Dashboard message chip â†’ ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ ë°”ê¾¸ê¸° */
    .message-chip {
      background: none !important;
      border: none !important;
      box-shadow: none !important;
      color: var(--text-muted, #e1ddf5) !important;
      font-size: 11px !important;
      padding: 1px 0 !important;
      margin: 0px 0 0px 0 !important;
      cursor: default !important;
      font-style: italic !important;
    }
    /* chip ìƒ‰ìƒ í´ë˜ìŠ¤ê°€ ê¸°ì¡´ì— ë¶™ì–´ë„ ë¬´ì‹œë˜ë„ë¡ ë¦¬ì…‹ */
    .message-chip.chip,
    #sysMessageChip.chip,
    #camMessageChip.chip {
      background: none !important;
      border: none !important;
      box-shadow: none !important;
      color: var(--text-muted, #ccc) !important;
    }
    .page-title-with-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }
    .title-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #btnFullscreen.btn-secondary {
      padding: 6px 12px;
      font-size: 16px;
      line-height: 1;
    }
    /* ìƒë‹¨ ìš°ì¸¡ ë²„íŠ¼ í†µí•© ìŠ¤íƒ€ì¼ */
    .page-top-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    /* ë‘ ë²„íŠ¼ì˜ í†µì¼ëœ ìŠ¤íƒ€ì¼ */
    .btn-top {
      display: inline-flex;
      align-items: center;
      justify-content: center;

      height: 30px;                /* â† ë‘ ë²„íŠ¼ ë™ì¼ ë†’ì´ */
      padding: 0 11px;             /* â† ê°€ë¡œ íŒ¨ë”© í†µì¼ */
      border-radius: 10px;         /* â† ë™ì¼ ë¼ìš´ë“œ */
      font-size: 13px;             
      font-weight: 500;
      color: white;

      background: #2f3b4f;         /* â† ë™ì¼ ë°°ê²½ìƒ‰ */
      border: none;
      cursor: pointer;
      transition: background 0.15s;
    }
    .btn-top:hover {
      background: #3c4a61;
    }
    /* ì•„ì´ì½˜ ì „ìš© ë²„íŠ¼ë„ ë™ì¼ ë†’ì´ ìœ ì§€ */
    .btn-top.icon-only {
      width: 30px;                 /* â† ì •ì‚¬ê°í˜•ìœ¼ë¡œ */
      padding: 0;                  /* â† ë‚´ë¶€ í…ìŠ¤íŠ¸ ì—†ìœ¼ë¯€ë¡œ íŒ¨ë”© ì œê±° */
      font-size: 18px;
    }
    /* âœ… 1ì—´ ì „í™˜ ì„ê³„ê°’ì„ í•œ ë²ˆì— ê°•ì œ (ì›í•˜ëŠ” ê°’ìœ¼ë¡œ ì¡°ì ˆ) */
    @media (max-width: 740px) {

      /* â† í•„ìš”ì— ë§ê²Œ 900~1200 ì‚¬ì´ë¡œ ì¡°ì ˆ */
      .grid {
        grid-template-columns: 1fr;
        /* 1ì—´ ê³ ì • */
      }

      #dashProgress {
        grid-column: 1;
        justify-content: center;
        margin: 8px 0 0;
      }

      #dashProgress .chip {
        width: 100%;
        max-width: none;
      }
    }
    /* ì¹´ë“œ ë‚´ë¶€ ë²„íŠ¼ì„ ì„¸ë¡œë¡œ ìŒ“ê¸° (ì¢ì€ í™”ë©´ì¼ ë•Œ) */
    @media (max-width: 660px) {

      /* í†µê³„/ë²„íŠ¼ ë¸”ë¡ì„ ìœ„â†’ì•„ë˜ë¡œ */
      .stats-wrapper {
        position: static;
        /* ì„¸ë¡œ ë²„ì „ì—ì„œëŠ” ì¹´ë“œ ì•ˆì—ì„œ ìì—°ìŠ¤ëŸ½ê²Œ íë¥´ë„ë¡ */
        left: auto;
        right: auto;
        bottom: auto;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        gap: 5px;
        margin-top: 5px;  /* READY ë°”ë¡œ ì•„ë˜ë¡œ ë¶™ê²Œ */
      }

      /* ë²„íŠ¼ ì»¨í…Œì´ë„ˆ: í•œ ì¤„ì— í•˜ë‚˜ì”© */
      .actions {
        display: grid;
        grid-template-columns: 1fr;
        /* â† 1ì—´ */
        gap: 10px;
      }

      /* ë²„íŠ¼ì„ ê°€ë¡œí˜•/í’€í­ìœ¼ë¡œ */
      .btn-neo {
        width: 100%;
        /* â† í’€í­ */
        height: 72px;
        /* ì„¸ë¡œ ë†’ì´ ì¶•ì†Œ */
        border-radius: 18px;
        /* ë¼ìš´ë“œ ì™„í™” */
        flex-direction: row;
        /* í…ìŠ¤íŠ¸ë¥¼ ê°€ë¡œë¡œ ìì—°ìŠ¤ëŸ½ê²Œ */
        justify-content: center;
        gap: 10px;
      }

      .btn-neo span.top {
        /* ë³´ì¡° ë¼ë²¨ */
        font-size: 12px;
        font-weight: 800;
      }

      .btn-neo span.bottom {
        /* ë©”ì¸ ë¼ë²¨ */
        font-size: 20px;
        margin-top: 0;
      }

      /* ì„¸ë¡œë¡œ ëŠ˜ì–´ë‚˜ë©° ì¹´ë“œ í•˜ë‹¨ì´ ê°€ë ¤ì§€ì§€ ì•Šê²Œ í•˜ë‹¨ íŒ¨ë”© ë³´ê°•(í•„ìš”ì‹œ) */
      .card {
        padding-bottom: 25px;
        /* ë²„íŠ¼ 2ê°œ ì„¸ë¡œë°°ì¹˜ ë†’ì´ì— ë§ì¶° ì—¬ìœ  */
      }
    }
  </style>

  <script>

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Progress ë©”ì‹œì§€ ë™ê¸°í™”(oms-systemê³¼ ë™ì¼)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const $ = (id) => document.getElementById(id);    
    
    async function httpJson(path, init = {}) {
      const res = await fetch(path, { cache: "no-store", ...init });
      const ct = res.headers.get("content-type") || "";
      if (!res.ok) throw new Error(await res.text().catch(() => `HTTP ${res.status}`));
      return ct.includes("application/json") ? res.json() : res.text();
    }
    
    window.addEventListener("oms:summary", (ev) => {
      const s = ev.detail || {};
      const el = document.getElementById("sysSummary");
      if (!el) return;
      el.textContent =
        `nodes ${s.nodes}, processes ${s.processes}, connected ${s.connected}`;
    });

    (function () {
      const PROXY_PREFIX = window.__PROXY_PREFIX__ || "";
      const API = (p) => (p.startsWith("/") ? PROXY_PREFIX + p : p);
      const wait = (ms) => new Promise(r => setTimeout(r, ms));
      const el = {
        sysNodes: document.getElementById('sysNodes'),
        sysProcs: document.getElementById('sysProcs'),
        sysConn: document.getElementById('sysConn'),
        sysRun: document.getElementById('sysRun'),
        sysStop: document.getElementById('sysStop'),
        sysReady: document.getElementById('sysReady'),
        sysPoll: document.getElementById('sysPoll'),
        camTotal: document.getElementById('camTotal'),
        camConn: document.getElementById('camConn'),
        camOn: document.getElementById('camOn'),
        camOff: document.getElementById('camOff'),
        camReady: document.getElementById('camReady'),
        camPoll: document.getElementById('camPoll'),
        btnSysRestart: document.getElementById('btnSysRestart'),
        btnSysConnect: document.getElementById('btnSysConnect'),
        btnCamRestart: document.getElementById('btnCamRestart'),
        btnCamConnect: document.getElementById('btnCamConnect'),
      };

      window.__dashEl = el;

      // â”€â”€ freshness & last-good state (SYSTEM only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      let lastSys = null;        // {nodes, processes, connected, running, stopped, ts}
      let lastSysTs = 0;         // latest accepted timestamp (monotonic)
      let preferLSUntil = 0;     // Date.now() ê¸°ì¤€, ì´ ì‹œê° ì´ì „ê¹Œì§€ëŠ” LS(source=oms-system) ìš°ì„ 
      let sysPollTimer = 0;
      let sysPollMs = 3000;      // ê¸°ë³¸ 3s, /oms/proc-statusì˜ heartbeatë¡œ ì¡°ì •
      const pollLabel = () => `poll ${Math.round(sysPollMs / 1000)}s`;
      const nowMs = () => Date.now();


      // 200/204ë§Œ trueë¡œ, ë‚˜ë¨¸ì§€ ì–Œì „íˆ false ë°˜í™˜ (íƒìƒ‰ìš©)
      function isAbsoluteUrl(u) { try { return Boolean(new URL(u)); } catch { return false; } }
      function isHostLike(u) { return /^https?:\/\/[^/]+\/?$/.test(u) || /^[a-z0-9.-]+\/?$/i.test(u); }
      function joinPath(base, tail) {
        const b = base.endsWith("/") ? base.slice(0, -1) : base;
        const t = tail.startsWith("/") ? tail : ("/" + tail);
        return b + t;
      }

      // =========================
      // Common JSON Request Helpers
      // =========================
      async function GET_JSON(url, opts) {
        const res = await fetch(url, opts || {});
        return await res.json();
      }
      // dashboard ì—ì„œëŠ” SSE ë¥¼ ì“°ì§€ ì•Šì•„ë„ ë˜ë¯€ë¡œ no-op ìœ¼ë¡œ ë‘”ë‹¤.
      function useSseIfNeeded(_resp) {
        // intentionally empty
      }

      async function refreshSystem() {
        let s = null;
        try { s = await GET_JSON("/oms/system/state"); }
        catch(e) { console.warn("system/state failed", e); return; }
        
        applyStateStyle($("sysReady"), s.state);
        applyMessageOnly({message: s.message,messageEl: $("sysMessageChip")});
        
        // â˜… summary
        const sum = s.summary || {};
        $("sysNodes").textContent = sum.node ?? 0;
        $("sysProcs").textContent = sum.processes ?? 0;
        $("sysConn").textContent = sum.connected ?? 0;
        $("sysRun").textContent = sum.running ?? 0;
        $("sysStop").textContent = sum.stopped ?? 0;
        // poll label
        $("sysPoll").textContent = "poll 3s";  
      }

      window.__dashRefreshSystem = refreshSystem;
      window.applyMessageOnly = function ({ message, messageEl }) {
        if (messageEl) messageEl.textContent = message || "";
      };
      
      // ---- Camera stats (/oms/camera/state or local snapshot)
      async function refreshCamera() {
        let s = null;
        try { s = await GET_JSON("/oms/camera/state"); }
        catch(e) { console.warn("camera/state failed", e); return; }

        applyStateStyle($("camReady"), s.state);
        applyMessageOnly({message: s.message,messageEl: $("camMessageChip")});

        // â˜… Summary
        const sum = s.summary || {};
        $("camTotal").textContent = sum.cameras ?? 0;
        $("camConn").textContent = sum.connected ?? 0;
        $("camOn").textContent = sum.on ?? 0;
        $("camOff").textContent = sum.off ?? 0;

        $("camPoll").textContent = "poll 3s";        
      }

      try { window.addEventListener("storage", (e) => { if (e.key === "oms_camera_summary") { refreshCamera().catch(() => { }); } }); } catch { }
      try { const camCh = new BroadcastChannel("oms_camera"); camCh.onmessage = (ev) => { const s = ev.data; if (s && s.source === "oms-camera") { refreshCamera().catch(() => { }); } };      } catch { }

      ////////////////////////////////////////////////////////////////////////////
      // System Actions (same API fallbacks)      
      ////////////////////////////////////////////////////////////////////////////
      el.btnSysRestart.onclick = async () => {
        el.btnSysRestart.disabled = true;
        try {
          // 1) common action
          await OMSActionsReady();
          // 2) common restart function
          await window.OMS.Actions.sysRestart();
          // 3) update status
          if (typeof window.__dashRefreshSystem === "function") {
            await window.__dashRefreshSystem();
          }
        } catch (e) {
          alert("Restart failed: " + (e?.message || e));
        } finally {
          el.btnSysRestart.disabled = false;
        }
      };


      el.btnSysConnect.onclick = async () => {
        el.btnSysConnect.disabled = true;
        try {
          // 1) common action
          await OMSActionsReady();
          // 3) common reconnect function
          await window.OMS.Actions.sysConnect();
          // 3) update state
          if (typeof window.__dashRefreshSystem === "function") {
            await window.__dashRefreshSystem();
          }
        } catch (e) {
          alert("Connect failed: " + (e?.message || e));
        } finally {
          setTimeout(() => {
            el.btnSysConnect.disabled = false;
          }, 600);
        }
      };
      
      //////////////////////////////////////////////////////////////////////////
      // Camera Actions (bind to actual OMS.Actions methods)
      //////////////////////////////////////////////////////////////////////////
      el.btnCamRestart.onclick = async () => {
        el.btnCamRestart.disabled = true;
        try {
          // actions ë¡œë“œ ëŒ€ê¸° (System Connect ë¡œì§ ë™ì¼ ì ìš©)
          try {
            await (window.__OMS_ACTIONS_LOAD__ || Promise.resolve());
          } catch { }

          // cameraRebootAll ì‹¤í–‰ (Systemì˜ callAction ë™ì¼í•œ ë°©ì‹)
          if (window.OMS?.Actions?.cameraRebootAll) {
            await window.OMS.Actions.cameraRebootAll();
          } else {
            console.error("cameraRebootAll not found");
            alert("cameraRebootAll is not available.");
          }

        } catch (e) {
          console.error("Camera Restart failed", e);
          alert("Camera Restart failed: " + (e?.message || e));
        } finally {
          el.btnCamRestart.disabled = false;
        }
      };
      el.btnCamConnect.onclick = async () => {
        el.btnCamConnect.disabled = true;
        try {
          // actions ë¡œë“œ ëŒ€ê¸°
          try {
            await (window.__OMS_ACTIONS_LOAD__ || Promise.resolve());
          } catch { }

          // cameraConnectAll ì‹¤í–‰
          if (window.OMS?.Actions?.cameraConnectAll) {
            await window.OMS.Actions.cameraConnectAll();
          } else {
            console.error("cameraConnectAll not found");
            alert("cameraConnectAll is not available.");
          }

        } catch (e) {
          console.error("Camera Connect failed", e);
          alert("Camera Connect failed: " + (e?.message || e));
        } finally {
          setTimeout(() => {
            el.btnCamConnect.disabled = false;
          }, 1000);
        }
      };

      // initial + auto refresh
      (async function boot() {
        try { await refreshSystem(); } catch { }
        try { await refreshCamera(); } catch { }
        // SYSTEM: heartbeat ê¸°ë°˜ ì£¼ê¸°(ê¸°ë³¸ 3s). /oms/system/state ì‘ë‹µì—ì„œ ì¡°ì •ë¨.
        if (!sysPollTimer) {
          sysPollTimer = setInterval(() => { refreshSystem().catch(() => { }); }, sysPollMs);
        }
        setInterval(() => { refreshCamera().catch(() => { }); }, 1000);
      })();
    })();
  </script>

  <!-- ì „ì²´í™”ë©´ í† ê¸€ ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    (function () {
      const btn = document.getElementById('btnFullscreen');
      if (!btn) return;

      function syncIcon() {
        // â¤¢ : ì „ì²´í™”ë©´ ì§„ì… / â¤¡ : ì „ì²´í™”ë©´ í•´ì œ ëŠë‚Œ
        btn.textContent = document.fullscreenElement ? 'â¤¡' : 'â¤¢';
      }

      btn.addEventListener('click', () => {
        if (!document.fullscreenElement) {
          if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen().catch(() => { });
          }
        } else if (document.exitFullscreen) {
          document.exitFullscreen().catch(() => { });
        }
      });

      document.addEventListener('fullscreenchange', syncIcon);
      syncIcon();
    })();
  </script>

  <script>
    // ê¸°ë³¸ ë² ì´ìŠ¤ ê²½ë¡œ(í•„ìš” ì‹œ ì„œë²„ì— ë§ê²Œ ì˜¤ë²„ë¼ì´ë“œ ê°€ëŠ¥)
    window.__omsConnectBase = window.__omsConnectBase || "/oms/system/connect";
    // proxy-safe prefix (ìƒë‹¨ ë¡œë”ê°€ ì£¼ì…í•œ ê°’ ì¬ì‚¬ìš©)
    const __PX = window.__PROXY_PREFIX__ || "";
    // "/oms/connect"ì²˜ëŸ¼ ì ˆëŒ€ ê²½ë¡œë©´ í”„ë¡ì‹œ í”„ë¦¬í”½ìŠ¤ë¥¼ ë¶™ì—¬ì£¼ê³ , ì ˆëŒ€ê°€ ì•„ë‹ˆë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    const CONNECT_BASE = window.__omsConnectBase;
    const CONNECT_API = (p) => {
      const tail = p.startsWith("/") ? p : ("/" + p);
      if (CONNECT_BASE.startsWith("/")) return __PX + CONNECT_BASE + tail;
      return CONNECT_BASE + tail;
    };

    let CONN_EVT_SRC = null, CONN_STATE_POLLER = null;
    function parseSseBody(evt) {
      try {
        if (!evt?.data) return null;
        return JSON.parse(evt.data);
      } catch (e) {
        console.error("parseSseBody failed", e, evt.data);
        return null;
      }
    }
  </script>


  <!-- System / Camera ì œëª© â†’ /system, /camera ë¡œ ì´ë™ -->
  <script>
    (function () {
      const origin = location.origin;
      const sysBtn = document.getElementById('btnSystemTitle');
      const camBtn = document.getElementById('btnCameraTitle');

      if (sysBtn) {
        sysBtn.addEventListener('click', function () {
          location.href = origin + '/system';
        });
      }
      if (camBtn) {
        camBtn.addEventListener('click', function () {
          location.href = origin + '/camera';
        });
      }
    })();
  </script>

  <!-- Common Title -->
  <script>
    (function () {
      function applyCommonConfig(cfg) {
        if (!cfg || typeof cfg !== "object") return;

        // ê³µí†µ prefix (ì›í•˜ë©´ ì‚¬ìš©)
        var appName = cfg.appName || "4DReplay";
        var version = cfg.version || "V5";
        var pageCfg = (cfg.pages && cfg.pages.omsDashboard) || {};

        // 1) HTML <title>
        if (pageCfg.htmlTitle) {
          document.title = pageCfg.htmlTitle;
        } else {
          document.title = appName + " " + version + " - Dashboard";
        }

        // 2) í™”ë©´ ë‚´ H1 íƒ€ì´í‹€ + favicon ì´ë¯¸ì§€ prepend
        var h1 = document.getElementById("pageTitle");
        if (h1 && pageCfg.pageTitle) {

          // ê¸°ì¡´ í…ìŠ¤íŠ¸ ìœ ì§€
          h1.textContent = pageCfg.pageTitle;

          // ì•„ì´ì½˜ì´ ì´ë¯¸ ë¶™ì–´ ìˆìœ¼ë©´ ì¤‘ë³µ ì‚½ì… ê¸ˆì§€
          if (!h1.querySelector(".title-icon") && cfg.faviconHref) {
            var img = document.createElement("img");
            img.src = cfg.faviconHref;
            img.className = "title-icon";

            // í…ìŠ¤íŠ¸ í¬ê¸°ì— ìë™ ë§ì¶¤
            img.style.height = "1em";       // í…ìŠ¤íŠ¸ ë†’ì´ì™€ ë™ì¼
            img.style.width = "auto";       // ë¹„ìœ¨ ìœ ì§€
            img.style.verticalAlign = "-0.15em"; // í…ìŠ¤íŠ¸ baselineì— ë§ì¶”ê¸°
            img.style.marginRight = "8px";

            h1.prepend(img);
          }
        }

        // 3) favicon link êµì²´ (ë¸Œë¼ìš°ì € íƒ­ ì•„ì´ì½˜)
        if (cfg.faviconHref) {
          var existing = document.querySelector('link[rel="icon"]');
          if (!existing) {
            existing = document.createElement("link");
            existing.rel = "icon";
            existing.type = "image/x-icon";
            document.head.appendChild(existing);
          }
          existing.href = cfg.faviconHref;

          // ë§Œì•½ Titleì— ì´ë¯¸ ì•„ì´ì½˜ì´ ìˆì—ˆìœ¼ë©´ srcë„ ì—…ë°ì´íŠ¸
          var titleIcon = document.querySelector("#pageTitle .title-icon");
          if (titleIcon) {
            titleIcon.src = cfg.faviconHref;
          }
        }
      }

      function init() {
        // ì´ë¯¸ ë¡œë”©ë¼ ìˆìœ¼ë©´ ë°”ë¡œ ì ìš©
        if (window.OmsCommonConfig) {
          applyCommonConfig(window.OmsCommonConfig);
        }
        // ë‚˜ì¤‘ì— ë¡œë”©ë  ìˆ˜ë„ ìˆìœ¼ë‹ˆ ì´ë²¤íŠ¸ë„ êµ¬ë…
        try {
          window.addEventListener("oms:config-ready", function (e) {
            applyCommonConfig(e.detail || window.OmsCommonConfig || {});
          });
        } catch (e) { /* ì´ë²¤íŠ¸ ë¯¸ì§€ì› ë¸Œë¼ìš°ì €ë©´ ë¬´ì‹œ */ }
      }
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    })();
  </script>

</body>
</html>